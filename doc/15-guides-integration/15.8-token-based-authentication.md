# 15.8 基于令牌的身份验证

## 概述
基于令牌的身份验证提供无状态、可扩展的API认证机制，特别适合微服务和移动应用。

## 令牌类型详解
### 1. JWT令牌
- 包含头部、载荷和签名
- 自包含的用户信息
- 无状态验证

### 2. Opaque令牌
- 不包含用户信息
- 需要后端验证
- 更高的安全性

## 实现方案
### 1. 令牌生成
```python
# JWT令牌生成示例
import jwt
from datetime import datetime, timedelta

def generate_jwt_token(user, secret_key, expires_in=3600):
    payload = {
        "user_id": user.name,
        "exp": datetime.utcnow() + timedelta(seconds=expires_in),
        "iat": datetime.utcnow()
    }
    return jwt.encode(payload, secret_key, algorithm="HS256")
```

### 2. 令牌验证
```python
# 令牌验证中间件
from frappe.auth import validate_token

def token_auth_middleware():
    token = get_token_from_request()
    if token:
        user = validate_token(token)
        if user:
            frappe.local.user = user
            return
    
    # 未授权访问处理
    raise frappe.PermissionError
```

## 高级功能
- 令牌刷新机制
- 令牌撤销列表
- 多因素认证集成
- 审计日志记录