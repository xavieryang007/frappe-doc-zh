# 15.7 如何设置OAuth 2

## 概述
OAuth 2.0是行业标准的授权协议，用于安全地授予第三方应用访问用户资源的权限。

## OAuth 2.0流程
1. **授权请求** - 用户授权应用访问
2. **授权批准** - 用户同意授权
3. **令牌交换** - 获取访问令牌
4. **资源访问** - 使用令牌访问API

## 配置步骤
### 1. 提供商注册
- 选择OAuth 2.0提供商
- 注册应用获取客户端ID和密钥
- 配置重定向URI

### 2. Frappe配置
```python
# OAuth 2.0配置示例
from frappe.integrations.oauth2 import OAuth2

class CustomOAuth2(OAuth2):
    def __init__(self):
        self.client_id = "your_client_id"
        self.client_secret = "your_secret"
        self.authorization_url = "https://provider.com/oauth/authorize"
        self.token_url = "https://provider.com/oauth/token"
    
    def get_authorization_url(self, redirect_uri, scope=None):
        # 生成授权URL
        params = {
            "client_id": self.client_id,
            "redirect_uri": redirect_uri,
            "response_type": "code",
            "scope": scope or ""
        }
        return f"{self.authorization_url}?{urlencode(params)}"
```

### 3. 令牌管理
- 访问令牌获取和刷新
- 令牌存储安全性
- 令牌过期处理

## 安全最佳实践
- 使用PKCE（Proof Key for Code Exchange）
- 实施CSRF保护
- 验证重定向URL
- 定期审计授权