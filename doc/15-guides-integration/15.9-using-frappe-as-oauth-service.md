# 15.9 使用Frappe作为OAuth服务

## 概述
Frappe框架可以配置为OAuth 2.0服务提供商，允许第三方应用安全地访问Frappe应用的数据和功能。

## Frappe作为OAuth提供商的优势
- 统一的用户管理
- 精细的权限控制
- 完整的审计日志
- 与企业现有系统集成

## 配置步骤
### 1. 创建OAuth客户端
- 在Frappe中注册第三方应用
- 生成客户端ID和密钥
- 配置授权范围和权限

### 2. 实现OAuth端点
```python
# OAuth授权端点示例
import frappe
from frappe.integrations.oauth2 import get_oauth_server

@frappe.whitelist()
def authorize():
    """OAuth授权端点"""
    server = get_oauth_server()
    
    # 验证授权请求
    try:
        scopes, credentials = server.validate_authorization_request()
        
        # 显示授权页面
        return render_authorization_page(scopes, credentials)
        
    except errors.OAuth2Error as e:
        return handle_oauth_error(e)

@frappe.whitelist()
def token():
    """OAuth令牌端点"""
    server = get_oauth_server()
    
    try:
        # 处理令牌请求
        headers, body, status = server.create_token_response()
        return {"headers": headers, "body": body, "status": status}
        
    except errors.OAuth2Error as e:
        return handle_oauth_error(e)
```

### 3. 资源保护
```python
# 资源端点保护
from frappe.oauth2 import require_oauth

@frappe.whitelist()
@require_oauth("read:user_info")
def get_user_profile():
    """受保护的API端点"""
    user = frappe.session.user
    return {
        "name": user,
        "email": frappe.db.get_value("User", user, "email")
    }
```

## 安全配置
- 实现PKCE支持
- 配置令牌生命周期
- 设置速率限制
- 启用HTTPS强制

## 客户端集成示例
第三方应用可以使用标准的OAuth 2.0库与Frappe OAuth服务集成：

```python
# 第三方客户端示例
import requests
from requests_oauthlib import OAuth2Session

# 初始化OAuth客户端
client = OAuth2Session(
    client_id="your_client_id",
    redirect_uri="https://your-app.com/callback"
)

# 获取授权URL
authorization_url, state = client.authorization_url(
    "https://frappe-app.com/api/method/frappe.integrations.oauth2.authorize"
)

# 交换授权码获取令牌
token = client.fetch_token(
    "https://frappe-app.com/api/method/frappe.integrations.oauth2.token",
    authorization_response=redirect_response,
    client_secret="your_client_secret"
)

# 使用令牌访问API
response = client.get("https://frappe-app.com/api/method/get_user_profile")
```

## 管理功能
- OAuth客户端管理界面
- 授权会话监控
- 令牌撤销功能
- 访问审计日志

通过将Frappe配置为OAuth服务提供商，企业可以安全地对外提供API访问，同时保持对数据访问的完全控制。