# 16.4 OAuth 2

## OAuth 2

使用头 `Authorization: Bearer <access_token>` 来执行认证请求。你可以通过结合以下两个请求来接收 bearer 令牌。

> 这里有一个关于 OAuth 的精彩介绍：[OAuth 2.0 和 OpenID Connect（通俗易懂）](https://www.youtube.com/watch?v=996OiexHze0)

### GET /api/method/frappe.integrations.oauth2.authorize

获取用户的授权代码以代表其访问 ERPNext。

**参数（在查询中）：**

*   `client_id` (字符串): 你的 OAuth2 应用程序的 ID
*   `state` (字符串): 你的客户端应用程序用于在请求和回调之间维护状态的任意值。授权服务器在将用户代理重定向回客户端时包含此值。该参数应用于防止跨站请求伪造。
*   `response_type` (字符串): "code"
*   `scope` (字符串): 应授予你的应用程序的访问范围。
*   `redirect_uri` (字符串): 应用程序授权后用户将被重定向到的回调 URI。然后可以从参数中提取授权代码。
*   `code_challenge_method` (字符串): (可选) 可以是 `s256` 或 `plain`。
*   `code_challenge` (字符串): (可选) 如果 `code_challenge_method=s256` 可以是 `base64encode(sha256(random_string))`，如果 `code_challenge_method=plain` 可以是 `random_string`。参考 [RFC 7636, Appendix A](https://tools.ietf.org/html/rfc7636#appendix-A)

**示例：**

```bash
curl -X POST https://{你的 frappe 实例}/api/method/frappe.integrations.oauth2.authorize \
 --data-urlencode 'client_id=511cb2ac2d' \
 --data-urlencode 'state=444' \
 # base64encode(sha256('420')) => 21XaP8MJjpxCMRxgEzBP82sZ73PRLqkyBUta1R309J0
 # --data-urlencode 'code_verifier=21XaP8MJjpxCMRxgEzBP82sZ73PRLqkyBUta1R309J0' \
 --data-urlencode 'response_type=code'
 --data-urlencode 'scope=openid%20all' \
 --data-urlencode 'redirect_uri=https://app.getpostman.com/oauth2/callback'
```

**返回：**

*   HTTP 状态码：200
*   Content-Type: text/html

    这将打开授权页面，然后将你重定向到 `redirect_uri`。

如果用户点击'允许'，重定向 URI 将被调用，查询参数中包含授权代码：

`https://{redirect uri}?code=plkj2mqDLwaLJAgDBAkyR1W8Co08Ud&state=444`

如果用户点击'拒绝'，你将收到错误：

`https://{redirect uri}?error=access_denied`

### 令牌交换 - 授权代码授予与 ID 令牌

**POST /api/method/frappe.integrations.oauth2.get_token**

头：`Content-Type: application/x-www-form-urlencoded`

> 注意：此端点也可用于获取刷新后的访问令牌。只需在请求体中发送 `refresh_token`。

将授权代码（上面获取的）交换为访问令牌。

**参数（在请求体中）：**

*   `grant_type` (字符串): "authorization_code"
*   `code` (字符串): 在重定向 URI 中接收到的授权代码。
*   `client_id` (字符串): 你的 OAuth2 应用程序的 ID
*   `redirect_uri` (字符串): 客户端应用程序的注册重定向 URI

**示例：**

```bash
curl -X POST https://{你的 frappe 实例}/api/method/frappe.integrations.oauth2.get_token \
 -H 'Content-Type: application/x-www-form-urlencoded' \
 -H 'Accept: application/json' \
 -d 'grant_type=authorization_code&code=wa1YuQMff2ZXEAu2ZBHLpJRQXcGZdr
 &redirect_uri=https%3A%2F%2Fapp.getpostman.com%2Foauth2%2Fcallback&client_id=af615c2d3a'
```

出于测试目的，你也可以像这样在 URL 中传递参数（并在浏览器中打开）：

`https://{你的 frappe 实例}/api/method/frappe.integrations.oauth2.get_token?grant_type=authorization_code&code=A1KBRoYAN1uxrLAcdGLmvPKsRQLvzj&client_id=511cb2ac2d&redirect_uri=https%3A%2F%2Fapp.getpostman.com%2Foauth2%2Fcallback`

**返回：**

```json
{
  "access_token": "pNO2DpTMHTcFHYUXwzs74k6idQBmnI",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "cp74cxbbDgaxFuUZ8Usc7egYlhKbH1",
  "scope": "openid all",
  "id_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.XbPfbIHMI6arZ3Y922BhjWgQzWXcXNrz0ogtVhfEd2o"
}
```

### 令牌交换 - 授权代码授予与 ID 令牌 (PKCE)

**POST /api/method/frappe.integrations.oauth2.get_token**

头：`Content-Type: application/x-www-form-urlencoded`

将授权代码（上面获取的）交换为访问令牌。

**参数（在请求体中）：**

*   `grant_type` (字符串): "authorization_code"
*   `code` (字符串): 在重定向 URI 中接收到的授权代码。
*   `client_id` (字符串): 你的 OAuth2 应用程序的 ID
*   `redirect_uri` (字符串): 客户端应用程序的注册重定向 URI
*   `code_verifier` (字符串): 在授权请求期间使用的 `random_string`，带有 `code_challenge_method` 和 `code_challenge`。

Content-Type: `application/x-www-form-urlencoded`

**示例：**

```bash
curl -X POST https://{你的 frappe 实例}/api/method/frappe.integrations.oauth2.get_token \
 -H 'Content-Type: application/x-www-form-urlencoded' \
 -H 'Accept: application/json' \
 -d 'grant_type=authorization_code&code=wa1YuQMff2ZXEAu2ZBHLpJRQXcGZdr
 &redirect_uri=https%3A%2F%2Fapp.getpostman.com%2Foauth2%2Fcallback&client_id=af615c2d3a&code_verifier=420'
```

出于测试目的，你也可以像这样在 URL 中传递参数（并在浏览器中打开）：

`https://{你的 frappe 实例}/api/method/frappe.integrations.oauth2.get_token?grant_type=authorization_code&code=A1KBRoYAN1uxrLAcdGLmvPKsRQLvzj&client_id=511cb2ac2d&redirect_uri=https%3A%2F%2Fapp.getpostman.com%2Foauth2%2Fcallback&code_verifier=420`

**返回：**

```json
{
  "access_token": "pNO2DpTMHTcFHYUXwzs74k6idQBmnI",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "cp74cxbbDgaxFuUZ8Usc7egYlhKbH1",
  "scope": "openid all",
  "id_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.XbPfbIHMI6arZ3Y922BhjWgQzWXcXNrz0ogtVhfEd2o"
}
```

### 令牌撤销端点

**POST /api/method/frappe.integrations.oauth2.revoke_token**

头：`Content-Type: application/x-www-form-urlencoded`

撤销令牌端点。

**参数：**

*   `token`: 要撤销的访问令牌。

**返回：**

始终返回空响应，HTTP 状态码为 200。

```json
{}
```

### OpenID Connect ID 令牌

ID 令牌是一个 JWT。

*   `aud` 声明包含注册的 `client_id`。
*   `iss` 声明包含 Frappe 服务器 URL。
*   `sub` 声明包含 Frappe 用户的用户 ID。
*   `roles` 声明包含用户角色。
*   `exp` 声明包含过期时间。
*   `iat` 声明包含签发时间。

**示例：** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkouIERvZSIsImVtYWlsIjoiakBkb2UuY29tIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyNDIwMjIsImF1ZCI6ImNsaWVudF9pZCJ9.ZEdnrHjLbArahVTN19b4zoRFoBO5a2BakRkR82O1VU8`

使用 PyJWT 验证和提取它。

```python
import jwt

id_token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkouIERvZSIsImVtYWlsIjoiakBkb2UuY29tIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyNDIwMjIsImF1ZCI6ImNsaWVudF9pZCIsInJvbGVzIjpbIlN5c3RlbSBNYW5hZ2VyIiwiU2FsZXMgTWFuYWdlciJdLCJub25jZSI6Ijc4OTEyMyIsImlzcyI6Imh0dHBzOi8vZXJwLmV4YW1wbGUuY29tIn0.F8Wbh5dtD1loZPltJLj_sqF9DZNeBvEbo-ITtf3UPqk"

client_id = 'client_id'
client_secret = 'client_secret'

payload = jwt.decode(
    id_token,
    audience=client_id,
    key=client_secret,
    algorithm="HS256",
    options={"verify_exp": False}, # 默认启用以验证过期时间
)

print(payload)
# 输出

{'sub': '1234567890', 'name': 'J. Doe', 'email': 'j@doe.com', 'iat': 1516239022, 'exp': 1516242022, 'aud': 'client_id', 'roles': ['System Manager', 'Sales Manager'], 'nonce': '789123', 'iss': 'https://erp.example.com'}
```

### OpenID 用户信息端点

**请求**

```
GET /api/method/frappe.integrations.oauth2.openid_profile
Header: Authorization: Bearer valid_access_token
```

**响应**

```json
{
  "sub": "1234567890",
  "name": "J. Doe",
  "given_name": "J",
  "family_name": "Doe",
  "iss": "https://erp.example.com",
  "picture": "https://erp.example.com/files/jdoe.jpg",
  "email": "j@doe.com",
  "iat": 1516239022,
  "exp": 1516242022,
  "aud": "client_id",
  "roles": ["System Manager", "Sales Manager"]
}
```

### 令牌内省端点

**POST /api/method/frappe.integrations.oauth2.introspect_token**

头：`Content-Type: application/x-www-form-urlencoded`

撤销令牌端点。

**参数：**

*   `token_type_hint`: `access_token` 或 `refresh_token`，如果不提供任何内容，默认为 `access_token`
*   `token`: 要内省的访问令牌或刷新令牌。取决于 `token_type_hint`

**返回：**

```json
{
  "client_id": "511cb2ac2d",
  "trusted_client": 1,
  "active": true,
  "exp": 1619523326,
  "scope": "openid all",
  "sub": "1234567890",
  "name": "J. Doe",
  "given_name": "J",
  "family_name": "Doe",
  "iss": "https://erp.example.com",
  "picture": "https://erp.example.com/files/jdoe.jpg",
  "email": "j@doe.com",
  "iat": 1516239022,
  "exp": 1516242022,
  "aud": "511cb2ac2d",
  "roles": ["System Manager", "Sales Manager"]
}
```

或

```json
{
  "active": false,
  "_server_messages": "..."
}
```

### 进一步阅读

请查看指南 / 集成 / 如何设置 OAuth 以了解如何创建新的 OAuth 2 客户端。

*   内容类型头 (Content-Type Header)
*   授权头 (Authorization Header)
*   OAuth 2 规范 (OAuth 2 Specification)
*   Bearer 令牌 (Bearer token)

**作者：**

*   Raffael Meyer (raffael@alyf.de)
*   Revant Nandgaonkar (revant@castlecraft.in)