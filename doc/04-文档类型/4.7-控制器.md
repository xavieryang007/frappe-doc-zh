# 控制器

控制器是一个普通的 Python 类，继承自 `frappe.model.Document` 基类。该基类是 DocType 的核心逻辑。它负责处理如何从数据库加载值、如何解析这些值并保存回数据库。

当您创建一个名为 "Person" 的 DocType 时，系统会自动生成一个名为 `person.py` 的 Python 文件，其内容如下：

```python
import frappe
from frappe.model.document import Document

class Person(Document):
    pass
```

所有字段都可以作为该类的属性使用。

## 控制器方法

您可以在控制器中添加自定义方法，并通过 `doc` 对象调用。例如：

```python
# 控制器类
class Person(Document):
    def get_full_name(self):
        """返回该人员的全名"""
        return f"{self.first_name} {self.last_name}"

# 在代码中的某处
>>> doc = frappe.get_doc("Person", "000001")
>>> doc.get_full_name()
John Doe
```

## 控制器钩子

为了在文档的生命周期中添加自定义行为，我们提供了控制器钩子。

| 方法名                      | 描述                                                                 | 插入 | 保存 | 提交 | 取消 | 提交后更新 |
|-----------------------------|----------------------------------------------------------------------|:----:|:----:|:----:|:----:|:----------:|
| `before_insert`             | 在文档准备插入之前调用。                                             |  X   |      |      |      |            |
| `before_naming`             | 在设置文档的 `name` 属性之前调用。                                   |  X   |      |      |      |            |
| `autoname`                  | 如果在控制器中定义，此方法用于设置文档的 `name` 属性。              |  X   |      |      |      |            |
| `before_validate`           | 在验证之前调用，用于自动设置缺失的值。                               |  X   |  X   |  X   |      |            |
| `validate`                  | 使用此方法抛出验证错误并阻止文档保存。                               |  X   |  X   |  X   |      |            |
| `before_save`               | 在文档保存之前调用。                                                 |      |  X   |  X   |      |            |
| `before_submit`             | 在文档提交之前调用。                                                 |      |      |  X   |      |            |
| `before_cancel`             | 在文档取消之前调用。                                                 |      |      |      |  X   |            |
| `before_update_after_submit`| 在已提交的文档上更新字段时调用。                                     |      |      |      |      |     X      |
| `db_insert`                 | 此方法将文档插入数据库，除非您在处理虚拟 DocType，否则不要覆盖此方法。 |  X   |      |      |      |            |
| `after_insert`              | 在文档插入数据库后调用。                                             |  X   |      |      |      |            |
| `db_update`                 | 此方法更新数据库中的文档，除非您在处理虚拟 DocType，否则不要覆盖此方法。 |      |  X   |  X   |  X   |     X      |
| `on_update`                 | 当现有文档的值更新时调用。                                           |      |  X   |  X   |      |            |
| `on_submit`                 | 当文档提交时调用。                                                   |      |      |  X   |      |            |
| `on_cancel`                 | 当已提交的文档被取消时调用。                                         |      |      |      |  X   |            |
| `on_update_after_submit`    | 当已提交文档的值更新时调用。                                         |      |      |      |      |     X      |
| `on_change`                 | 当文档的值发生变化时调用。此方法在执行 `db_set` 时也会被调用，因此在此方法中执行的操作应是幂等的。 |  X   |  X   |  X   |  X   |     X      |

除了典型操作对应的文档事件外，您还可以挂钩到其他操作：

| 方法名          | 描述                             |
|-----------------|----------------------------------|
| `before_rename` | 在文档重命名之前调用。           |
| `after_rename`  | 在文档重命名之后调用。           |
| `on_trash`      | 在文档被删除时调用。             |
| `after_delete`  | 在文档被删除后调用。             |

要使用控制器钩子，只需定义一个同名的类方法。例如：

```python
class Person(Document):
    def validate(self):
        if self.age <= 18:
            frappe.throw("人员的年龄必须至少为18岁")

    def after_insert(self):
        frappe.sendmail(recipients=[self.email], message="感谢您的注册！")
```

如果钩子不足以满足您的需求，您还可以覆盖预定义的文档方法以添加自己的行为。例如，要覆盖 `save()` 方法：

```python
class Person(Document):
    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)  # 调用基类的 save 方法
        do_something()  # 例如：触发API调用或记录"用户X尝试更新此记录"
```

`doc` 对象默认提供了许多方法。您可以在相关文档中找到完整列表。

## 创建文档

要创建新文档并将其保存到数据库：

```python
doc = frappe.get_doc({
    'doctype': 'Person',
    'first_name': 'John',
    'last_name': 'Doe'
})
doc.insert()

doc.name  # 000001
```

## 加载文档

从数据库获取现有文档：

```python
doc = frappe.get_doc('Person', '000001')

# DocType 字段
doc.first_name  # John
doc.last_name   # Doe

# 标准字段
doc.creation    # datetime.datetime(2018, 9, 20, 12, 39, 34, 236801)
doc.owner       # john.doe@frappeframework.com
```

## 文档（Document）

文档是 DocType 的一个实例。它通常对应数据库表中的一行。我们在代码中称其为 `doc`。

### 示例

假设我们有一个 DocType "ToDo"，包含以下字段：
- `description`
- `status`
- `priority`

现在，如果我们想从数据库查询文档，可以使用 ORM：

```python
>>> doc = frappe.get_doc("ToDo", "0000001")
<todo: 0000001>

>>> doc.as_dict()
{'name': '0000001',
 'owner': 'Administrator',
 'creation': datetime.datetime(2022, 3, 28, 18, 20, 23, 275229),
 'modified': datetime.datetime(2022, 3, 28, 18, 20, 23, 275229),
 'modified_by': 'Administrator',
 'docstatus': 0,
 'idx': 0,
 'status': 'Open',
 'priority': 'Medium',
 'color': None,
 'date': None,
 'allocated_to': None,
 'description': 'Test',
 'reference_type': None,
 'reference_name': None,
 'role': None,
 'assigned_by': 'Administrator',
 'assigned_by_full_name': 'Administrator',
 'sender': None,
 'assignment_rule': None,
 'doctype': 'ToDo'}
```

您不仅获取了 `description`、`status` 和 `priority` 的值，还获得了如 `creation`、`owner` 和 `modified_by` 等字段，这些是框架在所有文档上默认添加的字段。

## 类型注解

> 自版本 15 引入。

Frappe 支持在控制器文件中自动生成 Python 类型注解。这些注解可用于自动补全、引用和控制器文件内部的类型检查。

```python
class Person(Document):
    # begin: auto-generated types
    # 此代码是自动生成的。请勿修改此块中的任何内容。

    from typing import TYPE_CHECKING

    if TYPE_CHECKING:
        from frappe.types import DF

        first_name: DF.Data
        last_name: DF.Data
        user: DF.Link
    # end: auto-generated types
    pass
```

**注意：** 这些注解在创建或更新 doctype 时生成。如果您修改了代码块，它将在下次更新时被覆盖。

您可以通过在应用程序中添加以下钩子来配置自动导出：

```python
# hooks.py
export_python_type_annotations = True
```

**了解更多关于类型注解的信息：**
- Python 官方文档 - typing
- VS Code 用户可以安装 Python 扩展以获得更好的自动补全支持 - VS Code Python 文档
- 大多数其他编辑器都有使用 LSP 的等效插件系统。