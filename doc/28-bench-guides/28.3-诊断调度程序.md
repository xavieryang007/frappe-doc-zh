# 28.3 诊断调度程序

## 概述
调度程序（Scheduler）是Frappe/ERPNext中负责执行定时任务（如计划任务、延时任务等）的核心组件。如果调度程序停止工作，会导致后台作业无法执行。

## 1. 检查调度程序状态
首先，确认调度程序服务是否正在运行。

### 命令：
```bash
# 检查调度程序工作进程状态
bench --site [site-name] scheduler status

# 检查所有后台服务状态（包括调度程序）
bench status
```

预期输出应显示 `scheduler` 状态为 `active`。

## 2. 查看调度程序日志
日志是诊断问题的首要信息来源。

### 命令：
```bash
# 查看调度程序实时日志
bench --site [site-name] scheduler logs

# 或查看工作进程日志
bench logs --worker scheduler
```

### 排查点：
- 是否有错误堆栈跟踪（Traceback）？
- 是否有任务执行失败并重试的记录？
- 是否出现数据库连接错误？

## 3. 常见问题及解决方案

### 问题1：调度程序状态为 `inactive`
- **原因**：工作进程未启动或崩溃
- **解决**：重启调度程序
  ```bash
  bench --site [site-name] scheduler restart
  # 或重启整个Bench环境
  bench restart
  ```

### 问题2：任务队列阻塞
- **原因**：某个任务执行时间过长或死循环，导致其他任务堆积
- **解决**：
  1. 检查是否有长时间运行的任务：
     ```bash
     bench --site [site-name] scheduler show-queue
     ```
  2. 如需清理队列，可尝试：
     ```bash
     bench --site [site-name] scheduler clear-failed-jobs
     ```

### 问题3：调度程序与数据库连接失败
- **原因**：数据库服务器宕机、网络问题或配置错误
- **解决**：
  1. 检查数据库服务是否运行（如MySQL/MariaDB）
  2. 验证 `site_config.json` 中的数据库连接信息是否正确

### 问题4：系统时间/时区不正确
- **原因**：服务器时间不准，导致调度任务触发时间错误
- **解决**：
  1. 使用 `date` 命令检查系统时间
  2. 设置正确的时区（如 `Asia/Shanghai`）

## 4. 手动触发调度程序（用于测试）
如果需要立即测试某个任务，可以手动触发调度程序执行待处理任务。

### 命令：
```bash
bench --site [site-name] scheduler trigger
```

## 5. 高级诊断
如果上述步骤无效，可以启用详细日志或进行深度检查。

- **启用调试日志**：
  在 `site_config.json` 中添加：
  ```json
  "logging": "bench.utils.scheduler:debug"
  ```
  然后重启服务查看详细日志

- **检查计划任务设置**：
  在Frappe Desk中访问 `计划任务` 文档列表，确认任务是否启用、下次触发时间是否合理

## 总结
诊断调度程序问题的标准流程是：**检查状态 → 查看日志 → 针对常见问题排查 → 必要时重启服务或调整配置**。如果问题持续存在，请查阅Frappe官方文档或社区论坛获取更详细的帮助。

希望本指南能帮助您快速定位并解决调度程序问题！如果需要针对具体错误信息进一步协助，请提供相关日志内容。