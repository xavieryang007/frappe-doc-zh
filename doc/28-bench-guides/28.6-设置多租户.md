# 28.6 设置多租户

## 核心概念
在Frappe中，"多租户"通过以下方式实现：
- 一个**Bench**是一个包含多个Frappe应用（Apps）的目录
- 每个独立的客户或项目在Bench中是一个**Site**
- 生产服务器使用**Nginx**作为Web服务器和反向代理，根据域名将请求路由到正确的Site
- 使用**Supervisor**来管理和监控所有Frappe进程（如Web服务器、任务队列等），确保它们持续运行

## 方法一：简易生产设置（推荐）
这是最快捷、最不容易出错的方法，适用于大多数情况

### 1. 执行自动化命令
在您的Bench目录下，运行以下命令。此命令会自动生成并配置Nginx和Supervisor的配置文件
```bash
sudo bench setup production
```
- 此命令会执行"手动设置"里的所有步骤
- 它会自动处理多站点配置，使Nginx能够根据`host`头将请求转发到相应的站点

### 2. 设置Sudoers（可选但推荐）
为了让Bench在更新应用后能自动重启相关服务（无需手动输入密码），需要设置sudoers规则
```bash
sudo bench setup sudoers $(whoami)
```
- 将`$(whoami)`替换为运行Bench命令的系统用户名（例如`frappe`）

### 3. 完成验证
命令执行成功后，您的生产环境就已配置完成。您可以通过您的域名访问不同的站点

## 方法二：手动生产设置
如果您需要更精细的控制，或者想了解底层原理，可以按照以下步骤手动配置

### 第1步：配置Supervisor（进程管理）

1. 生成Supervisor配置文件：
   ```bash
   bench setup supervisor
   ```
   这会在Bench的`config/`目录下生成`supervisor.conf`文件

2. 将配置文件链接到Supervisor的配置目录：
   ```bash
   # 对于Ubuntu/Debian系统：
   sudo ln -s $(pwd)/config/supervisor.conf /etc/supervisor/conf.d/frappe-bench.conf

   # 对于CentOS 7系统（文件扩展名需为.ini）：
   sudo ln -s $(pwd)/config/supervisor.conf /etc/supervisor/conf.d/frappe-bench.ini
   ```

3. 重新加载并启动Supervisor服务：
   ```bash
   sudo supervisorctl reread
   sudo supervisorctl update
   sudo supervisorctl status  # 检查所有进程是否正常运行
   ```

### 第2步：配置Nginx（Web服务器和代理）

1. 生成Nginx配置文件：
   ```bash
   bench setup nginx
   ```
   这会在Bench的`config/`目录下生成`nginx.conf`文件。此配置文件已包含多站点支持

2. 将配置文件链接到Nginx的配置目录：
   ```bash
   sudo ln -s $(pwd)/config/nginx.conf /etc/nginx/conf.d/frappe-bench.conf
   ```

3. **重要：处理默认配置冲突**
   - 在重启Nginx前，**必须禁用或删除**系统上可能存在的其他占用80端口的默认配置文件，否则Nginx会启动失败
   - 常见的默认配置文件路径：
     - `/etc/nginx/sites-enabled/default`
     - `/etc/nginx/conf.d/default.conf`
   - 您可以通过删除或重命名这些文件来解决冲突（例如：`sudo mv /etc/nginx/sites-enabled/default /etc/nginx/sites-enabled/default.bak`）

4. 测试Nginx配置并重启服务：
   ```bash
   sudo nginx -t  # 测试配置文件语法是否正确
   sudo systemctl reload nginx  # 或 sudo systemctl restart nginx
   ```

### 第3步：配置Sudoers（可选）
与方法一相同，运行以下命令以确保Bench有权限管理服务：
```bash
sudo bench setup sudoers <你的用户名>
```

## 关键注意事项

### 1. 官方警告
文档开头明确指出，**不建议在裸金属服务器上直接安装**。推荐的生产环境部署方式是使用Docker。您可以在[Frappe GitHub仓库](https://github.com/frappe/frappe#installation)找到基于Docker的安装说明

### 2. 域名与Hosts文件
- 在生产环境中，每个站点都应绑定一个独立的域名（例如`site1.yourcompany.com`, `site2.yourcompany.com`）
- 在DNS管理器中，将这些域名的A记录指向您的服务器IP地址
- 在本地开发测试时，您需要在`/etc/hosts`文件中模拟域名解析（例如`127.0.0.1 site1.local`）

### 3. HTTPS/SSL配置
- 生产站点必须使用HTTPS。您可以使用Let's Encrypt免费获取SSL证书
- Frappe Bench提供了便捷的命令来自动化此过程：
  ```bash
  sudo bench setup ssl <你的域名>
  ```
  或者使用更完整的指南：[使用Let's Encrypt设置HTTPS](https://docs.frappe.io/framework/user/en/bench/guides/lets-encrypt-ssl-setup)

### 4. 防火墙设置
- 确保服务器的防火墙（如`ufw`或`firewalld`）已开放80（HTTP）和443（HTTPS）端口
  ```bash
  # 例如，使用ufw
  sudo ufw allow 80
  sudo ufw allow 443
  ```

### 5. 备份与恢复
- 在生产环境中，定期备份至关重要。使用`bench backup`命令备份您的站点
- 熟悉`bench restore`命令，以便在需要时能够快速恢复站点

### 6. 从生产环境切换回开发环境
- 如果您需要停止生产服务并重新以开发模式运行，可以参考社区Wiki中的命令：[停止生产并启动开发](https://github.com/frappe/bench/wiki/Stopping-Production-and-starting-Development)。通常涉及停止Supervisor和Nginx服务，然后使用`bench start`命令

## 总结
设置Frappe多租户环境的核心就是配置**Supervisor**来管理进程，以及配置**Nginx**来代理多个站点的请求。最安全、高效的做法是直接使用`sudo bench setup production`命令。完成基础配置后，务必关注**SSL证书**、**防火墙**和**定期备份**等生产环境必备的维护工作。