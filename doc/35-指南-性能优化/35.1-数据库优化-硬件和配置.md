# 数据库优化 - 硬件和配置

## 架构与硬件建议

### 核心原则
- **分离数据库与应用服务器**：避免资源争抢，确保数据库稳定性。
- **数据库需要稳定的资源**（内存、IOPS），而应用服务器负载波动较大。

### 硬件配置推荐
| 组件 | 最低配置 | 说明 |
|------|----------|------|
| **CPU** | 2 vCPU | 负载持续超过50%时需升级。 |
| **内存** | 8 GB | 关键参数：**缓冲池（Buffer Pool）** 应占内存60%左右。 |
| **磁盘** | 50 GB（预留3倍当前数据库大小） | 优先保障高IOPS（建议2000-3000）。 |
| **扩展策略** | 垂直扩展优先（最高至64 vCPU/128 GB内存） | 超限后可配置数据库读写分离。 |

## 关键数据库配置（MariaDB/MySQL）

### 核心参数说明
| 参数 | 推荐值 | 作用 |
|------|--------|------|
| `innodb-buffer-pool-size` | 内存的60%（如4.8G对应8G内存） | **最重要的优化参数**，缓存数据页，减少磁盘I/O。 |
| `innodb-flush-log-at-trx-commit` | 1 | 保证事务持久性（勿为性能调低）。 |
| `innodb-file-per-table` | 1 | 每表独立文件，便于管理。 |
| `slow-query-log` | 1 | 记录慢查询，用于优化分析。 |
| `query-cache-type` | 0 | 禁用查询缓存（现代版本中易导致性能问题）。 |

### 完整配置文件示例（my.cnf）
```ini
[mysqld]
# 基础设置
default-storage-engine = InnoDB
innodb-buffer-pool-size = 4.8G  # 根据内存调整
innodb-flush-method = O_DIRECT
innodb-flush-log-at-trx-commit = 1
innodb-file-per-table = 1

# 连接与缓存限制
max-connections = 500
tmp-table-size = 32M
table-open-cache = 10240

# 日志记录
slow-query-log = 1
slow-query-log-file = /var/lib/mysql/mysql-slow.log
```

## 监控与指标

### 必备监控工具
- **Prometheus + Grafana**：配合以下导出器：
  - `node_exporter`：系统资源（CPU、内存、磁盘I/O）。
  - `mysqld_exporter`：数据库引擎指标。
- **Percona Toolkit**：分析慢查询日志（如 `pt-query-digest`）。

### 关键性能指标
| 指标 | 健康范围 | 异常处理 |
|------|----------|----------|
| **CPU使用率** | <50% 长期平均值 | 持续高于60%需扩容vCPU。 |
| **内存使用率** | ~90% | 过低说明缓冲池未充分利用；接近100%可能触发OOM。 |
| **缓冲池命中率** | >99% | 低于99%需扩大 `innodb-buffer-pool-size`。 |
| **磁盘I/O** | 读操作极少（缓冲池命中后） | 频繁读盘可能因缓冲池不足或查询未优化。 |
| **行锁等待** | 低 | 高等待表示并发写冲突，需优化事务或队列处理。 |

## 扩展阅读与参考
- [MariaDB InnoDB系统变量文档](https://mariadb.com/kb/en/innodb-system-variables/)
- [Percona数据库优化基础](https://www.percona.com/blog/innodb-performance-optimization-basics-updated)
- [MySQL缓冲池官方指南](https://dev.mysql.com/doc/refman/8.0/en/innodb-buffer-pool.html)

## 总结
- **硬件**：保证内存与IOPS充足，优先垂直扩展。
- **配置**：重点调整 `innodb-buffer-pool-size`，禁用查询缓存，开启慢查询日志。
- **监控**：持续跟踪缓冲池命中率、磁盘I/O、锁等待，及时扩容或优化SQL。