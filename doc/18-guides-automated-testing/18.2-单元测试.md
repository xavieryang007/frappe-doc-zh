# 18.2 单元测试

## 1. 介绍

Frappe 提供了一些基础工具来快速编写自动化测试。有一些基本规则：

1. 测试可以在仓库中的任何位置，但必须以 `test_` 开头，并且应该是 `.py` 文件
2. 测试必须在以 `test_` 开头的站点上运行。这是为了防止意外丢失数据
3. 测试存根会自动为新文档类型生成
4. Frappe 测试运行器将自动为通过链接类型字段（外键）识别的依赖文档类型构建测试记录
5. 测试可以使用 `bench run-tests` 执行
6. 对于非文档类型测试，您可以编写简单的单元测试，并在文件名前加上 `test_`

## 2. 编写文档类型测试

### 2.1 编写文档类型测试：

1. 测试用例位于名为 `test_[doctype].py` 的文件中
2. 您必须在测试文件中创建所有依赖项
3. 创建 Python 模块结构来创建夹具/依赖项

### 示例（test_event.py）：

```python
# Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors
# MIT License. See license.txt

import frappe
import frappe.defaults

from frappe.tests.utils import FrappeTestCase

def create_events():
    if frappe.flags.test_events_created:
        return

    frappe.set_user("Administrator")
    doc = frappe.get_doc({
        "doctype": "Event",
        "subject":"_Test Event 1",
        "starts_on": "2014-01-01",
        "event_type": "Public"
    }).insert()

    doc = frappe.get_doc({
        "doctype": "Event",
        "subject":"_Test Event 2",
        "starts_on": "2014-01-01",
        "event_type": "Private"
    }).insert()

    doc = frappe.get_doc({
        "doctype": "Event",
        "subject":"_Test Event 3",
        "starts_on": "2014-01-01",
        "event_type": "Public",
        "event_individuals": [{
            "person": "test1@example.com"
        }]
    }).insert()

    frappe.flags.test_events_created = True

class TestEvent(FrappeTestCase):
    def setUp(self):
        create_events()

    def tearDown(self):
        frappe.set_user("Administrator")

    def test_allowed_public(self):
        frappe.set_user("test1@example.com")
        doc = frappe.get_doc("Event", frappe.db.get_value("Event",
            {"subject":"_Test Event 1"}))
        self.assertTrue(frappe.has_permission("Event", doc=doc))

    def test_not_allowed_private(self):
        frappe.set_user("test1@example.com")
        doc = frappe.get_doc("Event", frappe.db.get_value("Event",
            {"subject":"_Test Event 2"}))
        self.assertFalse(frappe.has_permission("Event", doc=doc))

    def test_allowed_private_if_in_event_user(self):
        doc = frappe.get_doc("Event", frappe.db.get_value("Event",
            {"subject":"_Test Event 3"}))

        frappe.set_user("test1@example.com")
        self.assertTrue(frappe.has_permission("Event", doc=doc))

    def test_event_list(self):
        frappe.set_user("test1@example.com")
        res = frappe.get_list("Event", filters=[["Event", "subject", "like", "_Test Event%"]], fields=["name", "subject"])
        self.assertEqual(len(res), 2)
        subjects = [r.subject for r in res]
        self.assertTrue("_Test Event 1" in subjects)
        self.assertTrue("_Test Event 3" in subjects)
        self.assertFalse("_Test Event 2" in subjects)
```

## 2. 运行测试

此函数将构建所有测试依赖项并运行您的测试。您应该从 "frappe_bench" 文件夹运行测试。如果不带选项，将运行所有测试。

```bash
bench run-tests
```

如果您需要更多关于测试执行的信息 - 您可以使用 bench 的详细日志级别。

```bash
bench --verbose run-tests
```

### 选项：

- `--app <appname>`
- `--doctype <doctype>`
- `--test <specifictest>`
- `--module <module>` （运行具有测试的特定模块）
- `--profile` （在测试上运行 Python 分析器）
- `--junit-xml-output <pathtoxml>` （该命令以标准 XUnit XML 格式提供测试结果）

### 2.1 应用示例：

所有应用程序都位于文件夹："~/frappe-bench/apps" 中。我们可以为每个应用程序运行测试。

- `frappe-bench/apps/erpnext/`
- `frappe-bench/apps/erpnext_demo/`
- `frappe-bench/apps/frappe/`

```bash
bench run-tests --app erpnext
bench run-tests --app erpnext_demo
bench run-tests --app frappe
```

### 2.2 文档类型示例：

```bash
frappe@erpnext:~/frappe-bench$ bench run-tests --doctype "Activity Cost"
.
----------------------------------------------------------------------
Ran 1 test in 0.008s

OK
```

### 2.3 测试示例：

在 User 中运行特定用例：

```bash
frappe@erpnext:~/frappe-bench$ bench run-tests --doctype User --test test_get_value
.
----------------------------------------------------------------------
Ran 1 test in 0.005s

OK
```

### 2.4 模块示例：

如果我们想在模块中运行测试：

`/home/frappe/frappe-bench/apps/erpnext/erpnext/support/doctype/issue/test_issue.py`

我们应该使用这样的模块名称（相对于应用程序文件夹）：

`erpnext.support.doctype.issue.test_issue`

**示例：**

```bash
frappe@erpnext:~/frappe-bench$ bench run-tests --module "erpnext.stock.doctype.stock_entry.test_stock_entry"
...........................
----------------------------------------------------------------------
Ran 27 tests in 30.549s
```

### 2.5 分析示例：

```bash
frappe@erpnext:~/frappe-bench$ bench run-tests --doctype "Activity Cost" --profile
.
----------------------------------------------------------------------
Ran 1 test in 0.010s

OK
9133 function calls (8912 primitive calls) in 0.011 seconds

Ordered by: cumulative time

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    2    0.000    0.000    0.008    0.004 /home/frappe/frappe-bench/apps/frappe/frappe/model/document.py:187(insert)
    1    0.000    0.000    0.003    0.003 /home/frappe/frappe-bench/apps/frappe/frappe/model/document.py:386(_validate)
   13    0.000    0.000    0.002    0.000 /home/frappe/frappe-bench/apps/frappe/frappe/database.py:77(sql)
  255    0.000    0.000    0.002    0.000 /home/frappe/frappe-bench/apps/frappe/frappe/model/base_document.py:91(get)
   12    0.000    0.000    0.002    0.000
```

### 2.6 不创建夹具或 before_tests 钩子运行测试

- 当您构建功能时，编写测试而不构建测试依赖项（即为链接对象构建夹具）非常有用，使用 `--skip-test-records`
- 您还可以使用 `--skip-before-tests` 跳过测试初始化脚本

**示例：**

```bash
bench --site school.erpnext.local run-tests --doctype "Student Group" --skip-test-records --skip-before-tests
```

## 3.0 `FrappeTestCase`

`FrappeTestCase` 是 Frappe 框架特定的 TestCase 类，从 `unittest.TestCase` 扩展而来。在您的测试中继承此类可以确保：

1. `frappe.local.flags` 和其他最常用的本地代理在测试用例运行后重置
2. 数据库 - 在测试用例开始之前启动新的[数据库事务](https://frappeframework.com/docs/v14/user/en/api/database#database-transaction-model)，并在测试完成后回滚

**用法：**

```python
# app/doctype/dt/test_dt.py

from frappe.tests.utils import FrappeTestCase

class TestDt(FrappeTestCase):
    @classmethod
    def setUpClass(cls):
        super().setUpClass() # 扩展 TestCase 时调用 super() 方法很重要
        ...
```

## 4. 编写 XUNIT XML 测试

### 如何运行：

```bash
bench run-tests --junit-xml-output=/reports/junit_test.xml
```

### 测试报告示例：

```xml
<testsuite tests="3">
    <testcase classname="foo1" name="ASuccessfulTest"/>
    <testcase classname="foo2" name="AnotherSuccessfulTest"/>
    <testcase classname="foo3" name="AFailingTest">
        <failure type="NotEnoughFoo"> 关于失败的详细信息 </failure>
    </testcase>
</testsuite>
```

它专为 CI Jenkins 设计，但适用于任何理解 XUnit 格式 XML 测试结果表示的工具。

### Jenkins 配置支持：

1. 您应该安装 xUnit 插件 - https://wiki.jenkins-ci.org/display/JENKINS/xUnit+Plugin
2. 安装后打开 Jenkins 作业配置，单击 "后构建操作" 下的名为 "发布 JUnit 测试结果报告" 的框，并输入 XML 报告的路径：（示例：`reports/*.xml`）