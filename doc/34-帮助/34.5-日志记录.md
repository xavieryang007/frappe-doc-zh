# 34.5 日志记录 (Logging)

## 概述
Frappe框架的开发和生产环境均内置了日志记录功能，主要分为两类：**Desk日志**（存储在站点数据库中，可通过Desk界面访问）和**服务器日志**（由日志轮换系统管理的文件）。

## 1. Desk日志

### 访问方式
- 通过Desk UI（通常使用Awesomebar搜索）访问

### 用途
- 跟踪运营事件
- 也可通过API记录自定义事件

### 核心模块中的日志类型
- [访问日志](https://docs.erpnext.com/docs/user/manual/en/using-erpnext/access-log)
- 活动日志
- [错误日志](https://frappe.io/blog/development/better-error-logging-with-frappe)
- 计划任务日志

**建议**：直接访问站点查看各日志的详细信息。

## 2. 服务器日志

### 内容
- 包含较低级别的交易数据

### 日志位置（从Bench文件夹）
- `./logs`
- `./sites/{site}/logs`

### 常见日志文件
- `bench.log`：记录的Bench命令执行情况
- `scheduler.log`：调度器任务状态
- `worker.log`：后台作业状态

### 启用Frappe Web日志
在站点配置中设置 `enable_frappe_logger: true`。

## 3. 错误快照（Error Snapshots）

### 功能
- 自动捕获HTTP 500及以上错误，生成快照文件（JSON格式）
- 存储在 `./sites/{site}/error-snapshots` 目录下

### 同步
- 快照定期同步到数据库
- 可通过Desk中的"Error Snapshot"文档类型访问

### 保留时间
- 默认保留一个月

### 禁用错误快照
在站点配置中设置 `disable_error_snapshot: true`。

## 4. 日志生成进程

### 来源
- Bench CLI
- 进程管理器（如Supervisor/Procfile）
- Frappe应用

### 额外监控
- 可使用[Monitor](/framework/v14/user/en/debugging#monitoring)记录更多请求信息

## 5. 日志维护

### 注意事项
- 进程管理器生成的日志文件可能随时间增长，需定期清理

### 配置文件
- 检查 `supervisor.conf`（生产环境）或 `Procfile`（开发环境）以管理日志文件

## 6. 自动清理旧日志

### 功能
- 大多数日志文档类型支持可配置的保留期

### 配置方式
- 通过"Log Settings"文档类型设置默认日志的保留期

### 自定义日志文档类型
在Doctype控制器中添加 `clear_old_logs` 静态方法，即可在Log Settings中注册自动清理功能。

**示例代码**：
```python
class CustomLoggingDoctype(Document):
    @staticmethod
    def clear_old_logs(days=180):
        from frappe.query_builder import Interval
        from frappe.query_builder.functions import Now
        table = frappe.qb.DocType("Custom Logging Doctype")
        frappe.db.delete(table, filters=(table.modified < (Now() - Interval(days=days))))
```

## 7. 扩展资源

### Frappe应用日志
- [Frappe Logging API](/framework/v14/user/en/api/logging)

### 服务器监控日志
- [MySQL日志](https://dev.mysql.com/doc/refman/5.7/en/server-logs.html)
- [PostgreSQL日志](https://www.postgresql.org/docs/current/runtime-config-logging.html)
- [NGINX日志](https://docs.nginx.com/nginx/admin-guide/monitoring/logging/)

## 总结
Frappe的日志记录系统提供了全面的日志管理功能，包括Desk日志、服务器日志、错误快照和自动清理机制。开发者可根据需要配置日志级别、保留期限，并通过API记录自定义事件。