# 34.3 性能分析和监控 (Profiling and Monitoring)

## 概述
Frappe框架提供了强大的性能分析和监控工具，帮助开发者识别和解决性能瓶颈。

## 1. Recorder - SQL 性能分析器

Frappe Recorder是内置的剖析工具，用于捕获所有请求和后台作业，以及执行的SQL查询和对应的堆栈跟踪。

### 使用场景示例
您发现某个DocType保存时间过长，怀疑SQL查询可能是瓶颈。启动Recorder并提交文档，将获得文档保存过程中所有查询的完整捕获。

### 使用步骤
1. 以管理员身份登录，从Awesomebar打开Recorder，点击"开始"
2. 配置录制选项，开始录制
3. 执行要剖析的操作（建议在另一个标签页中）
4. 捕获足够信息后，返回Recorder停止录制

### 捕获信息
捕获的请求包含以下信息：
- **path** - 请求路径或作业名称（如 /app）
- **cmd** - 方法的点分路径（后台作业为空）
- **time** - 请求创建时间
- **duration** - 完成请求的持续时间（由于捕获开销，不具代表性）
- **number of queries** - 执行的SQL查询数量
- **Time in queries** - SQL查询花费的时间
- **Request headers** - HTTP请求头（后台作业为空）
- **Form Dict** - 表单数据（后台作业为空）
- **SQL queries** - 所有运行的SQL查询表

### 查询详情
点击查询行可展开详细信息，包括：
- 查询持续时间
- 堆栈跟踪
- 该查询的SQL EXPLAIN输出

**注意**：Recorder会增加显著的捕获开销，因此总体持续时间不具有代表性，但查询时间接近真实性能。

## 2. 导入和导出Frappe Recorder捕获

您可以导出Recorder捕获并在另一个站点上导入进行分析。

1. **导出**：转到Recorder页面，录制完成后点击菜单（三个点）> 导出
2. **导入**：在其他站点上点击导入，选择JSON文件查看捕获数据

## 3. 使用Recorder进行Python剖析

除了捕获SQL查询，Recorder还可以运行内置的Python剖析器"cProfile"，提供运行Python函数的剖析输出。录制时可启用此选项。

**注意**：启用cProfiler会显著增加录制开销，调试后应立即禁用。

## 4. 使用Bench进行函数剖析

Bench的execute命令运行方法的点分路径，并支持剖析：

```bash
bench --site [sitename] --profile execute erpnext.projects.doctype.task.task.set_tasks_as_overdue
```

您可以运行大多数可通过控制台运行的命令，包括数据库方法：

```bash
bench --site [sitename] execute frappe.db.get_database_size
```

## 5. Frappe Monitor

Monitor记录请求和作业元数据。要启用此功能，在站点配置中设置 `"monitor": 1`。

收集的数据在redis缓存中缓冲，并定期通过计划任务 `frappe.monitor.flush` 移动到日志目录中的 `monitor.json.log` 文件。

### 示例监控数据

**请求示例**：
```json
{
    "duration": 807142,
    "request": {
        "ip": "127.0.0.1",
        "method": "GET",
        "path": "/api/method/frappe.realtime.get_user_info",
        "response_length": 9687,
        "status_code": 500
    },
    "site": "frappe.local",
    "timestamp": "2020-03-05 09:37:17.397884",
    "transaction_type": "request",
    "uuid": "83be6a4c-27a1-497a-9ce6-c815bca4e420"
}
```

**作业示例**：
```json
{
    "duration": 1364,
    "job": {
        "method": "frappe.ping",
        "scheduled": false,
        "wait": 90204
    },
    "site": "frappe.local",
    "timestamp": "2020-03-05 09:37:40.124682",
    "transaction_type": "job",
    "uuid": "8225ab76-8bee-462c-b9fc-a556406b1ee7"
}
```

## 6. 后台作业监控

Frappe使用RQ（Redis Queue）异步执行长时间任务。您可以使用内置虚拟文档类型监控RQ：

### 1. RQ Worker - 监控后台工作器

RQ Worker文档类型显示所有在您的站点上消费后台作业队列的后台工作器。包含工作器基本统计信息，如名称、计时、成功和失败的作业计数以及当前状态。

### 2. RQ Job - 监控和控制后台作业

RQ Job是虚拟文档类型，提供所有后台作业的信息。您可以按队列和状态过滤作业。

## 7. 调试卡住进程

如果认为任何工作器进程卡住，可以向其发送SIGUSR1信号，它将打印所有线程的当前堆栈到stderr。

示例：`kill -SIGUSR1 <PID>`

在典型部署中，可以在日志文件中找到stderr输出：
- Web工作器 - bench/logs/web.error.log
- 后台工作器 - bench/logs/worker.error.log
- 调度器 - bench/logs/schedule.error.log

## 8. 监控服务总体健康状况

"系统健康报告"可用于快速检查系统健康状况，包括但不限于：
- 后台作业
- 调度器
- 数据库
- 缓存
- 电子邮件
- 错误日志
- 存储
- 备份
- 用户

在Awesomebar中搜索"System Health Report"查看此报告。