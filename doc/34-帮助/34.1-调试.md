# 34.1 调试 (Debugging)

## 1. 服务器端调试

### 开发环境调试
- 运行 `bench start` 命令时，所有进程（如 `redis_cache`、`web`、`worker` 等）的日志会实时显示在终端
- 在Python代码中使用 `print` 语句，日志会显示在：
  - `web` 进程（请求/响应）
  - `worker` 进程（后台任务）
- 支持在VSCode中设置断点进行调试

### 日志记录
- **日志位置**：
  - 生产环境中，日志存储在bench目录下的 `./logs` 文件夹
  - Frappe 13及以上版本，站点级日志位于 `./sites/{site}/logs`
- **日志类型**：包括应用日志（Frappe生成）和支持进程日志（如Redis、队列等）

### 控制台调试

#### Python控制台
使用 `bench --site [sitename] console` 命令启动iPython shell，可直接操作Frappe API和数据库：

```bash
bench --site [sitename] console
```

示例：
```python
frappe.get_doc('Task', 'TASK00004')
```

#### 浏览器控制台
在浏览器开发者工具中直接使用全局 `frappe` 对象调试客户端API。

## 2. 客户端调试

### 添加断点
在JavaScript代码中插入 `debugger` 语句，浏览器开发者工具会自动暂停执行：

```javascript
frappe.db.get_value('Task', 'TASK00004', 'status')
  .then(values => {
      debugger; // 断点
      console.log(values);
  });
```

## 3. VSCode调试配置（Debug Adapter Protocol）

### 配置步骤

1. **修改Procfile**：注释掉 `web: bench serve --port 8000` 行，避免与VSCode调试冲突

2. **安装VSCode Python扩展**

3. **配置launch.json**：
```json
{
    "name": "Bench",
    "type": "python",
    "request": "launch",
    "program": "${workspaceFolder}/frappe/frappe/utils/bench_helper.py",
    "args": [
        "frappe", "serve", "--port", "8000", "--noreload", "--nothreading"
    ],
    "pythonPath": "${workspaceFolder}/../env/bin/python",
    "cwd": "${workspaceFolder}/../sites",
    "env": {
        "DEV_SERVER": "1"
    }
}
```

**关键参数**：
- `--noreload`：禁用自动重载
- `--nothreading`：禁用多线程
- `DEV_SERVER=1`：确保Socket.io正常工作

4. **运行调试**：保持 `bench start` 运行，在VSCode中启动调试（⌘⇧F5）

### 注意事项
- 自动重载和多线程功能被禁用，需手动重启（⌘⇧F5）
- 路径需根据实际工作目录调整（如 `workspaceFolder` 指向apps目录）

## 关键链接
- [Frappe日志文档](https://docs.frappe.io/framework/user/en/logging)
- [Frappe日志API](https://docs.frappe.io/framework/user/en/logging-api)
- [客户端API文档](https://docs.frappe.io/framework/user/en/client-api)