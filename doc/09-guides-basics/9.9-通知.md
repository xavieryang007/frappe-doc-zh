# 9.9 通知 (Notifications)

## 概述

Notification（通知）是 Frappe 框架中用于自动化发送通知的核心文档类型（DocType），支持多种渠道，并可根据文档事件、日期、字段值变化等条件触发。

## 通用设置

- **启用（Enabled）**：激活或停用通知
- **渠道（Channel）**：选择通知发送方式，包括：
  - 邮件（Email）
  - Slack
  - 系统通知（System Notification，在 Frappe 界面内显示）
  - 短信（SMS，需提前配置 SMS 设置）
- **是否为标准（Is Standard）**：开发模式中使用，标记该通知为标准模块的一部分

## 事件触发器

通知可以根据以下事件触发：

### 1. 文档事件
- **新建（New）**：创建文档时触发
- **保存（Save）**：保存文档时触发
- **提交（Submit）**：提交文档时触发
- **取消（Cancel）**：取消文档时触发

### 2. 基于日期的事件
- **提前 N 天（Days Before）**：在指定日期字段前 N 天触发
- **延后 N 天（Days After）**：在指定日期字段后 N 天触发

### 配置说明
- **参考日期（Reference Date）**：选择要监控的日期字段
- **提前/延后天数（Days Before/After）**：设置具体天数

### 3. 基于值变化的事件
- **值变化（Value Change）**：当指定字段的值发生变化时触发
- **值变化字段（Value Changed）**：选择要监控的字段

### 4. 基于方法的事件
- **方法（Method）**：当调用特定文档方法时触发
- **触发方法（Trigger Method）**：填写方法名（如 `beforeinsert`、`afterupdate`）

### 5. 自定义事件
- **自定义（Custom）**：用于通过代码手动触发通知

## 条件触发

可通过 Python 表达式进一步限制通知触发条件：

- **条件（Condition）**：表达式必须返回 `True` 才会发送通知
- 可使用的变量和函数：
  - `doc`：触发通知的文档对象
  - `nowdate()`：当前日期
  - `frappe.utils` 中的工具函数

### 示例条件
```python
doc.status == "Open"
doc.due_date == nowdate()
doc.total > 40000
```

## 收件人配置

### 1. 邮件、系统通知、短信渠道
在"收件人"表格中配置：
- **接收者类型（Receiver Type）**：
  - **按文档字段（By Document Field）**：选择包含邮箱/手机号的字段
  - **按角色（By Role）**：选择角色，该角色下的所有用户将收到通知
  - **自定义（Custom）**：直接指定收件人
- **附加选项**：
  - 抄送/密送（CC/BCC）
  - 条件（Condition）：Python 表达式判断是否包含该收件人
  - **发送给所有分配者（Send to All Assignees）**：将通知发送给文档的所有分配用户

### 2. Slack 渠道
- 从下拉菜单中选择预定义的 Slack Webhook URL

## 消息配置

### 1. 主题（Subject）
- 适用于邮件、Slack 和系统通知
- 支持 Jinja 模板语法，例如：`{{ doc.name }} 已交付`

### 2. 消息正文（Message Body）
- **消息类型（Message Type）**：HTML、Markdown 或纯文本（仅开发模式下可用）
- **消息内容（Message）**：使用 Jinja 模板语法插入动态内容

### 3. 模板变量（Templating Variables）
- `{{ doc }}`：访问触发文档的字段，如 `{{ doc.customer }}`
- `{{ comments }}`：访问文档评论，如 `{{ comments[-1].comment }}`
- `{% if %}...{% endif %}`：条件语句
- `{{ nowdate() }}`：当前日期

### 模板示例
```html
<h3>订单逾期</h3>
<p>单据 {{ doc.name }} 已超过截止日期，请及时处理。</p>
{% if comments %}
<p>最新评论：{{ comments[-1].comment }}（由 {{ comments[-1].by }} 提交）</p>
{% endif %}
<ul>
  <li>客户：{{ doc.customer }}</li>
  <li>金额：{{ doc.grand_total }}</li>
</ul>
```

## 高级选项

### 1. 附件（Attachments）
- **附加打印件（Attach Print）**：将文档的 PDF 打印版作为附件
- **打印格式（Print Format）**：选择特定的打印格式

### 2. 通知后操作（Post-Notification Actions）
- **设置属性（Set Property After Alert）**：发送通知后更新文档的某个字段
- **要设置的值（Value To Be Set）**：为字段设置的具体值

## 最佳实践

1. **测试通知**：使用"获取今日提醒"按钮测试基于日期的通知
2. **条件精确**：避免通知泛滥，确保条件具有针对性
3. **模板清晰**：内容简洁，只包含关键信息
4. **验证收件人字段**：确保邮箱、手机号字段有效
5. **权限考虑**：收件人须有权限访问通知中引用的文档

## 故障排除

- 若通知未发送，检查文档是否满足所有条件
- 邮件通知需确认邮箱设置正确
- 短信通知需配置 SMS 设置
- Slack 通知需验证 Webhook URL 有效且活跃
- 查看服务器日志中是否有通知发送相关的错误

## 技术说明

- 通知通过异步任务处理，避免影响系统性能
- 基于日期的事件由每日定时任务检查
- 文档事件通知在动作发生时实时触发
- 条件和模板在受限环境中执行，确保安全