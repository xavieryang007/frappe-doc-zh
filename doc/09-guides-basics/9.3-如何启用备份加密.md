# 9.3 如何启用备份加密

## 概述

备份过程中生成的文件可以通过**自动生成的密钥**进行加密。只需勾选**"加密备份"**选项，数据即可保存至默认或指定位置。

## 系统要求

- **macOS**：确保系统已安装 [gnupg](https://formulae.brew.sh/formula/gnupg)。安装命令如下：
  ```bash
  brew install gnupg
  ```
- **Linux**：大多数发行版默认已安装 GnuPG（通常为 GnuPG 2.0 或更高版本）。

## 配置加密备份选项

1. 进入 **设置** 菜单，打开 **系统设置**。
2. 在 **备份** 部分勾选 **加密备份** 复选框。

### 加密工作原理
- 系统会使用 **站点配置** 中提供的自动生成密钥。
- 如果不存在密钥，**将自动生成新密钥**。
- 管理员稍后可在 `https://{站点域名}/app/backups` 页面查看密钥。
- 加密范围包括公共文件、私有文件及部分备份文件。

## 备份加密状态

- 加密备份文件存储路径与普通备份相同：`./sites/{站点名称}/private/backups`。
- 加密备份文件可从 `https://{站点域名}/app/backups` 下载。
- 加密备份文件图标带有 **钥匙标识**，便于区分。

## 获取备份加密密钥

1. 访问 `./sites/{站点名称}/private/backups` 页面。
2. 点击 **获取加密密钥** 按钮。
3. 验证密码后即可复制密钥。

**注意**：该密钥用于恢复加密的备份文件，请妥善保管。

## 恢复加密备份文件

### 默认恢复（密钥自动从站点配置读取）

如果备份是在当前站点（或站点配置中已包含正确密钥的站点）上创建的，可以直接恢复：

```bash
bench restore SQL_FILE_PATH
```

### 手动指定密钥恢复

如果自动恢复因密钥错误而失败（例如，将备份恢复到另一个新环境），则需要手动指定密钥：

#### 完整备份恢复

```bash
bench --site {站点名称} restore --backup-encryption-key {密钥} [其他选项]
```

#### 部分备份恢复

```bash
bench --site {站点名称} partial-restore --backup-encryption-key {密钥} [其他选项]
```

## 重要注意事项

1. **系统依赖**：加密备份功能依赖 GnuPG，请确保环境符合系统要求。

2. **密钥安全**：加密密钥是恢复备份的唯一凭证。一旦丢失，加密的备份文件将**无法恢复**。请务必将密钥存储在安全的地方。

3. **恢复流程**：恢复时若未指定 `--backup-encryption-key` 参数，系统会尝试从站点配置自动读取密钥；若密钥不匹配，需手动提供。

4. **文件管理**：加密备份文件与普通备份存储在同一目录，通过图标区分，避免误操作。

5. **权限要求**：只有具有 **系统管理员** 权限的用户才能访问备份页面并获取加密密钥。

6. **兼容性测试**：在不同环境之间迁移备份时，建议先进行恢复测试，确保密钥配置正确。

## 最佳实践

- **立即备份密钥**：首次启用加密后，立即获取并保存密钥。
- **定期测试恢复**：定期对加密备份进行恢复测试，确保备份文件的有效性。
- **多环境一致性**：确保开发、测试和生产环境都安装了正确版本的 GnuPG。
- **安全存储**：使用密码管理器等安全工具存储加密密钥。

## 总结

启用 Frappe 备份加密是一个简单的过程，主要通过网页界面勾选选项即可。核心挑战在于**安全管理加密密钥**以及在恢复时正确使用 `bench restore` 命令及其 `--backup-encryption-key` 参数。遵循上述步骤和注意事项，可以有效地保护您的备份数据安全。