# 9.2 Frappe Ajax调用

## 概述

`frappe.call` 是 Frappe 框架中用于与服务器端 Python 方法进行异步通信的主要 AJAX 方法。它采用异步方式发送请求，并通过回调函数处理服务器响应。

## 基本语法结构

`frappe.call` 接受一个包含多个参数的对象。其基本结构如下：

```javascript
frappe.call({
    method: "",
    type: "POST",
    args: {},
    success: function(r) {},
    error: function(r) {},
    always: function(r) {},
    btn: opts.btn,
    freeze: false,
    freeze_message: "",
    async: true,
    url: "" || frappe.request.url,
});
```

## 参数详细说明

| 参数 | 类型 | 默认值 | 描述 |
| :--- | :--- | :--- | :--- |
| **`method`** | `String` | (必填) | 指向服务器端**已白名单化**的 Python 方法的点分路径（例如：`"frappe.client.get_value"`） |
| **`type`** | `String` | `"POST"` | HTTP 请求类型。可选值：`"GET"`、`"POST"`、`"PUT"`、`"DELETE"` |
| **`args`** | `Object` | `{}` | 一个键值对对象，包含要传递给服务器端方法的参数 |
| **`success`** | `Function` | `undefined` | 当服务器成功返回响应（且无异常）时执行的回调函数。参数 `r` 包含服务器返回的数据 |
| **`error`** | `Function` | `undefined` | 当请求失败或服务器返回错误时执行的回调函数。参数 `r` 包含错误信息 |
| **`always`** | `Function` | `undefined` | 无论请求成功或失败，都会执行的回调函数 |
| **`btn`** | `Object` | `undefined` | 触发此调用的按钮对象。可用于在处理期间自动显示加载状态 |
| **`freeze`** | `Boolean` | `false` | 如果设为 `true`，则在收到服务器响应前，整个界面会显示一个加载遮罩，防止用户操作 |
| **`freeze_message`** | `String` | `""` | 当 `freeze: true` 时，显示在加载遮罩上的提示信息 |
| **`async`** | `Boolean` | `true` | 定义请求是否为异步。通常保持为 `true`（异步）。若设为 `false`，请求将变为同步，会阻塞浏览器直到收到响应 |
| **`url`** | `String` | `frappe.request.url` | 请求的目标 URL。通常无需指定，框架会自动处理 |

## 使用示例

### 示例 1：调用标准 API（`frappe.client.get_value`）

此示例演示如何从 "Item" 文档中获取特定字段的值。

```javascript
frappe.call({
    method: 'frappe.client.get_value',
    args: {
        'doctype': 'Item',
        'filters': {'name': item_code}, // 筛选条件
        'fieldname': [ // 要获取的字段列表
            'item_name',
            'web_long_description',
            'description',
            'image',
            'thumbnail'
        ]
    },
    success: function(r) {
        if (!r.exc) { // 检查是否有异常
            // 请求成功，r.message 包含服务器返回的数据
            console.log('Item Name:', r.message.item_name);
            // 在这里处理返回的数据
        }
    }
});
```

**参数说明**：
- `doctype`：目标文档类型名称
- `filters`：用于筛选文档的条件
- `fieldname`：需要返回的字段名称数组

### 示例 2：调用自定义白名单方法

此示例演示如何调用自己在服务器端编写的 Python 方法。

**客户端 JavaScript 代码：**

```javascript
frappe.call({
    method: "frappe.core.doctype.user.user.get_all_roles", // 服务器端方法的点分路径
    success: function(r) {
        if (r.message) {
            // 处理从服务器返回的角色列表
            console.log('All Roles:', r.message);
        }
    },
    error: function(r) {
        console.error('Request failed:', r.exc);
    }
});
```

**服务器端 Python 代码** (`/apps/frappe/frappe/core/doctype/user/user.py`):

```python
# 必须使用 @frappe.whitelist 装饰器将方法暴露给客户端
@frappe.whitelist()
def get_all_roles():
    # 业务逻辑
    roles = frappe.get_all("Role", pluck="name")
    return roles # 返回的值会在客户端的 r.message 中接收
```

## 最佳实践与重要提示

1. **始终使用白名单装饰器**：任何需要通过 `frappe.call` 调用的服务器端方法**必须**使用 `@frappe.whitelist()` 装饰器进行修饰，否则调用会失败。

2. **处理异常**：在 `success` 函数中，始终检查 `r.exc`（异常）或使用 `error` 回调来处理可能的失败情况，增强前端代码的健壮性。

3. **合理使用 `freeze`**：对于重要的、不希望用户中断的操作（如提交表单），设置 `freeze: true` 并提供 `freeze_message` 以改善用户体验。

4. **优先使用异步**：除非有特殊需求，否则保持 `async: true`（默认值），避免同步请求导致的浏览器界面冻结。

5. **参数传递**：使用 `args` 对象清晰、结构化地传递参数，便于维护。

6. **路径规则**：`method` 参数是 Python 模块的导入路径。例如，`frappe.core.doctype.user.user.get_all_roles` 表示 `get_all_roles` 函数位于 `frappe/core/doctype/user/user.py` 文件中。

7. **响应结构**：成功时响应数据在 `r.message` 中；错误信息在 `r.exc` 中。

## 总结

`frappe.call` 是 Frappe 框架中强大的 AJAX 调用工具，通过合理的参数配置和错误处理，可以实现与服务器端的无缝通信。掌握其使用方法和最佳实践对于开发高效的 Frappe 应用至关重要。