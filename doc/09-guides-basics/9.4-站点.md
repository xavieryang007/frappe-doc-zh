# 9.4 站点

## 概述

**站点**是 Frappe 平台中的**租户**（tenant），每个站点是一个独立的目录，位于 `sites` 目录下。Frappe 是**多租户**平台，不同站点数据完全隔离。

## 站点概念

### 什么是站点？
- Frappe 是一个多租户平台，每个租户称为一个**站点**。
- 站点是 Frappe 中的独立工作区，拥有自己的数据库、配置和文件。
- 所有站点都位于一个名为 `sites` 的目录中。
- 可以通过环境变量 `SITES_DIR` 或 `--sites_dir` 选项设置站点目录。

## 站点目录结构

### 站点根目录结构
站点目录（默认为 `sites`）包含以下内容：

| 文件/目录 | 说明 |
|-----------|------|
| **`apps.txt`** | 列出所有 Frappe 应用（Python 包），站点会加载这些应用 |
| **`common_site_config.json`** | 可选文件，存放**所有站点共享**的配置 |
| **`assets/`** | 存放前端资源（JS、CSS、图片等），由 `bench build` 自动生成 |
| **`languages.txt`** | 自动生成的语言代码映射文件 |

### 单个站点的目录结构
每个站点是一个独立的文件夹，结构如下：

```
site
├── locks/          # 用于任务调度时的文件锁
├── private/        # 需要认证访问的文件（如备份）
│   └── backups/
├── public/         # 可公开访问的静态文件
│   └── files/
│       └── testfile.txt  # 可通过 http://site/files/testfile.txt 访问
└── site_config.json      # 站点特有配置
```

**说明**：
- `public/files/` 下的文件可通过 URL 直接访问
- `private/` 目录下的文件需要认证访问
- `locks/` 目录用于调度程序通过文件锁同步任务

## 站点配置

### 配置文件说明
- **`site_config.json`**：存储站点特定的配置选项
- **`common_site_config.json`**：用于所有站点的全局配置

站点级配置存储在 `site_config.json` 中，会覆盖 `common_site_config.json` 的相同设置。

## 站点解析（Site Resolution）

Frappe 根据 HTTP 请求自动选择站点：

### 解析规则
1. 匹配 HTTP 请求的 `Host` 头
2. 匹配 HTTP 请求的 `X-Frappe-Site-Name` 头
3. 开发环境下，可通过以下命令强制指定站点：
   ```bash
   bench --site SITENAME serve
   ```

## 创建新站点

使用 Bench 命令创建新站点：

```bash
bench new-site 站点名称
```

**示例**：
```bash
bench new-site mysite
```

## 设置当前站点

要将某个站点设为默认站点，执行：

```bash
bench use 站点名称
```

**验证设置**：
检查 `sites` 目录下的 `currentsite.txt` 文件内容是否为该站点名称。

## 站点管理

### 关键管理操作

#### 1. 备份管理
- 备份文件存储在 `private/backups/` 目录下
- 需认证访问，确保数据安全

#### 2. 资源管理
- 前端资源文件位于 `assets/` 目录
- 需通过 `bench build` 编译更新

#### 3. 多站点支持
- 通过 `sites` 目录管理多个站点
- 每个站点独立运行，数据完全隔离

#### 4. 站点锁定
- `locks/` 目录用于任务调度时的文件锁机制
- 避免并发冲突，确保任务执行顺序

### 相关管理命令

- **`bench drop-site`**：删除站点
- **`bench backup`**：备份站点
- **`bench restore`**：恢复站点
- **`bench migrate`**：迁移站点数据库

## 注意事项

1. **目录权限**：确保 `sites` 目录具有正确的读写权限
2. **备份安全**：`private/backups/` 目录下的备份文件需要妥善保护
3. **资源配置**：定期运行 `bench build` 更新前端资源
4. **多站点配置**：生产环境中需要配置正确的域名映射

## 最佳实践

1. **命名规范**：使用有意义的站点名称，便于识别和管理
2. **配置管理**：合理使用 `common_site_config.json` 和 `site_config.json`
3. **备份策略**：定期备份重要站点数据
4. **资源优化**：合理管理 `assets/` 目录中的静态资源

## 总结

站点是 Frappe 框架的核心概念，实现了多租户架构。通过合理的目录结构、配置管理和命令操作，可以高效地创建、配置和管理多个独立的站点环境。掌握站点的基本概念和操作方法对于 Frappe 开发至关重要。