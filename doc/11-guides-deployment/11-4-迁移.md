# 11.4 迁移 (Migrations)

在项目的生命周期中，数据库模式经常会发生变更。有时也需要对现有数据进行修补。Frappe提供了一组工具来处理这些场景。

当您从任何Frappe应用（包括Frappe本身）拉取更新时，应运行`bench migrate`命令来应用模式更改和数据迁移（如果有的话）。

## 模式更改

您可以编辑DocType来添加、删除或更改字段。保存DocType时，包含DocType数据的JSON文件会被添加到应用的源代码树中。当您将应用添加到站点时，DocType会使用此JSON文件进行安装。要执行模式更改，需要在配置中设置`developer_mode`。

运行同步（`bench migrate`）时，系统中的doctype会从应用中的JSON文件同步到最新版本。

> **注意**：字段是软删除的，即不会从数据库表中删除列，但这些列在文档中将不可见。这样做是为了避免任何潜在的数据丢失情况，并允许您编写可能需要使用已删除字段值的相关数据迁移。

> **注意**：Frappe不支持反向模式迁移。

## 数据迁移

在引入数据相关的更改时，您可能需要运行一次性脚本来更改现有数据，以符合新代码的期望。

要向代码中添加数据迁移，您需要在一个Python模块中编写一个execute函数，并将其添加到应用的`patches.txt`中。或者，您可以使用以下命令交互式地创建新的补丁：

```bash
$ bench create-patch
```

建议在应用的补丁包（目录）中创建一个包含补丁编号和名称的文件，然后将补丁模块的点分隔路径添加到`patches.txt`中。

Frappe中遵循的目录结构如下：

```
frappe
└── patches
    └── 4_0
        └── my_awesome_patch.py
```

可以通过添加一行类似于以下内容来将补丁添加到`patches.txt`中：

```
frappe.patches.4_0.my_awesome_patch
```

在execute函数中可用的元数据（即DocType）将是应用中的JSON文件的最新版本。但是，您将无法访问系统任何先前状态的元数据。

## 一次性Python语句

您还可以使用语法`execute:{python语句}`在`patches.txt`中添加一次性Python语句。

例如：

```
execute:frappe.get_doc("User", "Guest").save()
```

> **注意**：`patches.txt`中的所有行都必须是唯一的。如果您想运行某行两次，可以通过添加不同的注释来使其唯一。

例如：

```
execute:frappe.installer.make_site_dirs() #2014-02-19
```