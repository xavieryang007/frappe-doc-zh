# 控制器 (Controllers)

## 1. 什么是控制器？

在 Frappe 框架中，**控制器（Controller）** 是一个 Python 类，继承自 `frappe.model.document.Document` 基类。每个 **DocType**（文档类型）都对应一个控制器，它负责处理该 DocType 的数据加载、验证、保存等逻辑。

例如，创建一个名为 `Person` 的 DocType 后，Frappe 会自动生成对应的控制器文件 `person.py`，基本结构如下：

```python
import frappe
from frappe.model.document import Document

class Person(Document):
    pass
```

控制器中可以直接访问 DocType 中定义的字段作为类的属性。

## 2. 控制器方法

你可以在控制器中自定义方法，并通过 `doc` 对象调用。例如：

```python
class Person(Document):
    def get_full_name(self):
        return f"{self.first_name} {self.last_name}"

# 调用示例
doc = frappe.get_doc("Person", "000001")
full_name = doc.get_full_name()  # 返回：John Doe
```

## 3. 控制器钩子（Hooks）

控制器提供了一系列**生命周期钩子**，允许你在文档的不同状态（如插入、保存、提交、取消等）插入自定义逻辑。

以下是常用的钩子方法及其说明：

| 钩子方法 | 说明 | 插入 | 保存 | 提交 | 取消 | 更新后提交 |
|----------|------|------|------|------|------|------------|
| `before_insert` | 插入前调用 | ✓ |  |  |  |  |
| `validate` | 验证数据，可阻止保存 | ✓ | ✓ | ✓ |  |  |
| `before_save` | 保存前调用 |  | ✓ |  |  |  |
| `after_insert` | 插入后调用 | ✓ |  |  |  |  |
| `on_submit` | 提交时调用 |  |  | ✓ |  |  |
| `on_cancel` | 取消时调用 |  |  |  | ✓ |  |

**示例：**

```python
class Person(Document):
    def validate(self):
        if self.age < 18:
            frappe.throw("年龄必须大于等于18岁")

    def after_insert(self):
        frappe.sendmail(recipients=[self.email], subject="欢迎", message="感谢注册！")
```

## 4. 文档对象（Document）

每个控制器实例对应数据库中的一条记录，称为**文档（Document）**，通常简写为 `doc`。

**示例：获取并操作文档**

```python
# 创建新文档
doc = frappe.get_doc({
    'doctype': 'Person',
    'first_name': 'John',
    'last_name': 'Doe'
})
doc.insert()  # 保存到数据库

# 加载现有文档
doc = frappe.get_doc('Person', '000001')
print(doc.first_name)  # 输出：John
```

## 5. 类型注解（Type Annotations，版本15+）

从 Frappe 版本 15 开始，支持自动生成 **Python 类型注解**，提高代码可读性和 IDE 支持。

```python
class Person(Document):
    # begin: auto-generated types
    from typing import TYPE_CHECKING
    if TYPE_CHECKING:
        from frappe.types import DF
        first_name: DF.Data
        last_name: DF.Data
    # end: auto-generated types
    pass
```

> 注意：注解块是自动生成的，手动修改会在下次更新时被覆盖。

## 6. 常用操作示例

### 创建文档
```python
doc = frappe.get_doc({
    'doctype': 'Person',
    'first_name': 'Jane',
    'last_name': 'Doe'
})
doc.insert()
```

### 查询并更新文档
```python
doc = frappe.get_doc('Person', '000001')
doc.last_name = 'Smith'
doc.save()
```

### 删除文档
```python
frappe.delete_doc('Person', '000001')
```

## 7. 总结

- **控制器**是 Frappe 中每个 DocType 的核心逻辑载体。
- 通过**自定义方法**和**生命周期钩子**可以灵活扩展业务逻辑。
- **文档对象**提供丰富的 API 用于 CRUD 操作。
- **类型注解**（v15+）提升开发体验。

如果需要进一步了解某个具体钩子或方法的使用，可以查阅官方文档或社区示例。