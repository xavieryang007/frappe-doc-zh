# 12.5 脚本报告

## 简介

脚本报告允许您通过服务器端脚本生成表格化报告。这类报告功能强大，但需要管理员权限才能创建和使用。

> **重要提示**：
> - 您需要具备管理员权限才能执行此操作
> - 报告脚本部分将成为应用程序代码库的一部分
> - 必须在[开发者模式](https://frappe.io/docs/v14/user/en/guides/app-development/how-enable-developer-mode-in-frappe)下操作

## 创建新报告的步骤

### 1. 设置报告属性

1. **设置报告类型**：将报告类型设置为"脚本报告"（Script Report）
2. **设置标准属性**：将"是否标准"（Is Standard）设置为"是"（Yes）
3. **选择模块**：选择要添加此报告的模块

### 2. 文件结构创建

系统会在模块文件夹中自动创建报告文件的模板。例如，在 ERPNext 的"Accounts"模块下，路径为：

```
erpnext/accounts/report/[报告名称]/
├── __init__.py
├── [报告名称].js     # 筛选条件设置
├── [报告名称].json   # 报告配置
└── [报告名称].py     # 脚本逻辑
```

## 添加筛选条件

### 在 `.js` 文件中设置筛选器

筛选器的设置方式与在 DocType 中定义 DocField 的方式相同：

```javascript
frappe.query_reports["Accounts Receivable"] = {
    "filters": [
        {
            "fieldname": "company",
            "label": __("Company"),
            "fieldtype": "Link",
            "options": "Company",
            "default": frappe.defaults.get_user_default("company")
        },
        {
            "fieldname": "from_date",
            "label": __("From Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.add_months(frappe.datetime.get_today(), -1)
        },
        {
            "fieldname": "to_date",
            "label": __("To Date"),
            "fieldtype": "Date",
            "default": frappe.datetime.get_today()
        }
    ]
}
```

### 支持的筛选器类型

- **Link**：链接到其他文档类型
- **Date**：日期选择器
- **Select**：下拉选择框
- **Data**：文本输入框
- **Check**：复选框

## 编写脚本逻辑

### 在 `.py` 文件中实现报告逻辑

脚本报告的核心是 `execute` 方法，需要返回两个列表：`columns` 和 `data`。

### 列定义（columns）

```python
columns = [
    {
        "fieldname": "account",
        "label": _("Account"),
        "fieldtype": "Link",
        "options": "Account",
        "width": 300
    },
    {
        "fieldname": "account_name",
        "label": _("Account Name"),
        "fieldtype": "Data",
        "width": 200
    },
    {
        "fieldname": "debit",
        "label": _("Debit"),
        "fieldtype": "Currency",
        "width": 120
    },
    {
        "fieldname": "credit", 
        "label": _("Credit"),
        "fieldtype": "Currency",
        "width": 120
    }
]
```

### 数据类型支持

- **Link**：链接到其他文档
- **Data**：文本数据
- **Currency**：货币金额
- **Int**：整数
- **Float**：浮点数
- **Date**：日期
- **Check**：复选框

### 数据生成示例

```python
def execute(filters=None):
    columns = get_columns()
    data = get_data(filters)
    return columns, data

def get_data(filters):
    conditions = get_conditions(filters)
    
    query = """
        SELECT 
            account,
            account_name,
            SUM(debit) as debit,
            SUM(credit) as credit
        FROM `tabGL Entry`
        WHERE docstatus = 1
            {conditions}
        GROUP BY account
        ORDER BY account
    """.format(conditions=conditions)
    
    data = frappe.db.sql(query, filters, as_dict=1)
    return data

def get_conditions(filters):
    conditions = []
    
    if filters.get("company"):
        conditions.append("company = %(company)s")
    
    if filters.get("from_date"):
        conditions.append("posting_date >= %(from_date)s")
        
    if filters.get("to_date"):
        conditions.append("posting_date <= %(to_date)s")
    
    return " AND ".join(conditions) if conditions else ""
```

## 在模块页面添加报告链接

### 配置文件设置

在模块配置文件（如 `erpnext/config/accounts.py`）中添加报告链接：

```python
def get_data():
    return [
        {
            "label": _("Accounting Statements"),
            "items": [
                {
                    "type": "report",
                    "name": "Balance Sheet",
                    "doctype": "GL Entry",
                    "is_query_report": True
                },
                {
                    "type": "report", 
                    "name": "Profit and Loss Statement",
                    "doctype": "GL Entry",
                    "is_query_report": True
                }
            ]
        },
        {
            "label": _("Custom Reports"),
            "items": [
                {
                    "type": "report",
                    "name": "My Custom Report",
                    "doctype": "Custom DocType",
                    "is_query_report": True
                }
            ]
        }
    ]
```

## 最佳实践

### 安全性考虑

1. **权限验证**：确保脚本只返回用户有权访问的数据
2. **输入验证**：对所有用户输入进行验证和清理
3. **SQL注入防护**：使用参数化查询

### 性能优化

1. **数据库查询优化**：使用适当的索引和查询优化
2. **分页处理**：对于大数据集实现分页功能
3. **缓存机制**：对常用报告数据实施缓存

### 代码质量

1. **模块化设计**：将功能拆分为独立函数
2. **错误处理**：添加适当的异常处理机制
3. **文档注释**：为关键函数添加详细的注释

### 测试验证

1. **单元测试**：为报告逻辑编写测试用例
2. **集成测试**：测试完整的报告生成流程
3. **性能测试**：验证报告在大数据量下的性能

## 参考示例

可以参考现有的标准报告作为学习资料：

- [资产负债表（Balance Sheet）](https://github.com/frappe/erpnext/blob/develop/erpnext/accounts/report/balance_sheet/balance_sheet.py)
- [损益表（Profit and Loss Statement）](https://github.com/frappe/erpnext/blob/develop/erpnext/accounts/report/profit_and_loss_statement/profit_and_loss_statement.py)

通过脚本报告，您可以创建高度定制化的业务报告，满足特定的分析需求。