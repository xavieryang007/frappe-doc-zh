# 12.3 如何制作查询报告

## 简介
您可以创建新的报表来使用复杂的 SQL 查询生成表格化报告。这些报告可以由系统管理员创建，并存储在数据库中。

> **注意：** 您需要具备系统管理员权限才能执行此操作。

## 创建查询报告的步骤

### 1. 创建新报告

1. **设置报告类型**：将报告类型设置为"查询报告（Query Report）"
2. **设置参考文档类型**：具有该文档类型访问权限的用户也将具有该报告的访问权限
3. **设置模块**：报告将出现在模块的"自定义报告"部分
4. **添加查询语句**：输入您的 SQL 查询

### 2. 设置查询语句

您可以定义复杂的查询，例如：

```sql
SELECT 
    tabProduction Order.name AS "Production Order:Link/Production Order:200",
    tabProduction Order.creation AS "Date:Date:120",
    tabProduction Order.production_item AS "Item:Link/Item:150",
    tabProduction Order.qty AS "To Produce:Int:100",
    tabProduction Order.produced_qty AS "Produced:Int:100"
FROM 
    tabProduction Order
WHERE 
    tabProduction Order.docstatus = 1
    AND ifnull(tabProduction Order.produced_qty, 0) = tabProduction Order.qty
    AND EXISTS (
        SELECT name 
        FROM tabStock Entry 
        WHERE production_order = tabProduction Order.name
    )
```

#### 列格式设置
- 要格式化列，请为每列设置标签，格式为：`[Label]:[Field Type]/[Options]:[Width]`
- 示例：`"Production Order:Link/Production Order:200"`

### 3. 检查报告

创建并保存报告后，您可以在相应模块的"自定义报告"部分查看和运行报告。

## 高级功能：添加过滤器

如果您正在制作标准报告，可以像脚本报告一样，通过在查询报告文件夹中添加一个 `.js` 文件来添加过滤器。

### 过滤器使用方法

在查询中使用 `%(filter_key)s` 占位符来代表过滤器值：

```sql
SELECT ... 
FROM ... 
WHERE item_code = %(item_code)s 
ORDER BY ...
```

### 实现步骤
1. 在查询报告文件夹中创建对应的 `.js` 文件
2. 在 SQL 查询中使用 `%(key)s` 格式的参数化占位符
3. 系统会自动将过滤器值替换到查询中

## 重要注意事项

### 标准脚本报告
如果您正在为应用程序开发标准报告，请确保将"Is Standard"设置为"Yes"。

### 权限管理
- 报告权限基于参考文档类型的权限设置
- 只有具有相应文档类型访问权限的用户才能访问报告

### 性能考虑
- 复杂的 SQL 查询可能影响系统性能
- 建议对大表添加适当的索引
- 考虑使用物化视图或定期缓存来提高查询性能

## 最佳实践

1. **查询优化**：确保查询语句高效，避免全表扫描
2. **列格式规范**：正确设置列标签和类型，确保显示效果
3. **权限管理**：合理设置参考文档类型，控制访问权限
4. **错误处理**：在查询中包含适当的错误处理逻辑

通过遵循这些步骤，您可以创建功能强大且易于维护的查询报告。