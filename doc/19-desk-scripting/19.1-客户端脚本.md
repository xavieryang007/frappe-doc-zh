# 19.1 客户端脚本

客户端脚本允许您动态定义自定义表单脚本，这些脚本在用户的浏览器中执行。与服务器脚本的限制性相比，客户端脚本中一切皆有可能。这是因为前端API在设计上是安全的，您可以使用所有JavaScript API，以及Frappe的任何其他JS或CSS库，或者您可能自定义Desk时使用的任何其他库。

> **注意**：在版本13中，"Custom Script"被重命名为"Client Script"。

## 创建客户端脚本

要创建客户端脚本：

1. **权限要求**：需要具有"System Manager"（系统管理员）角色
2. **创建步骤**：
   - 在Awesomebar中输入"New Client Script"并按回车键，创建一个新的客户端脚本文档
   - 选择您希望自定义其表单的DocType
   - 使用预设模板更新脚本并保存
   - 转到您自定义的DocType查看更改

## 重要说明

通过客户端脚本添加的验证仅在通过浏览器访问标准表单视图时应用。如果您希望这些验证也通过API或系统控制台访问应用，请使用服务器脚本。

如果您选择使用非标准工具或库，请确保在不同浏览器上进行测试，以保证在用户群体中的兼容性。

## 示例代码

### 自定义验证

在从Frappe的标准表单视图创建或更新文档时添加额外的表单验证。

```javascript
// 对任务日期进行额外验证
frappe.ui.form.on('Task', 'validate', function(frm) {
    if (frm.doc.from_date < get_today()) {
        msgprint('不能选择过去日期作为开始日期');
    }
});
```

### 字段更新时获取值

当客户字段的值更改时，获取local_tax_no。

```javascript
cur_frm.add_fetch('customer', 'local_tax_no', 'local_tax_no');
```

### 自定义字段属性

在创建文档后将ibsn字段设置为只读。

```javascript
// 保存后使字段变为只读
frappe.ui.form.on('Task', {
    refresh: function(frm) {
        frm.set_df_property('ibsn', 'read_only', !frm.is_new());
    }
});
```

### 计算字段值

在销售发票表单保存时计算激励金额。

```javascript
// 计算销售激励
frappe.ui.form.on('Sales Invoice', {
    validate: function(frm) {
        // 计算交易中每个人的激励
        total_incentive = 0
        $.each(frm.doc.sales_team, function(i, d) {
            // 计算激励百分比
            let incentive_percent = 2;
            if(frm.doc.base_grand_total > 400) incentive_percent = 4;
            // 实际激励金额
            d.incentives = flt(frm.doc.base_grand_total) * incentive_percent / 100;
            total_incentive += flt(d.incentives)
        });
        frm.doc.total_incentive = total_incentive;
    }
});
```

### 过滤邮件收件人

您可以通过客户端脚本限制可用的电子邮件地址。每个表单可以指定应选择哪些电子邮件地址。这减少了用户的认知负担，并避免向错误的收件人发送电子邮件。

CommunicationComposer（电子邮件对话框）将检查是否有客户端脚本为"recipients"、"cc"和"bcc"字段提供过滤器。

```javascript
frappe.ui.form.on("Quotation", {
    get_email_recipient_filters: function (frm, field) {
        // field 可以是 "recipients", "cc" 或 "bcc"
        if (field === "recipients") {
            return [
                [
                    "Dynamic Link",
                    "link_doctype",
                    "=",
                    frm.doc.quotation_to
                ],
                [
                    "Dynamic Link",
                    "link_name",
                    "=",
                    frm.doc.party_name
                ],
            ];
        }
    }
});
```

过滤器指向Contact DocType及其Links子表。即使有过滤器，仍然可以粘贴任意收件人。

### 设置默认邮件收件人

在标准流程中（如销售订单 -> 交货单 -> 销售发票），邮件收件人通常是预定义的。您可以通过客户端脚本设置默认邮件收件人。

CommunicationComposer（电子邮件对话框）将检查是否有客户端脚本提供默认收件人。

```javascript
frappe.ui.form.on("Quotation", {
    get_email_recipients: function (frm, field) {
        // field 可以是 "recipients", "cc" 或 "bcc"
        if (field === "bcc") {
            return [frm.doc.custom_bcc]
        }
    }
});
```

## 事件处理

客户端脚本支持多种事件处理程序，常见的事件包括：

- `validate` - 表单验证时触发
- `refresh` - 表单刷新时触发
- `before_save` - 保存前触发
- `after_save` - 保存后触发

## 配置选项

从文档中可以看出，客户端脚本的主要配置选项是通过创建"Client Script"文档来实现的，配置参数包括：

- 目标DocType
- 脚本代码内容
- 通过代码中的事件处理程序实现各种自定义功能

## 兼容性考虑

- 客户端脚本在浏览器中执行，因此可以利用浏览器提供的所有API和库
- 如果使用第三方库，需要自行测试浏览器兼容性
- 验证仅适用于通过Web界面访问的表单，对于API或其他访问方式，需要使用服务器端验证

---

**原始链接**：https://docs.frappe.io/framework/user/en/desk/scripting/client-script