# 19.3 服务器脚本

服务器脚本允许您在服务器端动态定义 Python 脚本，这些脚本可以在文档事件或 API 调用时执行。它是一种灵活的方式，用于在不修改核心代码的情况下扩展系统功能。

> **重要提示（版本15及以上）**：
> 从版本 15 开始，默认**禁用**服务器脚本以提升共享环境的安全性。
> - 如需启用，请在您的 Bench 环境中运行命令：`bench set-config -g server_script_enabled 1`
> - 如果您托管在 Frappe Cloud 上，需要创建一个私有 Bench 才能启用服务器脚本。公共共享 Bench **不允许**使用服务器脚本。

## 创建服务器脚本

### 启用功能

要启用服务器脚本，需在站点的 `site_config.json` 中设置：

```bash
bench --site <site_name> set-config server_script_enabled true
```

### 创建步骤

1. **权限要求**：您的用户角色必须是"系统管理员（System Manager）"
2. **创建文档**：
   - 在搜索栏（AwesomeBar）中输入 "New Server Script" 并回车，创建一个新的服务器脚本文档
   - 设置脚本类型（文档事件或 API）
   - 根据选择的类型，设置相应的参考文档类型、事件名称或 API 方法名称
   - 编写脚本代码并保存

## 脚本类型

### 文档事件（Document Event）

当脚本类型设置为"文档事件"时，必须指定**参考文档类型（Reference DocType）**和**事件名称（Event）**。

**支持的事件**：
- `Before Insert`（插入前）
- `After Insert`（插入后）
- `Before Validate`（验证前）
- `Before Save`（保存前）
- `After Save`（保存后）
- `Before Submit`（提交前）
- `After Submit`（提交后）
- `Before Cancel`（取消前）
- `After Cancel`（取消后）
- `Before Delete`（删除前）
- `After Delete`（删除后）
- `Before Save (Submitted Document)`（已提交文档的保存前）
- `After Save (Submitted Document)`（已提交文档的保存后）
- `Before Print`（打印前）

### API 脚本

当脚本类型设置为"API"时，可以创建动态 API 端点。

- **端点地址**：在 **API Method** 字段中设置的方法名，会自动添加前缀 `/api/method/`。例如，方法名为 `delete-note`，则完整 API 端点为 `/api/method/delete-note`
- **客户端调用**：在前端 JavaScript 中，可以使用 `frappe.call("delete-note")` 来调用此 API
- **访客访问**：勾选"允许访客（Allow Guest）"选项，即可允许未登录用户访问该 API
- **设置响应**：通过设置 `frappe.response["message"]` 对象来定义 API 的返回内容
- **速率限制**：支持基于 IP 的速率限制。勾选"启用速率限制（Enable Rate Limit）"并设置特定时间窗口内允许的调用次数

## 安全性

Frappe 框架使用 **RestrictedPython** 库来限制服务器脚本中可以访问的方法和属性，仅允许预定义的安全方法集，以防止安全风险。具体允许的方法请参考"脚本 API（Script API）"文档。

## 将服务器脚本作为库使用（版本13+）

一个服务器脚本可以被另一个脚本调用，作为内部方法库使用。

- 在**被调用的脚本（如 script_1）**中，将需要传递的值赋给 `frappe.flags`
- 在**调用脚本（如 script_2）**中，使用 `run_script('script_1')` 来获取 `frappe.flags` 中的值

## 比较变更

可以通过点击"比较版本（Compare Versions）"按钮来对比服务器脚本不同版本之间的代码差异。

## 示例代码

### 在保存前修改字段值

**脚本类型**：`Before Save`
**功能**：如果文档描述中包含 "test" 字样，则自动将状态改为 'Closed'

```python
if "test" in doc.description:
    doc.status = 'Closed'
```

### 自定义验证

**脚本类型**：`Before Save`
**功能**：如果文档描述中包含 "validate" 字样，则抛出一个验证错误，阻止保存

```python
if "validate" in doc.description:
    raise frappe.ValidationError
```

### 自动创建待办事项

**脚本类型**：`After Save`
**功能**：如果文档中指定了负责人（allocated_to），则在保存后自动创建一个关联的待办事项

```python
if doc.allocated_to:
    frappe.get_doc(dict(
        doctype='ToDo',
        owner=doc.allocated_to,
        description=doc.subject
    )).insert()
```

### 创建 API 端点

**脚本类型**：`API`
**API 方法名**：`test_method`
**功能**：访问该 API 时返回 "hello" 消息

```python
frappe.response['message'] = "hello"
```

**请求地址**：`GET/POST /api/method/test_method`

### 内部库调用示例

**脚本 1（script_1）**：设置一个标志

```python
frappe.flags.my_key = 'my value'
```

**脚本 2（script_2）**：调用 script_1 并获取其设置的值

```python
my_key = run_script('script_1').get('my_key')
```

## 配置选项

| 配置项/选项 | 描述 | 设置方式 |
| :--- | :--- | :--- |
| **`server_script_enabled`** | 总开关，启用或禁用站点上的服务器脚本功能 | Bench 命令: `bench set-config -g server_script_enabled 1` |
| **脚本类型 (Script Type)** | 定义脚本的触发方式：`文档事件 (Document Event)` 或 `API` | 在服务器脚本文档中选择 |
| **参考文档类型 (Reference DocType)** | 仅用于文档事件类型。指定脚本关联的文档类型（如 `Task`, `ToDo`） | 在服务器脚本文档中选择 |
| **事件 (Event)** | 仅用于文档事件类型。指定触发脚本的具体文档事件 | 在服务器脚本文档的下拉列表中选择 |
| **API 方法名 (API Method)** | 仅用于 API 类型。定义 API 的端点名称 | 在服务器脚本文档的字段中填写 |
| **允许访客 (Allow Guest)** | 仅用于 API 类型。控制是否允许未登录用户访问该 API | 在服务器脚本文档中勾选复选框 |
| **启用速率限制 (Enable Rate Limit)** | 仅用于 API 类型。启用基于 IP 的访问频率限制 | 在服务器脚本文档中勾选复选框并设置限制规则 |
| **用户角色 (User Role)** | 控制谁可以创建和修改服务器脚本 | 用户账户必须拥有 **System Manager** 角色 |

## 注意事项

- 仅 **System Manager** 可创建/编辑服务器脚本
- 公共共享环境（如 Frappe Cloud 的公共 bench）不支持服务器脚本
- 脚本中只能使用 Frappe 安全允许的方法（参考 Script API）

---

**原始链接**：https://docs.frappe.io/framework/user/en/desk/scripting/server-script