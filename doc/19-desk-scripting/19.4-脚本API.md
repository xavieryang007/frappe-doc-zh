# 19.4 脚本API

脚本API是Frappe框架中用于在**服务器脚本（Server Scripts）**、**打印格式（Print Formats）**和**脚本报告（Script Reports）**中执行受限操作的接口。

> **注意**：此API仅适用于应用内脚本（in-app scripting）。如果需要进行更高级的功能扩展，需要创建"应用（Application）"并在Python模块中编写事件处理程序。

## 概述

脚本API提供了一系列经过安全限制的命令集合，专门用于在受控环境中执行各种操作。这些API在设计时就考虑了安全性和稳定性，是脚本编写的基础工具集。

## Python模块

### `json`
- **描述**：Python标准模块，用于JSON数据的序列化和反序列化
- **用途**：处理JSON格式的数据交换

## 格式化相关API

### `_`（翻译函数）
- **描述**：用于国际化，标记字符串为可翻译文本
- **示例**：
```python
_("这是可翻译的文本")
```

### `frappe.format`
- **描述**：根据字段数据类型格式化值
- **示例**：
```python
frappe.format_value(value, dict(fieldtype='Currency'))
```

### `frappe.date_format`
- **描述**：使用默认日期格式格式化日期

### `frappe.format_date`
- **描述**：返回格式化的日期字符串（如"2024年9月1日"）

## 会话相关API

### `frappe.form_dict`
- **描述**：获取表单或请求参数
- **示例**：对于请求 `/page?name="test"`，可使用 `frappe.form_dict.name` 访问

### `frappe.request`
- **描述**：请求对象

### `frappe.response`
- **描述**：响应对象

### `frappe.session.user`
- **描述**：当前登录用户

### `frappe.session.csrf_token`
- **描述**：当前会话的CSRF令牌

### `frappe.user`
- **描述**：当前用户（与 `frappe.session.user` 相同）

### `frappe.get_fullname`
- **描述**：返回当前用户的完整姓名

### `frappe.get_gravatar`
- **描述**：从 `frappe.utils.get_gravatar_url` 获取用户的显示图像

### `frappe.full_name`
- **描述**：当前用户的完整姓名

## 文档操作API（ORM）

### `frappe.get_meta`
- **描述**：获取指定DocType的元数据对象

### `frappe.new_doc`
- **描述**：创建一个新的文档记录

### `frappe.get_doc`
- **描述**：获取一个文档。可以对其执行保存或文档暴露的任何方法
- **示例**：
```python
frappe.get_doc("User", frappe.session.user)
```

### `frappe.get_last_doc`
- **描述**：获取符合给定筛选条件的特定DocType的最后一个文档（默认为最后创建的）
- **示例**：
```python
frappe.get_last_doc("User", filters={"name": ("like", "%@apple.com")})
```

### `frappe.get_cached_doc`
- **描述**：获取文档（或缓存版本）

### `frappe.get_mapped_doc`
- **描述**：用于根据映射规则创建新文档

### `frappe.rename_doc`
- **描述**：重命名文档

### `frappe.delete_doc`
- **描述**：删除文档

### `frappe.get_system_settings`
- **描述**：获取系统默认设置

## 数据库操作API

### `frappe.db.get_list`
- **描述**：根据当前用户权限获取筛选后的记录列表
- **示例**：
```python
frappe.db.get_list("Customer")  # 返回客户列表
```

### `frappe.db.get_all`
- **描述**：获取所有记录的列表（忽略权限）

### `frappe.db.sql`
- **描述**：执行SELECT查询
- **示例**：
```python
frappe.db.sql("select name from Customer where name like 'm%'")
```

### `frappe.db.get_value`
- **描述**：从记录中获取特定字段的值
- **示例**：
```python
frappe.db.get_value("User", frappe.session.user, "first_name")
```

### `frappe.db.get_single_value`
- **描述**：从"单页类型"文档中获取值
- **示例**：
```python
frappe.db.get_single_value("System Settings", "default_currency")
```

### `frappe.db.get_default`
- **描述**：获取字段的默认值

### `frappe.db.escape`
- **描述**：对数据库查询中的值进行转义，防止SQL注入

### `frappe.db.set_value`
- **描述**：设置文档中某个字段的值

### `frappe.db.exists`
- **描述**：检查文档是否存在。如果存在则返回文档名称，否则返回 `None`

### `frappe.db.commit`
- **描述**：允许在服务器脚本（如自定义调度程序脚本）中显式提交数据库事务
- **重要**：在任何DocType事件服务器脚本中此方法无效

### `frappe.db.rollback`
- **描述**：允许通过服务器脚本回滚更改
- **重要**：在任何DocType事件服务器脚本中此方法无效

## 查询构建器

### `frappe.qb`
- **描述**：用于构建SELECT查询的查询构建器API
- **示例**：
```python
frappe.qb.from_("Task").select("*").run()
```

## 工具函数

### `run_script`
- **描述**：运行另一个服务器脚本（返回值在 `frappe.flags` 中）

### `frappe.msgprint`
- **描述**：在服务器端响应后显示一个模态对话框
- **示例**：
```python
frappe.msgprint("Hello")
```

### `frappe.get_hooks`
- **描述**：获取应用程序钩子（hooks）定义

### `frappe.utils`
- **描述**：访问 `frappe.utils` 模块中的方法

### `frappe.render_template`
- **描述**：渲染一个Jinja模板

### `frappe.get_url`
- **描述**：通过 `frappe.utils.get_url` 获取当前站点的URL

### `socketio_port`
- **描述**：Socket.IO端口号

### `style.border_color`
- **描述**：返回默认边框颜色 `'#d1d8dd'`

### `guess_mimetype`
- **描述**：返回 `mimetypes.guess_type` 函数

### `html2text`
- **描述**：将HTML编码为文本（Markdown格式）

### `dev_server`
- **描述**：如果处于开发者模式，则为 `True`

### `frappe.log_error`
- **描述**：生成带有追溯信息的错误日志

### `FrappeClient`
- **描述**：使用requests会话连接到另一个Frappe站点

## API（HTTP请求）

### `frappe.make_get_request`
- **描述**：发起GET请求
- **示例**：
```python
frappe.make_get_request('https://example.com')
```

### `frappe.make_post_request`
- **描述**：发起POST请求
- **示例**：
```python
frappe.make_post_request('https://example.com', data={'username': 'test'})
```

### `frappe.make_put_request`
- **描述**：发起PUT请求
- **示例**：
```python
frappe.make_put_request('https://example.com', headers={'Auth': 'Bearer xyz'})
```

## 电子邮件相关

### `frappe.sendmail`
- **描述**：发送电子邮件
- **示例**：
```python
frappe.sendmail(
    recipients=['test@example.com'], 
    sender='sender@example.com', 
    subject='我的主题', 
    message='<p>Hello</p>'
)
```
- **提示**：需要参考完整的 `sendmail` 文档以获取所有参数

## 重要说明和限制

### 安全性

Frappe框架使用**RestrictedPython**库来限制服务器脚本中可以访问的方法和属性，仅允许预定义的安全方法集，以防止安全风险。

### 适用范围

- **服务器脚本**：动态Python脚本执行
- **打印格式**：自定义文档打印格式
- **脚本报告**：动态生成的数据报告

### 事务控制限制

- `frappe.db.commit` 和 `frappe.db.rollback` 方法在DocType事件服务器脚本中无效
- 这些方法仅适用于自定义调度程序脚本等场景

### 扩展性

- 脚本API适用于快速应用内脚本编写
- 如需更强大的功能，必须创建正式的"应用（Application）"并在Python模块中编写事件处理程序

## 最佳实践

1. **了解限制**：在使用前充分了解各API的使用限制和适用场景
2. **错误处理**：合理使用异常处理机制确保脚本稳定性
3. **性能优化**：对于频繁操作，考虑使用缓存或批量处理
4. **安全考虑**：避免在脚本中处理敏感信息，确保符合安全规范

---

**原始链接**：https://docs.frappe.io/framework/user/en/desk/scripting/script-api