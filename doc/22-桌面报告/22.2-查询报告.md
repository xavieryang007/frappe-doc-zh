# 22.2 查询报告 (Query Report)

## 概述

查询报告是一种通过单个SQL查询生成的报告，查询可以简单或复杂，只要生成列和记录即可。

## 主要特性

- 通过SQL查询直接生成报告
- 仅系统管理员可以创建
- 报告存储在数据库中
- 支持列和过滤器配置（版本13+）

## 创建查询报告

### 创建步骤

1. 在智能栏中输入"新建报告"（new report）并按Enter
2. 设置报告类型为"查询报告"（Query Report）
3. 设置参考文档类型（Reference DocType）：拥有该文档类型访问权限的用户将能够访问报告
4. 设置模块（Module）：报告将出现在该模块的"自定义报告"部分
5. 编写SQL查询

### 标准报告注意事项

> 如果将"标准"（Standard）设置为"是"，并且启用了开发者模式，则会生成一个JSON文件，需要将其纳入版本控制。仅当希望将查询报告与应用程序捆绑时才需执行此操作，模块将决定JSON文件的存储位置。

## 列和过滤器配置

> 在版本13中添加

您可以在报告文档中配置列和过滤器。在这里，您可以设置列的标签、宽度、格式（字段类型）以及过滤器。

过滤器可以在查询中用作格式化变量。例如，类型为`customer`的过滤器可以在查询中用作`%(customer)s`。

## SQL查询示例

### 基础示例

```sql
SELECT
 name, creation, production_item, qty, produced_qty, company
FROM
 `tabWork Order`
WHERE
 docstatus=1
 AND ifnull(produced_qty,0) < qty
```

### 带列格式的示例（旧版样式）

如果未在报告中配置列，可以使用以下格式在查询中直接指定列格式：
```
{标签}:{可选字段类型}{可选/}{可选选项}:{可选宽度}
```

```sql
SELECT
 `tabWork Order`.name as "Work Order:Link/Work Order:200",
 `tabWork Order`.creation as "Date:Date:120",
 `tabWork Order`.production_item as "Item:Link/Item:150",
 `tabWork Order`.qty as "To Produce:Int:100",
 `tabWork Order`.produced_qty as "Produced:Int:100",
 `tabWork Order`.company as "Company:Link/Company:"
FROM
 `tabWork Order`
WHERE
 `tabWork Order`.docstatus=1
 AND ifnull(`tabWork Order`.produced_qty,0) < `tabWork Order`.qty
 AND NOT EXISTS (
   SELECT name from `tabStock Entry` 
   WHERE work_order = `tabWork Order`.name
 )
```

### 列格式说明

格式：`"标签:字段类型/选项:宽度"`

示例：`"Work Order:Link/Work Order:200"`
- `Work Order`：列标签
- `Link/Work Order`：字段类型为链接，指向Work Order文档类型
- `200`：列宽度为200px

## 完整的查询报告配置示例

### 基础工作订单状态报告

```sql
SELECT
    wo.name as "工单号:Link/Work Order:150",
    wo.creation as "创建日期:Date:120",
    wo.production_item as "产品:Link/Item:180", 
    wo.qty as "计划数量:Int:100",
    wo.produced_qty as "已生产数量:Int:100",
    wo.status as "状态:Data:100",
    wo.company as "公司:Link/Company:120"
FROM
    `tabWork Order` wo
WHERE
    wo.docstatus = 1
    AND wo.status = 'In Progress'
    AND ifnull(wo.produced_qty, 0) < wo.qty
ORDER BY
    wo.creation DESC
```

### 带过滤器的销售订单报告

```sql
SELECT
    so.name as "订单号:Link/Sales Order:150",
    so.customer as "客户:Link/Customer:180",
    so.transaction_date as "订单日期:Date:120",
    so.grand_total as "总金额:Currency:120",
    so.status as "状态:Data:100",
    cust.customer_name as "客户名称:Data:200"
FROM
    `tabSales Order` so
LEFT JOIN
    `tabCustomer` cust ON so.customer = cust.name
WHERE
    so.docstatus = 1
    AND so.transaction_date >= %(from_date)s
    AND so.transaction_date <= %(to_date)s
    %(customer)s
ORDER BY
    so.transaction_date DESC
```

## 过滤器配置示例

在查询中使用过滤器变量：

```sql
-- 在查询中使用过滤器变量
SELECT 
    name, customer, transaction_date, grand_total
FROM 
    `tabSales Order`
WHERE 
    docstatus = 1
    AND transaction_date >= %(start_date)s
    AND transaction_date <= %(end_date)s
    AND customer = %(customer)s
```

## 权限和访问控制

### 参考文档类型权限
- 查询报告通过"参考文档类型"来控制访问权限
- 只有拥有该文档类型访问权限的用户才能查看报告

### 模块归属
- 设置模块后，报告将归类到指定模块的"自定义报告"部分
- 有助于组织和管理报告

## 最佳实践

### 1. 查询性能优化
- 避免使用`SELECT *`，明确指定所需字段
- 合理使用索引
- 对大表使用分页查询

### 2. 安全性考虑
- 使用参数化查询防止SQL注入
- 合理设置访问权限
- 避免暴露敏感数据

### 3. 版本控制
- 对于标准报告，确保JSON文件纳入版本控制
- 记录查询变更历史

### 4. 测试和验证
- 在生产环境部署前充分测试
- 验证查询结果的准确性
- 检查权限设置是否正确

## 版本兼容性

### 版本13及以后
- 支持新的列和过滤器配置方式
- 提供更灵活的配置选项
- 建议使用新版配置方式

### 版本12及以前
- 需要使用列名格式化语法
- 配置选项相对有限

## 常见问题

### Q: 查询报告和脚本报告有什么区别？
A: 查询报告使用SQL查询生成报告，适合相对简单的需求；脚本报告使用Python脚本，适合更复杂的业务逻辑。

### Q: 如何控制报告的访问权限？
A: 通过设置"参考文档类型"来控制，只有拥有该文档类型权限的用户才能访问报告。

### Q: 查询报告支持图表吗？
A: 查询报告本身不直接支持图表，但可以通过脚本报告或自定义开发来实现图表功能。

### Q: 如何处理大量数据的查询性能？
A: 建议使用分页查询、合理设置索引，并考虑使用缓存机制。

## 进阶用法

### 动态过滤
通过在查询中使用过滤器变量，实现动态过滤功能：

```sql
SELECT 
    name, customer, amount
FROM 
    `tabSales Invoice`
WHERE 
    docstatus = 1
    AND posting_date BETWEEN %(from_date)s AND %(to_date)s
    AND IF(%(customer)s != '', customer = %(customer)s, 1=1)
```

### 聚合查询
使用聚合函数生成统计报告：

```sql
SELECT
    YEAR(posting_date) as "年份:Int:80",
    MONTH(posting_date) as "月份:Int:80", 
    COUNT(*) as "订单数量:Int:100",
    SUM(grand_total) as "总金额:Currency:120"
FROM
    `tabSales Invoice`
WHERE
    docstatus = 1
    AND posting_date >= %(from_date)s
    AND posting_date <= %(to_date)s
GROUP BY
    YEAR(posting_date), MONTH(posting_date)
ORDER BY
    YEAR(posting_date) DESC, MONTH(posting_date) DESC
```

## 总结

查询报告是Frappe框架中一种简单而强大的报告工具，特别适合基于SQL查询的报表需求。通过合理的配置和使用，可以快速构建出满足业务需求的报表系统。