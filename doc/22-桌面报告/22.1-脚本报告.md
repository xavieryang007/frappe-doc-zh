# 22.1 脚本报告 (Script Report)

## 概述

脚本报告是Frappe框架中一种强大的报告类型，用于实现报告构建器或查询报告无法满足的复杂需求。

## 主要特性

- 使用Python脚本编写，提供完全灵活性
- 仅限管理员创建（需启用开发者模式）
- 通常作为应用程序的一部分在开发过程中编写

## 创建脚本报告

### 前置条件
要创建脚本报告，您必须启用开发者模式。

### 创建步骤

1. 在智能栏中输入"new report"并按Enter
2. 将报告类型设置为"脚本报告"
3. 将"是否标准"设置为"是"
4. 选择您要添加此报告的模块
5. 在模块文件夹中（例如，如果在ERPNext中是"会计"模块，则文件夹将为`erpnext/accounts/report/[report-name]`），您将看到报告文件的模板被创建
6. 在生成的`{report-name}.py`文件中编写您的Python脚本
7. 您可以通过在`{report-name}.js`文件中添加它们来为报告添加过滤器

## 标准和自定义报告

> 在版本12中添加

从版本12开始，您可以在Frappe框架中创建自定义查询和脚本报告。在自定义报告中，脚本可以直接在报告本身中添加，并且您可以使用Frappe框架的脚本API函数。

## 列和过滤器

> 在版本13中添加

您可以在报告文档中配置列和过滤器。在这里，您可以设置列的标签、宽度、格式（字段类型）以及过滤器。

过滤器可以在查询中用作格式化变量。例如，类型为`customer`的过滤器可以在查询中用作`%(customer)s`。

## 编写脚本

### 自定义报告

在自定义报告中，您可以使用脚本API并将脚本直接写在"代码"部分。

**代码示例：**
```python
return frappe.db.get_all('User', ['first_name', 'last_name'], filters=filters)
```

### 标准报告

生成的`.py`文件附带了一个报告模板。有一个名为`execute`的方法，它接收过滤器参数并返回列和数据。您可以使用任何Python模块和SQL查询的组合来生成报告。

`execute`函数如下所示：

**代码示例：**
```python
from __future__ import unicode_literals
# import frappe

def execute(filters=None):
    columns, data = [], []
    return columns, data
```

默认情况下，`execute`函数应返回要在报告中显示的列和数据。开发人员可以选择性地返回一些参数，例如`message`、`chart`、`report_summary`、`skip_total_rows`。

## Execute函数返回值详解

### `columns`

这是一个字典列表。它按顺序保存了要在数据表中显示的所有列。

**注意：** 如果您尚未在报告中指定列，则只需要返回`columns`。

**示例：**
```python
columns = [
    {
        'fieldname': 'account',
        'label': _('Account'),
        'fieldtype': 'Link',
        'options': 'Account'
    },
    {
        'fieldname': 'currency',
        'label': _('Currency'),
        'fieldtype': 'Link',
        'options': 'Currency'
    },
    {
        'fieldname': 'balance',
        'label': _('Balance'),
        'fieldtype': 'Currency',
        'options': 'currency'
    }
]
```

### `data`

这可以是一个列表的列表或一个字典列表。它保存了要在报告中显示的数据。

**示例：**
```python
data = [
    {
        'account': 'Application of Funds (Assets)',
        'currency': 'INR',
        'balance': '15182212.738'
    },
    {
        'account': 'Current Assets - GTPL',
        'currency': 'INR',
        'balance': '17117932.738'
    },
    # ... 更多数据项
]
```

### `chart`

包含要在报告中显示的默认图表的配置。

### `report_summary`

这是一个字典列表，用于存储报告中的重要值，并在UI的顶部单独显示。

**示例：**
```python
[{
    "value": profit,
    "indicator": "Green" if profit > 0 else "Red",
    "label": _("Total Profit This Year"),
    "datatype": "Currency",
    "currency": "INR"
}]
```

> **注意：** 这些参数应按以下特定顺序返回：
> `return columns, data, message, chart_data, report_summary`

## 添加过滤器

要在报告中添加过滤器，请在`{report-name}.js`文件中定义字段及其字段类型。过滤器值将在`execute`方法中作为一个字典（dict）可用。

**代码示例：**
```javascript
frappe.query_reports['Balance Sheet'] = {
    filters: [
        {
            fieldname: 'company',
            label: __('Company'),
            fieldtype: 'Link',
            options: 'Company',
            default: frappe.defaults.get_user_default('company')
        },
        {
            fieldname: 'periodicity',
            label: __('Periodicity'),
            fieldtype: 'Select',
            options: [
                'Monthly',
                'Quarterly',
                'Half-Yearly',
                'Yearly'
            ],
            default: 'Yearly',
            depends_on: 'eval:doc.company=="Gadget Technologies Pvt. Ltd."'
        }
    ]
}
```

与控制字段显示的`depends_on`属性类似，在版本13中我们为脚本报告过滤器引入了`depends_on`。这可用于根据`depends_on`中条件的值来决定过滤器是否可见。

## 完整示例

### 报告脚本（.py文件）

```python
from __future__ import unicode_literals
import frappe

def execute(filters=None):
    # 定义列
    columns = get_columns()
    
    # 获取数据
    data = get_data(filters)
    
    # 创建图表
    chart = get_chart(data)
    
    # 创建报告摘要
    report_summary = get_report_summary(data)
    
    return columns, data, None, chart, report_summary

def get_columns():
    return [
        {'fieldname': 'name', 'label': 'ID', 'fieldtype': 'Data', 'width': 100},
        {'fieldname': 'first_name', 'label': 'First Name', 'fieldtype': 'Data', 'width': 150},
        {'fieldname': 'last_name', 'label': 'Last Name', 'fieldtype': 'Data', 'width': 150},
        {'fieldname': 'email', 'label': 'Email', 'fieldtype': 'Data', 'width': 200}
    ]

def get_data(filters):
    # 根据过滤器获取数据
    conditions = ""
    if filters.get('company'):
        conditions += " AND company = %(company)s"
    
    return frappe.db.sql("""
        SELECT name, first_name, last_name, email 
        FROM `tabUser` 
        WHERE 1=1 {conditions}
    """.format(conditions=conditions), filters, as_dict=1)

def get_chart(data):
    if not data:
        return None
        
    chart = {
        'data': {
            'labels': [d['first_name'] for d in data],
            'datasets': [{'values': [1 for d in data]}]
        },
        'type': 'bar'
    }
    return chart

def get_report_summary(data):
    return [{
        'value': len(data),
        'label': 'Total Users',
        'datatype': 'Int'
    }]
```

### 过滤器配置（.js文件）

```javascript
frappe.query_reports['User Report'] = {
    filters: [
        {
            fieldname: 'company',
            label: __('Company'),
            fieldtype: 'Link',
            options: 'Company'
        }
    ]
};
```

## 专业提示

要直接导航到任何类型的报告，请在智能栏中输入其名称并按Enter。

## 版本历史

- **版本12**：新增自定义查询和脚本报告功能
- **版本13**：新增列和过滤器配置功能，支持`depends_on`属性

## 注意事项

1. 脚本报告功能强大但也复杂，建议在充分测试后部署到生产环境
2. 确保脚本的安全性，避免SQL注入等安全风险
3. 合理使用缓存机制提高报告性能
4. 遵循框架的编码规范和最佳实践