# 29.3 Bench Procfile

## 概述

Procfile是Frappe Bench在**开发模式**下用于管理多个进程的配置文件。它通过[Honcho](http://honcho.readthedocs.org)工具来启动、监控并协调Frappe系统所需的各种服务，包括Web服务器、Redis缓存、队列处理、定时任务等。

## 作用

使用Procfile可以：
- 统一管理多个后台进程
- 简化开发环境下的服务启动流程
- 支持实时重载和监控
- 避免手动逐个启动服务的繁琐

## 配置语法

Procfile是一个纯文本文件，通常位于项目根目录或`config`文件夹下。其基本语法格式为：

```
<进程名>: <启动命令>
```

- **进程名**：自定义标识符，用于区分不同进程（不能包含空格）
- **启动命令**：实际执行的shell命令或可执行文件路径

## 必需的进程列表

在Frappe系统中，Procfile通常需要配置以下核心进程：

| 进程名 | 作用 | 示例命令 |
|--------|------|----------|
| `redis_cache` | 通用缓存服务 | `redis-server config/redis_cache.conf` |
| `redis_queue` | 后台任务队列管理 | `redis-server config/redis_queue.conf` |
| `redis_socketio` | 实时消息代理（用于WebSocket通信） | `redis-server config/redis_socketio.conf` |
| `web` | Frappe Web服务器（通过`bench serve`启动） | `bench serve --port 8000` |
| `socketio` | 实时消息服务（Node.js Socket.IO服务器） | `/usr/bin/node apps/frappe/socketio.js` |
| `schedule` | 定时任务调度器 | `bench schedule` |
| `worker_short` | 处理高优先级队列的后台工作者 | `bench worker --queue short` |
| `worker_long` | 处理耗时任务的后台工作者 | `bench worker --queue long` |
| `worker_default` | 处理默认队列的后台工作者 | `bench worker --queue default` |

## 可选进程（用于开发）

- **`watch`**：自动监听文件变化并重新构建前端资源（适用于开发阶段）
  ```
  watch: bench watch
  ```

## 完整示例

以下是Frappe Bench Procfile的一个典型示例：

```yaml
redis_cache: redis-server config/redis_cache.conf
redis_socketio: redis-server config/redis_socketio.conf
redis_queue: redis-server config/redis_queue.conf
web: bench serve --port 8000
socketio: /usr/bin/node apps/frappe/socketio.js
watch: bench watch
schedule: bench schedule
worker_short: bench worker --queue short
worker_long: bench worker --queue long
worker_default: bench worker --queue default
```

## 如何使用Procfile

### 1. 安装Honcho

```bash
pip install honcho
```

### 2. 启动所有服务

在包含Procfile的目录下执行：

```bash
honcho start
```

### 3. 启动特定进程

如需仅启动特定进程（如只启动Web和Redis）：

```bash
honcho start web redis_cache redis_queue
```

### 4. 在Bench中使用

也可以直接使用Bench命令启动：

```bash
bench start
```

## 最佳实践

### 1. 按需启停进程

在开发环境中，如果某些服务暂时不需要（如`worker_long`），可以注释掉对应行，以节省系统资源：

```yaml
# worker_long: bench worker --queue long
```

### 2. 自定义端口

如果默认端口（如8000）被占用，可以通过`--port`参数修改Web服务端口：

```yaml
web: bench serve --port 9000
```

### 3. 多队列工作者配置

根据业务负载，可以配置多个工作者处理不同优先级的队列（如`short`、`default`、`long`），避免任务阻塞。

### 4. 资源隔离

使用不同的Redis实例分别处理缓存、队列和实时消息，避免资源竞争。

### 5. 日志管理

使用Honcho启动时，所有进程的日志会合并输出。如需单独查看某个进程的日志，可使用：

```bash
honcho start <进程名>
```

## 生产环境注意事项

**Procfile主要用于开发环境**。在生产环境中，建议使用系统级进程管理工具（如**systemd**或**Supervisor**）来确保服务的高可用性。

### 生产环境替代方案

- **systemd**：系统级的服务管理
- **Supervisor**：专业的进程监控工具
- **Docker/Docker Compose**：容器化部署

## 常见问题与解决方法

### 1. 端口冲突

如果Web服务端口被占用，修改Procfile中的端口设置：

```yaml
web: bench serve --port 8080
```

### 2. Redis服务启动失败

确保Redis已正确安装，并且配置文件路径正确：

```bash
# 检查Redis是否运行
redis-cli ping

# 检查配置文件是否存在
ls config/redis_*.conf
```

### 3. Node.js路径问题

如果Node.js路径不正确，修改为系统实际的Node.js路径：

```yaml
socketio: /usr/local/bin/node apps/frappe/socketio.js
```

## 总结

Procfile是Frappe开发环境中重要的进程管理工具，通过统一的配置文件简化了多个服务的启动和管理。合理配置Procfile可以提高开发效率，但需要注意生产环境应该使用更专业的进程管理方案。