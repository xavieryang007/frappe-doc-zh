# 32.2 UI测试

## Frappe框架UI测试指南

### 概述
Frappe框架使用**Cypress**进行UI测试，这是一个基于Node.js的全栈测试框架，不依赖Selenium。

### 测试文件位置
UI测试文件应放在项目的 `cypress/integration` 目录下，文件后缀为 `.js`。

### 示例代码：创建待办事项测试

```javascript
context('ToDo', () => {
  before(() => {
    cy.login('Administrator', 'admin');
    cy.visit('/desk');
  });

  it('creates a new todo', () => {
    cy.visit('/app/todo/new-todo-1');
    cy.fill_field('description', 'this is a test todo', 'Text Editor').blur();
    cy.get('.page-title').should('contain', 'Not Saved');
    cy.get('.primary-action').click();
    cy.visit('/desk#List/ToDo');
    cy.location('hash').should('eq', '/app/todo');
    cy.get('.list-row').should('contain', 'this is a test todo');
  });
});
```

### 运行UI测试

#### 本地运行命令：
```bash
# 启动Cypress交互界面
bench --site [站点名] run-ui-tests [应用名]

# 无头模式运行（不打开浏览器界面）
bench --site [站点名] run-ui-tests [应用名] --headless

# 并行测试（提升测试速度）
bench --site [站点名] run-ui-tests [应用名] --parallel
```

### 代码覆盖率

Frappe支持通过**Istanbul**工具和**Cypress代码覆盖率插件**收集测试覆盖率。

#### 生成覆盖率报告的步骤：

1. **代码插桩**：使用 `nyc instrument` 对源代码进行插桩
```bash
npx nyc instrument -x 'frappe/public/dist/**' -x 'frappe/public/js/lib/**' -x '**/*.bundle.js' --compact=false --in-place frappe
```

2. **运行带覆盖率的测试**：
```bash
bench --site test_site run-ui-tests frappe --with-coverage
```

3. **生成报告**：
```bash
npx nyc report --reporter=text
```

### Testing Library查询

推荐使用**Testing Library**查询语法来编写更贴近用户操作的测试，提高测试的可维护性。

#### 常用查询示例：

- `findByRole('button', {name: 'Save'})`：查找名为"Save"的按钮
- `findByLabelText('Optimize')`：查找与标签"Optimize"关联的表单元素
- `findByPlaceholderText('Name')`：查找占位符为"Name"的输入框
- `findByText('example.json')`：查找文本内容为"example.json"的元素

### 关键命令汇总

| 功能 | 命令 |
|------|------|
| 运行UI测试 | `bench --site [site] run-ui-tests [app]` |
| 无头模式运行 | 添加 `--headless` |
| 并行测试 | 添加 `--parallel` |
| 带覆盖率测试 | 添加 `--with-coverage` |

### 最佳实践

1. **使用有意义的测试名称**：测试名称应清晰描述测试场景
2. **模拟真实用户行为**：测试应反映实际用户操作流程
3. **处理异步操作**：正确处理页面加载和API调用
4. **保持测试独立**：每个测试应有自己的测试数据
5. **使用数据属性**：为测试元素添加`data-testid`属性

### 相关资源

- [Cypress官方文档](https://docs.cypress.io)
- [Testing Library查询指南](https://testing-library.com/docs/queries/about)
- [Frappe UI测试指南](https://docs.frappe.io/framework/user/en/ui-testing)

---

*最后更新时间：2025-11-15*  
*来源：https://docs.frappe.io/framework/user/en/ui-testing*