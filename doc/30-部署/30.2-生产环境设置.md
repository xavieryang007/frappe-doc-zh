# 30.2 生产环境设置

## 概述

Bench 是用于管理基于 Frappe Framework 的站点部署的命令行工具。以下是将 Frappe 站点部署到生产环境的步骤。

## 安装 Bench

在生产服务器上使用简易安装脚本安装 Bench。请确保在脚本中传入 `--production` 标志。

```bash
sudo python install.py --production --user [frappe-user]
```

## 设置站点和应用程序

```bash
# 切换到 frappe-bench 目录
cd frappe-bench

# 创建新站点
bench new-site example.com

# 下载 Frappe 应用或自定义应用
bench get-app erpnext
bench get-app https://github.com/yourremote/yourapp.git

# 将应用安装到站点
bench --site example.com install-app erpnext yourapp
```

## 检查 Supervisor 状态

如果一切设置正确，执行 `supervisorctl status` 应显示 Frappe 相关进程在运行。

示例输出：
```bash
$ sudo supervisorctl status
frappe-bench-redis:frappe-bench-redis-cache RUNNING pid 6467, uptime 10 days, 8:12:09
frappe-bench-redis:frappe-bench-redis-queue RUNNING pid 6466, uptime 10 days, 8:12:09
frappe-bench-redis:frappe-bench-redis-socketio RUNNING pid 6468, uptime 10 days, 8:12:09
frappe-bench-web:frappe-bench-frappe-web RUNNING pid 8856, uptime 10 days, 4:32:18
frappe-bench-web:frappe-bench-node-socketio RUNNING pid 8858, uptime 10 days, 4:32:18
frappe-bench-workers:frappe-bench-frappe-default-worker-0 RUNNING pid 8823, uptime 10 days, 4:32:19
frappe-bench-workers:frappe-bench-frappe-long-worker-0 RUNNING pid 8824, uptime 10 days, 4:32:19
frappe-bench-workers:frappe-bench-frappe-schedule RUNNING pid 8822, uptime 10 days, 4:32:19
frappe-bench-workers:frappe-bench-frappe-short-worker-0 RUNNING pid 8825, uptime 10 days, 4:32:19
```

如果您的域名 `example.com` 已正确解析到服务器 IP 地址，站点应能通过该域名访问。

## 更新操作

要更新站点及依赖，可执行以下命令。该命令会更新所有应用（git pull）、在所有站点上运行补丁、构建 JS 和 CSS 资源，并重启 Supervisor。

```bash
# 更新所有内容
bench update

# 仅更新应用（git pull）
bench update --pull

# 仅运行补丁
bench update --patch

# 仅构建资源
bench update --build

# 更新 Bench（CLI 工具）
bench update --bench

# 更新 Python 包和 node_modules
bench update --requirements
```

## Redis 命名空间

命名空间有助于保护用户数据。多个 Bench 实例可以使用同一 Redis 实例，而无需担心命名冲突。您可以通过以下步骤在 Frappe 中启用 Redis 命名空间（目前 Frappe 支持在 Bench 级别为 Redis Queue 设置命名空间）。

使用 `bench create-rq-users` 命令创建 Redis 用户并配置 Frappe 使用相应凭证。

```bash
bench create-rq-users

# 可选参数
# --use-rq-auth 为所有 Bench 站点启用 Redis 认证
# --set-admin-password 设置默认用户 admin 的密码
```

该命令会在 Bench 的配置目录中生成一个 ACL 文件。请确保 `redis_queue.conf` 文件已配置为使用该 ACL 文件（如果尚未配置，可运行 `bench setup redis` 使用最新版 Bench CLI 进行配置）。

```
aclfile [frappe-bench-absolute-path]/config/redis_queue.acl
```

## 关键提示

- 确保域名（如 `example.com`）正确解析到服务器 IP
- 更新操作会自动处理代码拉取、数据库迁移、资源构建和进程重启
- 生产环境务必使用 `--production` 标志安装

## 总结

本文档详细介绍了 Frappe Framework 的生产环境部署流程，包括 Bench 安装、站点设置、应用安装、Supervisor 监控、更新操作以及 Redis 命名空间配置等关键步骤。