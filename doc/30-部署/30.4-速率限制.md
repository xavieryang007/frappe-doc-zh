# 30.4 速率限制

## 概述

Frappe 框架内置了对 HTTP 请求进行速率限制的支持。该功能基于固定时间窗口实现，限制的是在配置的时间窗口内所有 HTTP 请求消耗的总时间。窗口周期会根据站点时区定期重置。

**注意**：超过限制的请求将不会被处理，并返回 HTTP 429（请求过多）状态码。

## 启用速率限制

要在站点上启用速率限制，请在 `site_config.json` 文件中添加如下配置：

```json
{
  "rate_limit": {
    "limit": 600,
    "window": 3600
  }
}
```

| 参数   | 说明                                       | 单位   |
|--------|--------------------------------------------|--------|
| limit  | 在时间窗口内允许使用的最大时间量           | 秒     |
| window | 速率限制窗口的大小                         | 秒     |

## 响应头信息

每个 HTTP 请求的返回头都会包含当前的速率限制状态，例如：

```
HTTP/1.1 200 OK
X-RateLimit-Limit: 600000000
X-RateLimit-Remaining: 518060453
X-RateLimit-Reset: 3513
X-RateLimit-Used: 100560
```

当超过配置的限制时，会返回 HTTP 429 响应，并包含以下头部：

```
HTTP/1.1 429 TOO MANY REQUESTS
X-RateLimit-Limit: 600000000
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1242
Retry-After: 1242
```

| 响应头                  | 说明                                       | 单位       |
|-------------------------|--------------------------------------------|------------|
| Retry-After             | 当前速率限制窗口重置剩余时间               | 秒         |
| X-RateLimit-Limit       | 一个窗口内允许使用的总时间                 | 微秒       |
| X-RateLimit-Remaining   | 当前窗口内剩余可用时间                     | 微秒       |
| X-RateLimit-Reset       | 当前窗口重置剩余时间                       | 秒         |
| X-RateLimit-Used        | 当前请求处理所使用的时间                   | 微秒       |

## 工作原理

速率限制功能通过时间窗口机制有效控制站点资源使用，防止滥用。配置简单，且通过 HTTP 头实时反馈限制状态，便于监控和调试。

## 配置示例

以下是一个完整的速率限制配置示例：

```json
{
  "rate_limit": {
    "limit": 300,
    "window": 1800
  },
  "rate_limit_override": {
    "/api/method/login": {
      "limit": 5,
      "window": 60
    }
  }
}
```

## 最佳实践

1. **合理设置时间窗口**：根据业务需求设置合理的限制值和窗口大小
2. **监控限制状态**：通过响应头信息监控请求使用情况
3. **处理 429 错误**：在客户端实现重试逻辑，使用 Retry-After 头信息
4. **特定路径调整**：对登录、API 等关键路径单独设置限制

## 总结

Frappe 的速率限制功能提供了一个简单而有效的方式来保护服务器资源，防止恶意请求和滥用。通过合理的配置和监控，可以确保系统的稳定性和可用性。