# 30.1 数据库迁移

## 概述

在项目开发过程中，经常会出现与数据库模式相关的更改。同时，可能还需要对现有数据进行修补。Frappe 提供了迁移和修补系统工具来处理这些场景。

当您的应用中出现模式更改时，为了将现有站点的数据库迁移到新模式，应运行以下命令：

```bash
bench --site [站点名] migrate
```

## 模式更改

您可以编辑 DocType 来添加、删除或更改字段。保存 DocType 时，一个包含 DocType 数据的 JSON 文件会被添加到应用的源码树中。当您将应用添加到站点时，会使用此 JSON 文件安装 DocType（创建数据库表）。

> 进行模式更改时，必须启用开发者模式。

运行 `migrate` 时，所有应用都会迁移到其当前版本。首先，运行 "before_migrate" 钩子来同步用户权限。然后运行实际的修补程序，迁移各个应用。之后，同步以下组件：

- 数据库模式
- 后台作业
- 固定数据（[了解更多](/framework/user/en/python-api/hooks#fixtures)）
- 仪表板、桌面图标和网页
- 更新翻译
- 为所有路由重建搜索索引

特别是对于 DocType，我们会将每个 DocType JSON 的 MD5 哈希值与 DocType 数据库表中存储的哈希值进行比较。如果哈希值不匹配，则重新加载该 DocType。此技术称为校验和比较，您可以在[此处](https://www.computerworld.com/article/2819393/unix-tip--comparing-files-with-checksums.html)了解更多信息。最后，运行 "after_migrate" 钩子来完成迁移。您可以在 [bench-site-commands](bench/frappe-commands#site-commands) 中找到各个进程运行的命令。

> 注意：直到 `v13` 版本，DocType 是基于 JSON 文件中的修改时间戳进行同步的。这种方法容易出错，因此我们转向了更健壮的哈希比较方法。您可以在[此处](https://github.com/frappe/frappe/pull/14246#issuecomment-928942292)了解更多信息。

当您删除或重命名字段时，相应的数据库列不会从数据库表中删除，但它们不会在表单视图中显示。这样做是为了避免潜在的数据丢失情况，并允许您编写可能需要旧字段值的相关数据迁移（修补程序）。

> Frappe 不支持反向模式迁移。

## 数据迁移

在引入数据相关更改时，您可能需要运行一次性脚本来更改现有数据以满足新代码的预期。在 Frappe 中，我们将这些脚本称为**修补程序**。

### 编写修补程序

要编写修补程序，必须在 Python 脚本中编写 `execute` 方法，并将其添加到应用的 `patches.txt` 文件中。

建议在应用的修补程序包（目录）中创建一个带有修补编号和名称的文件，并将其添加到 `patches.txt` 中。Frappe 中遵循的目录结构如下：

```
frappe
└── patches
    └── v12_0
        └── my_awesome_patch.py
```

然后可以通过其点分路径将修补程序添加到 `patches.txt`：

```
frappe.patches.v12_0.my_awesome_patch
```

### 修补执行时的模式

`execute` 函数中可用的 DocType 元数据将是旧 JSON 的模式。这样您可以在编写迁移代码时假设仍拥有旧字段。修补程序运行后，新模式将应用于 DocType。

如果您希望在修补程序执行期间使用新模式，请使用 `reload_doc` 方法：

```python
import frappe

def execute():
    frappe.reload_doc(module_name, "doctype", doctype_name)
    # 您的修补代码在此处
```

### 模型同步后修补程序 [仅限 v14 / develop 分支]

通常，您的修补程序可能不需要在 DocType 模型与数据库同步之前访问数据库模式。在这种情况下，最好将修补程序放在 `patches.txt` 的 `[post_model_sync]` 部分。

`patches.txt` 支持类似 INI 的文件格式，其中两个部分指定修补程序应在何时运行 - 在 DocType 模式迁移之前或之后。模型同步后修补程序不需要重新加载任何 DocType，因为在执行它们之前所有 DocType 都已重新加载。以下是此类 patches.txt 文件的示例：

```
[pre_model_sync]
app.module.patch1
app.module.patch2

[post_model_sync]
app.module.patch3
app.module.patch4
```

### 一次性 Python 语句

您还可以使用以下语法在 `patches.txt` 中添加一次性 Python 语句：

```
frappe.patches.v12_0.my_awesome_patch
execute:frappe.delete_doc('Page', 'applications', ignore_missing=True)
```

### 修补程序执行顺序

修补程序按定义顺序运行。`patches.txt` 中的所有行必须唯一。如果修补程序之前已运行，则不会再次运行。如果要重新运行修补程序，请添加注释使其看起来像是新行。

例如：

```
frappe.patches.v12_0.my_awesome_patch #2019-09-08
```

## 总结

本文档详细介绍了 Frappe 框架中的数据库迁移机制，包括模式更改原理、数据迁移修补程序的编写和执行，以及相关的注意事项和最佳实践。