# 实时通信 (Realtime)

## 概述
Frappe框架内置了基于[socket.io](https://socket.io/)的实时事件API。由于socket.io需要Node.js服务器支持，Frappe在运行主Web服务器的同时，会并行启动一个Node.js进程来处理实时通信。

## 客户端API (JavaScript)

### `frappe.realtime.on`
用于在客户端（浏览器）监听实时事件。
```javascript
frappe.realtime.on('event_name', (data) => {
    console.log(data);
});
```

### `frappe.realtime.off`
停止监听已订阅的事件。
```javascript
frappe.realtime.off('event_name');
```

## 服务器端API (Python)

### `frappe.publish_realtime`
用于从服务器端发布实时事件。
```python
frappe.publish_realtime('event_name', data={'key': 'value'})
```

### `frappe.publish_progress`
此方法可用于在对话框中显示进度条。
```python
frappe.publish_progress(25, title='标题', description='描述信息')
```

## 自定义事件处理器
> **注意**：此功能仅在nightly（v16）版本中可用，且被视为实验性功能。

您可以通过在应用的`realtime`文件夹中创建`handlers.js`文件来实现自定义的实时事件处理器。

该文件需要导出一个函数，该函数用于在socket实例上设置事件处理器。例如，如果您正在开发一个名为"chat"的应用，文件内容可能如下所示：

```javascript
// bench/apps/chat/realtime/handlers.js

function chat_app_handlers(socket) {
    socket.on("hello_chat", () => {
        console.log("hello world!");
    });
}

module.exports = chat_app_handlers;
```

您可以使用客户端代码`frappe.realtime.emit("hello_chat")`来触发此事件。请注意，可能需要重启socket.io服务器才能使代码更改生效。请参考Socket.IO文档以了解更多关于编写自定义事件处理器的信息：[https://socket.io/docs/v4/](https://socket.io/docs/v4/)

## 自定义客户端
如果您正在开发不使用Desk界面的单页面应用（SPA）或移动应用，可以编写自定义客户端来连接[socket.io](http://socket.io)服务器。您可以参考官方的[socket.io](http://socket.io)文档来构建自定义客户端：[https://socket.io/docs/v4/client-initialization/](https://socket.io/docs/v4/client-initialization/)

以下是自定义客户端的示例：
*   [Gameplan项目中的示例](https://github.com/frappe/gameplan/blob/9f9332cf29496afe5e912e4f1734fbf1142cb18c/frontend/src/socket.js#L13)
*   [Frappe框架内部的客户端封装](https://github.com/frappe/frappe/blob/8093a1d0a54900fe4b43b01ae6ffc0adf855da43/frappe/public/js/frappe/socketio_client.js#L49)

### 自定义客户端的身份验证
有两种方式可以对[socket.io](http://socket.io)服务器的连接进行身份验证：

1.  **Cookie**：如果您的自定义客户端运行在浏览器环境中，连接会自动发送Cookie，socket.io服务器可以使用这些Cookie进行身份验证。
2.  **Authorization头**：如果您的环境（如移动应用）不支持Cookie，您可以像API请求一样使用Authorization头。请参考REST API身份验证文档以了解详情：[REST API认证](https://frappeframework.com/docs/user/en/api/rest#authentication) 和 [socket.io额外请求头配置](https://socket.io/docs/v4/client-options/#extraheaders)。

## 实现说明
*   **实时服务器**：使用[socket.io](http://socket.io)服务器，该服务器用Node.js编写，位于Frappe项目的`/realtime`目录中。
*   **实时客户端**：是对[socket.io](http://socket.io)客户端库的封装，位于`public/js/frappe/socketio_client.js`。
*   **通信机制**：Python进程通过Redis的发布-订阅频道将事件发布到Node.js服务器。实时服务器订阅该Redis频道，并将事件发布给所有已订阅的客户端。
*   **多租户**：实时服务器支持多租户，所有与站点相关的流量都按站点名称进行命名空间隔离。命名空间动态创建，格式为`/{站点名称}`。
*   **权限控制**：实时服务器使用主Frappe Web服务器来验证连接。通过SID Cookie或Authorization头，确保连接来自有效用户，并能根据权限订阅特定的DocType或文档。
*   **房间（Rooms）**：实时实现允许以下房间：
    *   `all`：默认对所有系统用户开放和连接的房间。
    *   `website`：对所有用户（包括访客）开放和连接的房间。
    *   `user:{用户名}`：为每个用户创建的动态房间。无需权限检查即可允许加入。
    *   `doctype:{文档类型}`：为每个DocType创建的动态房间。只有拥有该DocType权限的用户才能加入。当用户打开文档的列表视图或表单视图时，会自动订阅此房间。
    *   `doc:{文档类型}/{文档名}`：为每个文档创建的动态房间。只有拥有该文档权限的用户才能加入。当用户打开文档的表单视图时，会自动订阅此房间。