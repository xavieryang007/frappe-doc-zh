# 后台任务 (Background Jobs)

## 概述
Frappe 框架内置了一套后台任务系统，使用 `schedule` 包和轮询机制实现。开发人员可以通过简单的 API 将任务放入队列异步执行。

---

## 核心方法

### 1. `frappe.enqueue`
将 Python 方法加入任务队列。

**语法**：
```python
frappe.enqueue(method, queue="default", timeout=None, is_async=True, now=False, 
               job_name=None, enqueue_after_commit=False, at_front=False, 
               track_job=False, **kwargs)
```

**参数说明**：
- `method`：要执行的 Python 函数或字符串形式的模块路径。
- `queue`：队列名称，默认为 `"default"`，可选值包括 `"short"`、`"default"`、`"long"`。
- `timeout`：任务超时时间（秒），默认使用队列预设值。
- `is_async`：是否为异步任务，默认为 `True`。
- `now`：是否立即执行（不通过 Worker），默认为 `False`。
- `job_name`：任务名称标识。
- `enqueue_after_commit`：是否在数据库事务提交后入队。
- `at_front`：是否将任务插入队列前端。
- `track_job`：是否在 `Background Task` 文档类型中记录任务元数据。
- `**kwargs`：传递给方法的参数。

**示例**：
```python
def long_running_job(param1, param2):
    # 执行耗时操作
    pass

# 直接传入函数
frappe.enqueue(long_running_job, queue='short', param1='A', param2='B')

# 或传入模块路径字符串
frappe.enqueue('app.module.folder.long_running_job', queue='short', param1='A', param2='B')
```

### 2. `frappe.enqueue_doc`
执行指定文档的控制器方法。

**语法**：
```python
frappe.enqueue_doc(doctype, name, method, queue="long", timeout=4000, **kwargs)
```

**示例**：
```python
frappe.enqueue_doc("Task", "TASK-001", "do_something", queue="long", param="value")
```

---

## 队列（Queue）配置

### 默认队列
框架预设三个队列及其超时时间：
- **short**：300 秒
- **default**：300 秒
- **long**：1500 秒

### 自定义队列
可在 `common_site_config.json` 中配置自定义队列：

```json
{
  "workers": {
    "myqueue": {
      "timeout": 5000,
      "background_workers": 4
    }
  }
}
```

---

## Worker 进程

### 默认 Worker 命令
```bash
bench worker --queue short
bench worker --queue default
bench worker --queue long
```

### 多队列消费
Worker 可同时监听多个队列：
```bash
bench worker --queue short,default
```

### 突发模式（Burst Mode）
处理完队列中所有任务后自动退出：
```bash
bench worker --queue short --burst
```

---

## 定时任务（Scheduler Events）

### 配置方式
在应用的 `hooks.py` 中定义 `scheduler_events`：

```python
scheduler_events = {
    "hourly": [
        "app.scheduled_tasks.update_database_usage"
    ],
    "daily_long": [
        "app.scheduled_tasks.take_backups_daily"
    ],
    "cron": {
        "0 2 * * *": [
            "app.scheduled_tasks.cleanup_logs"
        ]
    }
}
```

### 可用事件类型
- `hourly`、`daily`、`weekly`、`monthly`
- `hourly_long`、`daily_long`、`weekly_long`、`monthly_long`（适用于长任务）
- `all`：每 4 分钟触发（可通过 `scheduler_interval` 配置）
- `cron`：支持标准的 Cron 表达式

**注意**：修改 `hooks.py` 后需执行 `bench migrate` 使配置生效。

---

## 可配置的定时任务（Configurable Scheduler Events）

通过创建 `Scheduler Event` 和 `Scheduled Job Type` 文档实现动态调度：

```python
# 创建 Scheduler Event
sch_eve = frappe.new_doc("Scheduler Event")
sch_eve.scheduled_against = "Process Payment Reconciliation"
sch_eve.save()

# 创建 Scheduled Job Type
job = frappe.new_doc("Scheduled Job Type")
job.frequency = "Cron"
job.scheduler_event = sch_eve.name
job.cron_format = "0/5 * * * *"  # 每 5 分钟执行
job.save()
```

**注意**：定时任务默认以 **Administrator** 用户身份执行。

---

## 注意事项
- 使用后台任务时需确保 Worker 进程正常运行。
- 定时任务配置变更后需重启 Scheduler。
- 可通过 `Background Task` 文档类型查看任务执行状态（若启用 `track_job`）。

如果需要更详细的使用示例或配置说明，可参考 Frappe 官方文档或社区资源。