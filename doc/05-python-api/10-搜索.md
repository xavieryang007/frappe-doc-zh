# 搜索 (Search)

## 概述
Frappe框架的搜索功能由 **Search模块** 管理，该模块是对Python全文搜索库 **Whoosh** 的封装。用户可以通过扩展 `FullTextSearch` 类来创建针对特定需求的搜索类，例如 `WebsiteSearch` 就是用于索引公开网页并实现搜索的封装类。

---

## FullTextSearch类

每个 `FullTextSearch` (FTS) 实例都持有由其自身类定义的 **Schema（模式）**。这意味着不同的FTS实现可以拥有不同的索引结构。FTS类还提供了其他控制器方法，用于创建、更新和查询索引。

### 扩展FTS类

在初始化一个基于FTS的类时，需要提供 **索引名称(index_name)**。实例化时会自动初始化以下参数：
- `index_name`：提供的索引名称
- `index_path`：索引文件在站点目录(sites folder)中的路径
- `schema`：由 `get_schema` 函数返回的索引结构
- `id`：用于在索引中标识文档的唯一字段

实例化后，可以调用 `build` 函数构建索引。该函数会从 `get_items_to_index` 方法获取所有待索引的文档（文档应为 `frappe._dict` 列表，并符合定义的schema），然后将这些文档添加到索引中并写入文件。

可以使用FTS类的 `search` 方法对索引进行搜索。相关函数的详细API文档可参考：[FullTextSearch API参考](https://docs.frappe.io/framework/user/en/api/full-text-search)。

### 示例：博客文章搜索实现

以下是一个针对"Blog Post"文档类型实现全文搜索的示例类：

```python
class BlogWrapper(FullTextSearch):
    # 默认Schema（可自定义）
    # def get_schema(self):
    #     return Schema(name=ID(stored=True), content=TEXT(stored=True))

    # 定义文档唯一标识字段
    # def get_id(self):
    #     return "name"

    def get_items_to_index(self):
        """获取所有需要索引的博客文章"""
        docs = []
        for blog_name in get_all_blogs():  # 假设此函数返回所有博客名称列表
            docs.append(self.get_document_to_index(blog_name))
        return docs

    def get_document_to_index(self, name):
        """根据博客名称获取需要索引的文档内容"""
        blog = frappe.get_doc("Blog Post", name)
        return frappe._dict(name=name, content=blog.content)

    def parse_result(self, result):
        """解析搜索结果，返回需要展示的字段（例如文档名称）"""
        return result["name"]
```

**关键方法说明**：
- `get_items_to_index`：返回待索引的文档列表。
- `get_document_to_index`：根据单个标识（如名称）获取文档内容，构造为符合schema的字典。
- `parse_result`：用于解析每条搜索结果，决定返回给前端的数据格式。

---

## 其他相关功能
- **搜索更新**：当底层数据发生变化时，需要重新构建索引或增量更新索引。
- **多语言支持**：Whoosh支持词干分析、停用词过滤等，可配置用于不同语言的搜索优化。
- **性能调优**：对于大数据集，可调整Whoosh的索引参数（如异步写入、合并策略等）以提高搜索性能。

---

## 注意事项
- 搜索索引默认存储在站点目录下的 `indexes` 文件夹中，请确保有足够的磁盘空间和写入权限。
- 在生产环境中，建议定期重建索引或设置索引自动更新机制，以保持搜索结果的准确性。

如果需要更底层的Whoosh功能（如自定义分析器、评分算法等），可以直接在自定义的FTS类中访问Whoosh的API。

---

希望以上内容能帮助您全面了解Frappe框架的搜索功能。如有进一步疑问，可参考官方文档或Whoosh库文档。