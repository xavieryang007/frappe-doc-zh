# 语言解析 (Language Resolution)

## 概述
Frappe框架中的语言解析机制决定了用户会话所使用的语言。其解析顺序基于多个因素，优先级从高到低依次如下：

### 1. 表单参数（Form Dict）中的 `_lang` 参数
- 优先级最高。
- 通过URL参数（如 `?_lang=ru`）设置，会覆盖当前请求中的所有可翻译内容。
- 常用于邮件模板和打印视图等场景。

### 2. Cookie中的 `preferred_language` 键（仅对访客用户有效）
- 若未通过表单参数指定语言，则检查此Cookie。
- Frappe利用此机制实现网站语言切换器的持久化设置。
- **注意**：仅对未登录的访客用户生效，登录用户忽略此项。

### 3. 请求头中的 `Accept-Language`（仅对访客用户有效）
- 标准HTTP头部，用于指定客户端可接受的语言列表（按优先级排序）。
- 若前两项未设置，Frappe会解析此头部内容。
- 可参考 [MDN文档](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language) 了解更多细节。
- **注意**：仅对未登录的访客用户生效。

### 4. 用户文档（User Document）中的 `language` 字段
- 对已登录用户生效，设置后会在所有设备和客户端中持久化。
- 例如：用户在法语站点中设置语言为"俄语"，登录后界面将自动切换为俄语。

### 5. 系统设置（System Settings）中的 `language` 字段
- 优先级最低，作为整个站点的默认语言。
- 当以上所有方式均未指定语言时，使用此设置。

---

## 关键点总结
- 语言解析的最终值存储在 `frappe.lang` 变量中。
- 访客用户的语言由高优先级动态参数（如URL、Cookie、请求头）决定；登录用户则优先使用其账户设置。
- 系统设置提供全局后备语言，确保站点始终有可用的语言配置。

---

如需进一步了解具体实现或相关API，可参考Frappe官方文档中的 [Python API](https://docs.frappe.io/framework/user/en/python-api/language) 部分。