# 钩子 (Hooks)

## 一、什么是钩子（Hooks）？

钩子是Frappe框架提供的一种机制，允许开发者"挂接"到框架的核心功能或事件中，从而在不修改核心代码的情况下**扩展或覆盖**默认行为。  
所有钩子都在你的应用根目录下的 **hooks.py** 文件中定义。

> 钩子的解析遵循"后安装者优先"原则：最后安装的应用中定义的钩子会覆盖之前定义的钩子。

## 二、钩子基本用法示例

在 `hooks.py` 中定义简单钩子：

```python
test_string = "value"
test_list = ["value"]
test_dict = {
    "key": "value"
}
```

在Python控制台（`bench --site sitename console`）中获取钩子值：

```python
frappe.get_hooks("test_string")  # 返回 ["value"]
frappe.get_hooks("test_list")    # 返回 ["value"]
frappe.get_hooks("test_dict")    # 返回 {"key": ["value"]}
```

> 注意：`frappe.get_hooks` 始终返回列表形式的值，便于多应用合并。

## 三、常用钩子分类说明

### 1. 应用元数据
这些钩子在创建应用时自动生成，通常无需修改。

```python
app_name = "my_app"                 # 应用的内部名称（slug）
app_title = "My App"                # 显示名称
app_publisher = "Your Name"
app_description = "Description"
app_version = "1.0.0"
app_icon = "octicon octicon-file"   # 图标类
app_color = "grey"                  # 主题色
```

---

### 2. 静态资源（JS/CSS）

**（1）桌面端资源（Desk）**
```python
app_include_js = "assets/js/app.min.js"
app_include_css = "assets/css/app.min.css"
# 支持多文件
app_include_js = ["assets/js/app1.js", "assets/js/app2.js"]
```

**（2）门户端资源（Portal）**
```python
web_include_js = "assets/js/web.min.js"
web_include_css = "assets/css/web.min.css"
```

**（3）Web Form 资源**
```python
webform_include_js = {"ToDo": "public/js/todo_webform.js"}
webform_include_css = {"ToDo": "public/css/todo_webform.css"}
```

**（4）特定页面JS**
```python
page_js = {"background_jobs": "public/js/background_jobs.js"}
```

---

### 3. 安装与迁移钩子

```python
before_install = "app.setup.install.before_install"
after_install = "app.setup.install.after_install"
after_sync = "app.setup.install.after_sync"

before_migrate = "app.migrate.before_migrate"
after_migrate = "app.migrate.after_migrate"

before_uninstall = "app.setup.uninstall.before_uninstall"
after_uninstall = "app.setup.uninstall.after_uninstall"
```

> 对应的Python函数可在指定模块中实现，如 `app/setup/install.py`。

---

### 4. 文档事件（DocType Events）

监听指定DocType的CRUD事件：

```python
doc_events = {
    "*": {
        "after_insert": "app.utils.after_insert_all"
    },
    "ToDo": {
        "before_insert": "app.utils.before_insert_todo",
        "on_update": "app.utils.on_todo_update"
    }
}
```

---

### 5. 权限控制

**（1）查询条件限制**
```python
permission_query_conditions = {
    "ToDo": "app.permissions.todo_query"
}
```

**（2）文档权限验证**
```python
has_permission = {
    "ToDo": "app.permissions.todo_has_permission"
}
```

---

### 6. 计划任务（Scheduler）

```python
scheduler_events = {
    "daily": [
        "app.tasks.daily_cleanup"
    ],
    "hourly": [
        "app.tasks.hourly_backup"
    ],
    "cron": {
        "0 0 * * *": ["app.tasks.midnight_task"]
    }
}
```

> 修改后需运行 `bench migrate` 使计划任务生效。

---

### 7. 网站相关钩子

**（1）网站上下文**
```python
website_context = {
    "favicon": "/assets/app/images/favicon.png"
}
update_website_context = "app.website.update_context"
```

**（2）路由重定向**
```python
website_redirects = [
    {"source": "/old", "target": "/new"},
    {"source": "/blog/(.*)", "target": "/news/\\1"}
]
```

**（3）自定义404页面**
```python
website_catch_all = "not_found"
```

**（4）设置首页**
```python
homepage = "home"
role_home_page = {
    "Customer": "portal"
}
```

---

### 8. 邮件与文件钩子

**（1）邮件发送覆盖**
```python
override_email_send = "app.overrides.email.send_email"
get_sender_details = "app.overrides.email.get_sender_details"
```

**（2）文件处理**
```python
before_write_file = "app.overrides.file.before_write"
write_file = "app.overrides.file.write_file"
```

---

### 9. 用户数据保护（GDPR）

定义哪些DocType存储用户个人数据，便于执行"数据下载"或"删除"操作。

```python
user_data_fields = [
    {"doctype": "Contact", "filter_by": "email_id"},
    {"doctype": "Communication", "strict": True}
]
```

---

## 四、完整钩子列表参考

| 钩子名称 | 说明 |
|----------|------|
| `app_include_js` / `app_include_css` | 桌面端JS/CSS资源 |
| `web_include_js` / `web_include_css` | 门户端JS/CSS资源 |
| `doc_events` | 文档事件监听 |
| `scheduler_events` | 计划任务 |
| `permission_query_conditions` | 查询权限条件 |
| `has_permission` | 文档权限验证 |
| `website_context` | 网站上下文变量 |
| `website_redirects` | URL重定向规则 |
| `before_install` / `after_install` | 安装前后钩子 |
| `before_migrate` / `after_migrate` | 迁移前后钩子 |
| `fixtures` | 初始化数据同步 |
| `extend_bootinfo` | 扩展前端全局变量 |
| `override_whitelisted_methods` | 覆盖白名单方法 |
| `user_data_fields` | 用户数据保护字段 |

> 更多钩子请参考官方文档或源码中的 `hooks.py` 示例。

---

## 五、实战建议

1. **谨慎使用覆盖类钩子**（如 `override_whitelisted_methods`），避免多应用冲突。
2. **利用 `fixtures` 钩子**为你的DocType提供初始数据。
3. **通过 `extend_bootinfo`** 向前端传递全局配置。
4. **网站相关钩子**可用于定制门户页面的路由、缓存、权限等。

如果有具体的使用场景或问题，欢迎进一步提问！