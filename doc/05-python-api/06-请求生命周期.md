# 请求生命周期 (Request Lifecycle)

用户可通过不同URL（如 `/about`、`/posts` 或 `/api/resources`）访问Web应用。Frappe框架根据请求类型分别处理：

1. **API请求**：以 `/api` 开头的请求由REST API处理器处理。
2. **文件下载**：如备份文件（`/backups`）、公共文件（`/files`）和私有文件（`/private/files`）由专用处理器返回可下载文件。
3. **网页请求**：如 `/about`、`/posts` 等由网站路由器（website router）处理。

> 详细了解：[REST API](https://docs.frappe.io/framework/user/en/api/rest) | [静态文件处理](https://docs.frappe.io/framework/user/en/basics/static-assets)

---

## 请求预处理（Request Pre-processing）

在触发路由规则前，框架会进行预处理，包括请求初始化、记录器和速率限制器的设置。

---

## 路径解析器（Path Resolver）

请求从 `app.py` 进入网站路由器后，由路径解析器处理，执行以下操作：

### 1. 重定向解析（Redirect Resolution）
- 根据 [`website_redirects` 钩子](https://frappeframework.com/docs/v14/user/en/python-api/hooks#website-redirects)和网站设置中的重定向规则，解析请求路径是否需重定向。

### 2. 路由解析（Route Resolution）
- 若无重定向，则根据 [`website_routing_rules` 钩子](https://frappeframework.com/docs/v14/user/en/python-api/hooks#website-route-rules)和已启用 `has_web_view` 的DocType中设置的动态路由，解析最终端点。

### 3. 渲染器选择（Renderer Selection）
- 获取最终端点后，将其传递给所有可用的[页面渲染器](#页面渲染器page-renderer)，第一个返回 `can_render` 为 `True` 的渲染器将用于渲染该路径。

---

## 页面渲染器（Page Renderer）

页面渲染器负责根据端点渲染或返回页面，是一个Python类，需包含以下两个方法：
- `can_render`：检查是否能渲染指定路径。
- `render`：执行渲染并返回响应。

### 示例代码：
```python
from frappe.website.page_renderers.base_renderer import BaseRenderer

class PageRenderer(BaseRenderer):
    def can_render(self):
        return True

    def render(self):
        response_html = "Response"
        return self.build_response(response_html)
```

### 标准页面渲染器类型：

| 渲染器 | 说明 |
|--------|------|
| **StaticPage** | 从各应用的 `www` 文件夹提供PDF、图片等静态文件（非 `html`、`md`、`js`、`xml`、`css`、`txt`、`py` 类型）。建议将静态文件放入应用的 `public` 文件夹，由NGINX直接服务。 |
| **TemplatePage** | 在各应用的 `www` 文件夹中查找HTML或Markdown文件（如果是文件夹，则返回 `index.html` 或 `index.md`）。 |
| **WebformPage** | 渲染与路径匹配的Web表单。 |
| **DocumentPage** | 渲染DocType的文档模板（需在DocType的 `templates` 文件夹中提供与DocType同名的模板文件，如 `doctype/user/templates/user.html`）。 |
| **ListPage** | 渲染DocType的列表模板（参考 [Blog Post 模板](https://github.com/frappe/frappe/tree/develop/frappe/website/doctype/blog_post/templates)）。 |
| **PrintPage** | 渲染文档的打印视图，默认使用[标准打印格式](https://github.com/frappe/frappe/blob/develop/frappe/templates/print_formats/standard.html)，可通过 `default_print_format` 设置其他格式。 |
| **NotFoundPage** | 返回404状态码的"页面未找到"页。 |
| **NotPermittedPage** | 返回403状态码的"无权限访问"页。 |

---

## 添加自定义页面渲染器

若标准渲染器无法满足需求，可通过 `page_renderer` 钩子添加自定义渲染器：

```python
# 在自定义应用的 hooks.py 中
page_renderer = "path.to.your.custom_page_renderer.CustomPage"
```

自定义渲染器类需实现 `can_render` 和 `render` 方法，且**优先于标准渲染器**被调用。

### 示例代码：
```python
from frappe.website.utils import build_response
from frappe.website.page_renderers.base_renderer import BaseRenderer

class CustomPage(BaseRenderer):
    def can_render(self):
        return True

    def render(self):
        response_html = "Custom Response"
        return self.build_response(response_html)
```

> 提示：可继承标准渲染器以复用或覆盖其功能。

---

如果需要查看原始英文文档或具体代码示例，请访问 [Frappe框架官方文档](https://docs.frappe.io/framework/user/en/python-api/routing-and-rendering)。