# 实用函数 (Utility Functions)

Frappe框架提供了许多实用的工具函数，可以简化日期处理、数据验证、邮件发送等常见任务。

## 基本导入
```python
from frappe.utils import *
# 或导入特定函数
from frappe.utils import now, getdate, today, add_to_date
```

## 日期时间函数

### now()
返回当前日期时间，格式：yyyy-mm-dd hh:mm:ss
```python
now() # '2021-05-25 06:38:52.242515'
```

### getdate(string_date=None)
将字符串日期转换为datetime.date对象
```python
getdate() # datetime.date(2021, 5, 25)
getdate('2000-03-18') # datetime.date(2000, 3, 18)
```

### today()
返回当前日期，格式：yyyy-mm-dd
```python
today() # '2021-05-25'
```

### add_to_date(date, years=0, months=0, weeks=0, days=0, hours=0, minutes=0, seconds=0, as_string=False, as_datetime=False)
日期时间加减运算
```python
add_to_date(today(), days=10, as_string=True) # '2021-05-31'
add_to_date(now(), months=2) # datetime.datetime(2021, 7, 21, 15, 31, 18, 119999)
```

### date_diff(date_2, date_1)
计算两个日期之间的天数差
```python
date_diff('2021-05-31', '2021-05-21') # 10
```

### days_diff(date_2, date_1)
与date_diff功能相同，计算天数差
```python
days_diff('2021-05-31', '2021-05-21') # 10
```

### month_diff(date_2, date_1)
计算两个日期之间的月数差
```python
month_diff('2024-09-01', '2024-07-01') # 2
```

### pretty_date(iso_datetime)
将ISO时间转换为相对时间描述
```python
pretty_date(now()) # '刚刚'
# 其他输出示例：'1小时前', '20分钟前', '1周前', '5年前'
```

### format_duration(seconds, hide_days=False)
将秒数转换为持续时间格式
```python
format_duration(50) # '50秒'
format_duration(10000) # '2小时46分钟40秒'
format_duration(1000000) # '11天13小时46分钟40秒'
```

## 字符串处理函数

### comma_and(some_list, add_quotes=True)
将列表转换为逗号和"和"连接的字符串
```python
comma_and([1, 2, 3]) # "'1', '2' 和 '3'"
comma_and(['苹果', '球', '猫'], add_quotes=False) # '苹果, 球和猫'
```

### comma_or(some_list, add_quotes=True)
与comma_and类似，但使用"或"作为分隔符

### money_in_words(number, main_currency=None, fraction_currency=None)
将金额数字转换为中文大写
```python
money_in_words(900) # '人民币玖佰元整'
money_in_words(900.50) # '人民币玖佰元伍角整'
money_in_words(900.50, 'USD') # '美元玖佰元伍角整'
```

### get_abbr(string, max_len=2)
获取字符串的缩写
```python
get_abbr('Gavin') # 'G'
get_abbr('可口可乐公司') # '可'
get_abbr('张三李四王五', max_len=3) # '张三李'
```

### random_string(length)
生成指定长度的随机字符串
```python
random_string(40) # 'mcrLCrlvkUdkaOe8m5xMI8IwDB8lszwJsWtZFveQ'
random_string(6) # 'htrB4L'
```

### unique(seq)
去重并保持顺序
```python
unique([1, 2, 3, 1, 1, 1]) # [1, 2, 3]
unique('abcda') # ['a', 'b', 'c', 'd']
```

## 数据验证函数

### validate_json_string(string)
验证JSON字符串有效性
```python
try:
    validate_json_string('invalid json')
except frappe.ValidationError:
    print('不是有效的JSON字符串')
```

### validate_url(txt, throw=False, valid_schemes=None)
验证URL有效性
```python
validate_url('google') # False
validate_url('https://google.com') # True
```

### validate_email_address(email_str, throw=False)
验证和提取电子邮件地址
```python
validate_email_address('test@example.com') # 'test@example.com'
validate_email_address('文本, test@example.com, 更多文本') # 'test@example.com'
```

### validate_phone_number(phone_number, throw=False)
验证电话号码
```python
validate_phone_number('13800138000') # True
validate_phone_number('无效号码') # False
```

## 文件处理函数

### get_pdf(html, options=None, output=None)
从HTML生成PDF
```python
from frappe.utils.pdf import get_pdf

@frappe.whitelist(allow_guest=True)
def generate_invoice():
    html = '<h1>发票内容</h1>'
    frappe.local.response.filename = 'invoice.pdf'
    frappe.local.response.filecontent = get_pdf(html)
    frappe.local.response.type = 'pdf'
```

### filelock
文件锁，用于进程同步
```python
from frappe.utils.synchronization import filelock

def update_config(config, file):
    with filelock("config_name"):
        json.dump(config, file)
```

## 缓存和邮件函数

### frappe.cache()
获取Redis缓存连接
```python
cache = frappe.cache()
cache.set('name', 'frappe') # True
cache.get('name') # b'frappe'
```

### frappe.sendmail()
发送邮件
```python
frappe.sendmail(
    recipients=['test@example.com'],
    subject='测试邮件',
    message='邮件内容',
    template='email_template',
    args={'参数': '值'}
)
```

## 列表视图工具函数

### get_filtered_list_url(doctype, docnames=None)
生成过滤列表URL
```python
get_filtered_list_url("工作单", ["WO-001", "WO-002"])
# → 'http://<site>/app/work-order?name=["in",["WO-001","WO-002"]]'
```

### get_filtered_list_link(doctype, docnames=None, label=None)
生成过滤列表链接
```python
get_filtered_list_link("工作单", ["WO-001", "WO-002"])
# → '<a href="http://<site>/app/work-order?name=[...]">工作单</a>'
```

## 其他实用函数

- **cint()** - 转换为整数
- **cstr()** - 转换为字符串
- **flt()** - 转换为浮点数
- **rounded()** - 四舍五入
- **strip_html()** - 去除HTML标签
- **markdown()** - Markdown转HTML
- **get_site_info()** - 获取站点信息
- **get_host_name()** - 获取主机名
- **get_site_base_path()** - 获取站点基础路径

## 使用注意事项

1. 这些函数主要在Python环境中使用
2. 需要从`frappe.utils`模块导入
3. 日期函数会自动考虑时区设置
4. 验证函数提供了throw参数控制是否抛出异常
5. 邮件发送需要配置正确的邮件账户

这些实用函数可以大大简化Frappe应用开发中的常见任务处理。建议根据具体需求选择合适的函数使用。