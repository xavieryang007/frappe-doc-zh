# 响应 (Responses)

本文介绍Frappe框架中如何构建响应，以及如何在Frappe应用或脚本中使用它们。

## 概述

如果您已经阅读过[路由文档](https://docs.frappe.io/framework/user/en/python-api/routing-and-rendering)，可能已经注意到Frappe内部使用的 `build_response` 函数，该函数根据内容类型构建响应。相关逻辑位于 [frappe.utils.response](https://github.com/frappe/frappe/blob/develop/frappe/utils/response.py) 模块中，`build_response` 是其核心部分。

## `build_response` 函数实现

```python
def build_response(response_type=None):
    if "docs" in frappe.local.response and not frappe.local.response.docs:
        del frappe.local.response["docs"]

    response_type_map = {
        "csv": as_csv,
        "txt": as_txt,
        "download": as_raw,
        "json": as_json,
        "pdf": as_pdf,
        "page": as_page,
        "redirect": redirect,
        "binary": as_binary,
    }

    return response_type_map[frappe.response.get("type") or response_type]()
```

上述代码片段展示了 `build_response` 的当前实现，它将不同的响应类型映射到相应的处理函数。接下来，我们以Frappe v13中的 **"download"** 响应类型为例，深入分析其处理逻辑。

## "download" 响应处理函数 `as_raw`

```python
def as_raw():
    response = Response()
    response.mimetype = (
        frappe.response.get("content_type")
        or mimetypes.guess_type(frappe.response["filename"])[0]
        or "application/unknown"
    )
    response.headers["Content-Disposition"] = (
        f'{frappe.response.get("display_content_as", "attachment")};'
        f' filename="{frappe.response["filename"].replace(" ", "_")}"'
    ).encode("utf-8")
    response.data = frappe.response["filecontent"]
    return response
```

### 关键点说明：

- **Content-Disposition 头**：该头部的值会影响浏览器对响应的处理方式。
  - 如果未设置，默认值为 **"attachment"**。
  - 若 `frappe.response.display_content_as` 设置为 **"inline"**，表示内容应在浏览器内联显示（如网页或部分网页）。
  - 若设置为 **"attachment"**，则表示内容将被下载并保存到本地。

## 示例：创建下载文件的API端点

以下代码展示了如何创建一个API端点，用于直接下载文件：

```python
@frappe.whitelist()
def download(name):
    file = frappe.get_doc("File", name)
    frappe.response.filename = file.file_name
    frappe.response.filecontent = file.get_content()
    frappe.response.type = "download"
    frappe.response.display_content_as = "attachment"
```

### 说明：
- 使用 `@frappe.whitelist()` 装饰器允许外部访问。
- 通过 `frappe.get_doc` 获取文件文档。
- 设置 `frappe.response` 的相关属性：
  - `filename`：下载文件的名称。
  - `filecontent`：文件内容，通过 `file.get_content()` 获取。
  - `type`：设置为 "download" 以触发下载处理。
  - `display_content_as`：设置为 "attachment" 强制下载。

---

如需进一步了解其他响应类型（如CSV、JSON、PDF等）的处理方式，请参考Frappe官方文档或源码中的 `response_type_map` 部分。