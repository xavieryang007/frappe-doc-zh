# 10.15 将字段值从主文档提取到事务中

## 总体说明

在 Frappe 框架中，可以通过**自定义字段**的 **"Fetch From"（提取自）** 属性，实现从主文档（如"供应商"）自动提取字段值到事务文档（如"采购订单"）中。此功能适用于需要保持数据一致性或允许用户手动输入的场景。

---

## 使用场景与方法

### 场景一：字段值始终与主文档保持同步

- **适用情况**：希望事务文档中的字段值**每次保存时都自动更新**，与主文档最新值保持一致，且**不允许用户手动修改**。

- **实现步骤**：
  1. 在主文档（如"Supplier"）中创建自定义字段（如"GSTIN"），类型为"Data"。
  2. 在事务文档（如"Purchase Order"）中创建同名字段，但**字段类型设为"Read Only"**（或勾选"Read Only"复选框）。
  3. 在该字段的 **"Fetch From"** 属性中填写主文档的字段引用格式（如：`supplier.gstin`）。
  4. 保存后，在事务文档中选择主文档（如供应商），GSTIN 将自动填充并锁定为只读。

- **关键特性**：
  - 字段值**强制与主文档同步**，用户无法修改。
  - 适用于法定编号、税率等需严格一致的数据。

### 场景二：允许用户在主文档无值时手动输入

- **适用情况**：希望**首次创建事务文档时自动提取值**，但若主文档中无值，**允许用户手动输入**，且后续仅当字段为空时才重新提取。

- **实现步骤**：
  1. 在主文档（如"Supplier"）中创建自定义字段（如"GSTIN"），类型为"Data"。
  2. 在事务文档（如"Purchase Order"）中创建同名字段，类型为"Data"（非只读）。
  3. 在 **"Fetch From"** 属性中填写主文档字段引用（如：`supplier.gstin`），并**勾选"Fetch If Empty"**（仅当为空时提取）。
  4. 保存后，首次选择供应商时自动填充 GSTIN；若供应商无 GSTIN，用户可手动输入。

- **关键特性**：
  - 仅当字段**为空时触发提取**，用户可覆盖或补充数据。
  - 适用于可选或非强制性的辅助信息（如备注、次要联系方式）。

---

## 技术实现要点

- **"Fetch From"格式**：必须使用 `主文档表名.字段名` 的格式（例如：`supplier.gstin`）。

- **字段类型选择**：
  - 需强制同步时：事务文档字段设为 **"Read Only"**。
  - 需允许输入时：事务文档字段设为 **"Data"** 并勾选 **"Fetch If Empty"**。

- **系统刷新**：修改自定义字段后，需通过用户菜单中的 **"Reload"** 刷新页面生效。

---

## 使用场景对比摘要

| 场景 | 同步行为 | 是否允许用户输入 | 适用案例 |
|------|----------|------------------|----------|
| 场景一 | 每次保存时强制同步 | 否 | 税务编号、法定地址等 |
| 场景二 | 仅当字段为空时提取 | 是 | 可选备注、辅助信息 |

---

## 注意事项

- 确保主文档和事务文档的**字段名一致**（如都命名为"GSTIN"）。
- 若主文档字段值为空，事务文档中不会自动填充（场景二可手动输入）。
- 此功能适用于 Frappe 框架的标准事务流程（如销售订单、采购订单等）。

如果需要进一步了解如何在特定文档类型中配置，或处理更复杂的提取逻辑（如条件提取），可参考 Frappe 官方文档的"自定义字段"与"控制器事件"部分。

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/fetch-custom-field-value-from-master-to-all-related-transactions