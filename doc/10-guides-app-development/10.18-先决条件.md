# 10.18 先决条件

本文档详细介绍了在Frappe框架中配置OAuth客户端和认证流程的技术要求，为后续的社交登录功能提供基础支持。

## OAuth客户端配置与认证要求

### 1. 配置社交登录提供商信息

在Frappe框架中，需要在 `SocialLoginKey.get_social_login_provider` 方法中添加你的OAuth提供商配置，例如：

```python
providers["Frappe"] = {
    "provider_name": "Frappe",
    "enable_social_login": 1,
    "custom_base_url": 1,
    "icon": "/assets/frappe/images/favicon.png",
    "redirect_url": "/api/method/frappe.www.login.login_via_frappe",
    "api_endpoint": "/api/method/frappe.integrations.oauth2.openid_profile",
    "api_endpoint_args": None,
    "authorize_url": "/api/method/frappe.integrations.oauth2.authorize",
    "access_token_url": "/api/method/frappe.integrations.oauth2.get_token",
    "auth_url_data": json.dumps({
        "response_type": "code",
        "scope": "openid"
    })
}
```

### 2. 在"Social Login Key"文档类型中注册提供商

在 `Social Login Key` 文档类型的 `social_login_provider` 字段选项中，必须**精确匹配**提供商名称（如 `Frappe`），确保大小写一致。

### 3. OAuth 2.0 + OpenID Connect 认证流程

Frappe支持两种用户信息获取方式：

#### A. 通过OpenID Profile端点获取用户信息

**示例代码**：
```python
@frappe.whitelist(allow_guest=True)
def login_via_frappe(code, state):
    login_via_oauth2("frappe", code, state, decoder=json.loads)
```

#### B. 通过id_token获取用户信息

适用于如Office 365等支持OpenID Connect的提供商：

**示例代码**：
```python
@frappe.whitelist(allow_guest=True)
def login_via_office365(code, state):
    login_via_oauth2_id_token("office_365", code, state, decoder=json.loads)
```

### 4. 认证端点与回调要求

- 必须配置有效的 `redirect_url`，用于接收授权码（Authorization Code）。
- 确保在 `frappe.integrations.oauth2_logins` 模块中注册并允许Guest访问的登录方法（如 `login_via_office365`）。

## 关键注意事项

- **所有OAuth相关的方法**必须使用 `@frappe.whitelist(allow_guest=True)` 装饰器，以允许未认证用户访问。
- **授权流程**遵循标准OAuth 2.0授权码模式（Authorization Code Flow），需正确配置 `authorize_url`、`access_token_url` 和 `scope`。
- **提供商标识**必须与注册的提供商名称完全匹配，包括大小写。

## 配置验证步骤

1. **验证提供商配置**：确保在 `SocialLoginKey.get_social_login_provider` 方法中正确添加了提供商信息。
2. **测试回调URL**：验证 `redirect_url` 是否正确配置并可访问。
3. **检查权限设置**：确保相关方法已正确设置为允许访客访问。
4. **测试OAuth流程**：通过实际授权流程测试认证是否正常工作。

## 故障排除

- **认证失败**：检查提供商标识是否匹配，回调URL是否正确。
- **权限错误**：确认相关方法已添加 `@frappe.whitelist(allow_guest=True)` 装饰器。
- **配置错误**：验证OAuth端点URL和参数配置是否正确。

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/generic-oauth-client