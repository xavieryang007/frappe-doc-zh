# 10.8 通过自定义脚本覆盖链接查询

## 概述

在 Frappe 框架中，您可以使用 Client Script（客户端脚本）中的 `set_query` 方法来自定义（覆盖）标准链接查询的行为。这允许您为链接字段（Link Field）添加自定义过滤条件，或调用服务器端方法来动态生成查询结果。

---

## 1. 基本语法

`set_query` 方法有两种形式：

- **普通字段**：`frm.set_query(field_name, options_function)`
- **子表格字段**：`frm.set_query(field_name, child_table_name, options_function)`

---

## 2. 添加过滤器（Filters）

### 示例 1：简单过滤条件

```javascript
frappe.ui.form.on("Bank Reconciliation", "onload", function(frm) {
  frm.set_query("bank_account", function() {
    return {
      "filters": {
        "account_type": "Bank",
        "group_or_ledger": "Ledger"
      }
    };
  });
});
```

### 示例 2：复杂过滤条件（使用数组）

```javascript
frappe.ui.form.on("Bank Reconciliation", "onload", function(frm){
  frm.set_query("bank_account", function(){
    return {
      "filters": [
        ["Bank Account", "account_type", "=", "Bank"],
        ["Bank Account", "group_or_ledger", "!=", "Group"]
      ]
    }
  });
});
```

---

## 3. 调用自定义服务器方法

如果您需要更复杂的查询逻辑，可以指定一个服务器端 Python 方法来生成查询结果。

### 客户端调用示例

```javascript
frm.set_query("item_code", "items", function() {
  return {
    query: "erpnext.controllers.queries.item_query",
    filters: frm.doc.enquiry_type === "Maintenance" ? 
      {"is_service_item": "Yes"} : {"is_sales_item": "Yes"}
  };
});
```

### 自定义服务器方法示例

在 Python 端，您需要定义一个被 `@frappe.whitelist()` 和 `@frappe.validate_and_sanitize_search_inputs` 装饰的方法。

```python
import frappe
from frappe.model.db_query import get_match_cond

@frappe.whitelist()
@frappe.validate_and_sanitize_search_inputs
def lead_query(doctype, txt, searchfield, start, page_len, filters):
    return frappe.db.sql("""
        SELECT name, lead_name, company_name
        FROM `tabLead`
        WHERE docstatus < 2
          AND ifnull(status, '') != 'Converted'
          AND ({key} LIKE %(txt)s
            OR lead_name LIKE %(txt)s
            OR company_name LIKE %(txt)s)
        {mcond}
        ORDER BY
          IF(LOCATE(%(_txt)s, name), LOCATE(%(_txt)s, name), 99999),
          IF(LOCATE(%(_txt)s, lead_name), LOCATE(%(_txt)s, lead_name), 99999),
          IF(LOCATE(%(_txt)s, company_name), LOCATE(%(_txt)s, company_name), 99999),
          name, lead_name
        LIMIT %(start)s, %(page_len)s
    """.format(
        key=searchfield,
        mcond=get_match_cond(doctype)
    ), {
        'txt': "%{}%".format(txt),
        '_txt': txt.replace("%", ""),
        'start': start,
        'page_len': page_len
    })
```

**参数说明**：
- `doctype`：要查询的文档类型
- `txt`：用户输入的搜索文本
- `searchfield`：默认搜索字段
- `start`：分页起始位置
- `page_len`：每页结果数量
- `filters`：客户端传递的过滤条件

---

## 4. 注意事项

1. **安全性**：务必使用 `@frappe.validate_and_sanitize_search_inputs` 装饰器来防止 SQL 注入攻击。
2. **性能**：复杂的查询可能影响性能，建议添加适当的索引。
3. **更多示例**：可以参考 ERPNext 源码中的 `erpnext/controllers/queries.py` 文件。

---

## 总结

通过 `set_query` 方法，您可以：
- 为链接字段添加静态或动态过滤条件
- 调用自定义服务器端查询方法
- 实现复杂的业务逻辑过滤

这种方法非常灵活，可以满足大多数自定义查询需求。如果您需要更高级的功能，还可以结合 Frappe 的 REST API 或其他钩子机制。

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/overriding-link-query-by-custom-script