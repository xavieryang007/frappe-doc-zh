# 10.19 添加社交登录提供商

本文档说明如何通过修改代码为Frappe添加新的社交登录提供商，涵盖了支持的提供商和配置方法。

## 概述

通过修改代码（如提交Pull Request）为Frappe添加新的社交登录提供商，需要完成以下关键步骤。

## 1. 在 `SocialLoginKey.get_social_login_provider` 中添加提供商配置

需要在 `get_social_login_provider` 方法中的 `providers` 字典里添加新提供商的配置信息。

**示例（以"Frappe"为例）**：

```python
providers["Frappe"] = {
    "provider_name": "Frappe",
    "enable_social_login": 1,
    "custom_base_url": 1,
    "icon": "/assets/frappe/images/favicon.png",
    "redirect_url": "/api/method/frappe.www.login.login_via_frappe",
    "api_endpoint": "/api/method/frappe.integrations.oauth2.openid_profile",
    "api_endpoint_args": None,
    "authorize_url": "/api/method/frappe.integrations.oauth2.authorize",
    "access_token_url": "/api/method/frappe.integrations.oauth2.get_token",
    "auth_url_data": json.dumps({
        "response_type": "code",
        "scope": "openid"
    })
}
```

## 2. 在 `Social Login Key` 的DocType中更新选项

将提供商名称（如 `"Frappe"`）添加到 `Social Login Key` DocType的 `social_login_provider` 字段选项中，确保大小写一致。

## 3. 实现OAuth 2.0回调方法

用户启用该社交登录后，授权码会通过提供商API服务器返回到指定的 `redirect_url`。需要在 `frappe.integrations.oauth2_logins` 中创建一个允许访客访问的免认证方法。

Frappe支持两种常见的OAuth 2.0 + OpenID Connect实现方式：

### A. 通过OpenID Profile端点创建用户

**示例代码**：
```python
@frappe.whitelist(allow_guest=True)
def login_via_frappe(code, state):
    login_via_oauth2("frappe", code, state, decoder=json.loads)
```

### B. 通过id_token创建用户

**示例代码**：
```python
@frappe.whitelist(allow_guest=True)
def login_via_office365(code, state):
    login_via_oauth2_id_token("office_365", code, state, decoder=json.loads)
```

## 支持的提供商

从文档中提到的示例来看，Frappe框架自身已支持如**Frappe**、**Office 365**等作为社交登录提供商。您还可以参照相同方式配置其他符合OAuth 2.0或OpenID Connect标准的第三方登录服务（如Google、GitHub等）。

## 配置步骤概述

1. **修改代码**：在 `SocialLoginKey` 类中注册新的提供商信息。
2. **更新选项**：在 `Social Login Key` 文档类型中添加新提供商的选项。
3. **实现登录处理函数**：编写对应的OAuth回调方法，并确保它允许访客访问。
4. **启用登录方式**：在站点中创建 `Social Login Key` 记录，选择你添加的提供商并填写必要的客户端ID和密钥等信息。

## 详细实现说明

### 1. 提供商配置详解

**必要参数**：
- `provider_name`：提供商唯一标识符
- `enable_social_login`：是否启用社交登录
- `redirect_url`：OAuth回调URL
- `authorize_url`：授权端点URL
- `access_token_url`：令牌获取端点URL

**可选参数**：
- `icon`：提供商图标路径
- `custom_base_url`：是否使用自定义基础URL
- `scope`：OAuth授权范围

### 2. 回调方法实现

**基本回调结构**：
```python
@frappe.whitelist(allow_guest=True)
def login_via_provider(code, state):
    """
    处理提供商登录回调
    :param code: OAuth授权码
    :param state: 状态参数
    """
    try:
        # 处理登录逻辑
        user = login_via_oauth2("provider_name", code, state)
        return {"success": True, "user": user}
    except Exception as e:
        frappe.log_error(f"登录失败: {str(e)}")
        return {"success": False, "error": str(e)}
```

### 3. 前端集成

**JavaScript调用示例**：
```javascript
// 触发社交登录
function startSocialLogin(provider) {
    window.location.href = `/api/method/frappe.integrations.oauth2.authorize?provider=${provider}`;
}
```

## 测试和调试

### 1. 本地测试
1. 配置本地回调URL
2. 使用开发工具监控网络请求
3. 检查控制台错误信息

### 2. 生产环境验证
1. 验证HTTPS配置
2. 测试跨域请求
3. 确认回调URL可访问

## 常见问题

### 1. 回调URL配置错误
- 确保回调URL与提供商注册的一致
- 验证URL是否可公开访问

### 2. 权限问题
- 确认回调方法已添加 `@frappe.whitelist(allow_guest=True)`
- 检查提供商API权限配置

### 3. 状态参数处理
- 正确处理state参数防止CSRF攻击
- 实现安全的会话管理

## 最佳实践

1. **安全性**：使用HTTPS，验证state参数，处理错误情况
2. **用户体验**：提供清晰的错误提示，优化登录流程
3. **维护性**：遵循代码规范，添加详细注释

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/adding-social-login-provider