# 10.6 触发网格行删除事件

## 事件绑定方法

在Frappe中，要捕获子表格（Child Table）中行的删除事件，需要为特定的**字段名事件**绑定处理函数。事件名称遵循 `fieldname_remove` 的格式，其中 `fieldname` 是父DocType中定义的子表格字段名。

事件处理函数应绑定在**子DocType**的 `frappe.ui.form.on` 上，而不是父DocType。

## 触发时机

- **`fieldname_remove`**: 当用户点击子表格行中的"删除"按钮**并且该行已从表格中移除后**触发。
- **`fieldname_before_remove`**: 当用户点击"删除"按钮**但行尚未从表格中移除前**触发。这可以用于在删除前执行验证或逻辑。
- **`fieldname_add`**: 当用户点击"添加行"按钮**并且新行已添加到表格后**触发。
- **`fieldname_move`**: 当用户通过拖拽改变行的顺序后触发。

## 完整代码示例

假设我们有一个父DocType **`Item`**，它包含一个名为 **`color`** 的表格字段（Table Field），该字段链接到子DocType **`Item Color`**。

以下是如何为 `color` 表格的删除和添加事件编写处理程序的完整示例：

```javascript
// 1. 为父DocType 'Item' 绑定事件（可选，用于处理父表单本身的事件）
frappe.ui.form.on('Item', {
    // 这里可以放置针对 'Item' 主表单的客户端脚本
    refresh: function(frm) {
        // 例如：表单刷新时的逻辑
    }
});

// 2. 为子DocType 'Item Color' 绑定事件，以处理表格行的增删改事件
frappe.ui.form.on('Item Color', {
    // 当从 'color' 表格中删除一行后触发
    color_remove: function(frm) {
        // 你的逻辑代码写在这里
        // 此时，frm.doc.color 包含的是删除该行后剩余的行的数组
        console.log("一行已被删除。当前颜色列表：", frm.doc.color);
        frappe.show_alert({
            message: __("已删除一个颜色项。"),
            indicator: 'green'
        });
    },

    // 当在 'color' 表格中添加一行后触发
    color_add: function(frm) {
        // 你的逻辑代码写在这里
        console.log("新的一行已被添加。");
    },

    // 当从 'color' 表格中删除一行前触发（在移除操作发生之前）
    color_before_remove: function(frm, cdt, cdn) {
        // 你的逻辑代码写在这里，例如进行删除确认
        // cdt 和 cdn 是子行标识符
        let row = frappe.get_doc(cdt, cdn);
        // 示例：如果颜色是"红色"，则阻止删除
        if (row.color_name === "Red") {
            frappe.throw(__("不能删除红色！"));
        }
    },

    // 当 'color' 表格中的行被移动后触发
    color_move: function(frm) {
        // 你的逻辑代码写在这里
        console.log("行的顺序已被改变。");
    }
});
```

## 关键点总结

1. **事件绑定对象**：事件处理函数必须绑定在**子DocType**（例如 `'Item Color'`）上。
2. **事件命名规则**：事件名由**父DocType中表格字段的字段名** + 下划线 + 动作名（如 `remove`, `add`, `before_remove`, `move`）组成。
3. **执行上下文**：在处理函数内部，`frm` 参数指向**父表单**的实例，因此可以通过 `frm.doc.fieldname` 访问到操作后的当前子表数据。
4. **`before_remove` 的特殊性**：`fieldname_before_remove` 事件接收额外的参数 `cdt`（子DocType名称）和 `cdn`（子行名称），可用于获取即将被删除的行的具体数据，并有机会通过 `frappe.throw` 抛出异常来取消删除操作。

通过以上方式，您可以完整地捕获并处理子表格中行的删除以及其他相关事件。

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/trigger-event-on-deletion-of-grid-row