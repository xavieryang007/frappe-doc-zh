# 10.2 在文档类型事件上执行代码

## 概述

在Frappe框架中，您可以通过在DocType的控制器（Controller）中定义特定方法，来在文档生命周期的不同阶段执行自定义代码。这些方法会在特定事件（如插入、验证、更新、提交、取消、删除）发生时自动触发。

---

## 1. 控制器模块（Controller Module）

每个DocType都有一个对应的Python控制器类，位于该DocType所在模块的`doctype`文件夹下。例如，`ToDo` DocType的控制器位于`frappe/desk/doctype/todo/todo.py`。

创建DocType时，会自动生成一个控制器模板，基本结构如下：

```python
from __future__ import unicode_literals
import frappe
from frappe.model.document import Document

class CustomType(Document):
    pass
```

---

## 2. 文档属性（Document Properties）

在控制器类中，所有DocType的字段和子表都可以通过`self`属性访问。例如：

- `self.name`：文档名称
- `self.field_name`：特定字段的值

---

## 3. 事件类型、触发时机与代码示例

以下是DocType生命周期中可用的标准事件处理方法：

### **（1）autoname**

- **触发时机**：在文档命名时调用。
- **用途**：自定义文档的命名规则。
- **代码示例**：

```python
def autoname(self):
    # 基于某些字段生成名称
    self.name = f"{self.doctype}-{self.field_name}-{frappe.generate_hash()}"
```

### **（2）before_insert**

- **触发时机**：在文档插入数据库之前调用。
- **用途**：在插入前进行预处理或验证。
- **代码示例**：

```python
def before_insert(self):
    # 设置默认值或进行预处理
    if not self.custom_field:
        self.custom_field = "Default Value"
```

### **（3）validate**

- **触发时机**：在文档保存（插入或更新）之前调用。
- **用途**：进行数据验证，如果验证失败可以抛出异常阻止保存。
- **代码示例**：

```python
def validate(self):
    # 验证某个字段的值
    if self.amount < 0:
        frappe.throw("金额不能为负数！")
```

### **（4）on_update**

- **触发时机**：在文档成功插入或更新到数据库后调用。
- **用途**：保存后执行操作，如更新相关记录或发送通知。
- **代码示例**：

```python
def on_update(self):
    # 更新后记录日志或触发其他操作
    frappe.msgprint(f"文档 {self.name} 已更新")
```

### **（5）on_submit**

- **触发时机**：在文档提交后调用。
- **用途**：提交后的后续处理，如更新状态或触发工作流。
- **代码示例**：

```python
def on_submit(self):
    # 提交后更新相关文档状态
    related_doc = frappe.get_doc("Related DocType", self.related_doc)
    related_doc.status = "Submitted"
    related_doc.save()
```

### **（6）on_cancel**

- **触发时机**：在文档取消后调用。
- **用途**：取消后的清理操作，如恢复状态或撤销变更。
- **代码示例**：

```python
def on_cancel(self):
    # 取消后恢复相关文档状态
    related_doc = frappe.get_doc("Related DocType", self.related_doc)
    related_doc.status = "Cancelled"
    related_doc.save()
```

### **（7）on_trash**

- **触发时机**：在文档被删除后调用。
- **用途**：删除后的清理操作，如删除关联记录。
- **代码示例**：

```python
def on_trash(self):
    # 删除后清理关联数据
    frappe.db.sql("DELETE FROM `tabChild Table` WHERE parent=%s", self.name)
```

---

## 完整示例代码

以下是一个完整的DocType控制器示例，展示了多个事件方法的用法：

```python
from __future__ import unicode_literals
import frappe
from frappe.model.document import Document

class CustomInvoice(Document):
    def autoname(self):
        # 自定义命名规则：INV-年份-序号
        from frappe.utils import nowdate
        year = nowdate()[:4]
        self.name = f"INV-{year}-{frappe.generate_hash(length=4)}"
    
    def before_insert(self):
        # 设置默认日期
        if not self.invoice_date:
            self.invoice_date = frappe.utils.nowdate()
    
    def validate(self):
        # 验证金额必须为正数
        if self.total_amount <= 0:
            frappe.throw("发票金额必须大于0！")
        
        # 验证客户字段必须填写
        if not self.customer:
            frappe.throw("请选择客户！")
    
    def on_update(self):
        # 更新后记录操作日志
        frappe.logger().info(f"发票 {self.name} 已更新")
    
    def on_submit(self):
        # 提交后更新客户状态
        customer = frappe.get_doc("Customer", self.customer)
        customer.last_invoice_date = self.invoice_date
        customer.save()
        
        # 发送通知
        frappe.msgprint(f"发票 {self.name} 已成功提交！")
    
    def on_cancel(self):
        # 取消后重置状态
        self.status = "Cancelled"
        
        # 记录取消原因
        frappe.logger().info(f"发票 {self.name} 已被取消")
    
    def on_trash(self):
        # 删除关联的子表记录
        frappe.db.sql("DELETE FROM `tabInvoice Item` WHERE parent=%s", self.name)
```

---

## 关键注意事项

1. **异常处理**：在`validate`方法中，使用`frappe.throw()`可以阻止文档保存。
2. **数据库操作**：在事件方法中可以使用`frappe.db.sql()`执行SQL查询。
3. **文档操作**：使用`frappe.get_doc()`获取其他文档，并使用`save()`方法保存变更。
4. **日志记录**：使用`frappe.logger()`记录操作日志。

通过以上方法，您可以灵活地在DocType的生命周期各个阶段插入自定义业务逻辑，实现复杂的业务需求。

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/executing-code-on-doctype-events