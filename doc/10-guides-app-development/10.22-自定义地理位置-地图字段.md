# 10.22 自定义地理位置/地图字段

本文档详细介绍了如何在Frappe框架中自定义地理位置/地图字段，包括地图集成和自定义配置。

## 概述

Frappe框架中的"Geolocation"字段类型允许在DocType表单中嵌入交互式地图。默认情况下，地图显示为街道地图，中心位于孟买，但开发者可以通过多种方式自定义其外观和行为。

## 1. 自定义地图默认设置

这些更改会影响系统中的所有地图，并需要创建一个自定义应用（app）。

### 步骤

#### 1.1 创建自定义JavaScript文件
在自定义应用内创建文件：`[你的应用名]/public/js/map_defaults.js`。

#### 1.2 在 hooks.py 中引入该文件
编辑 `hooks.py`，将文件添加到 `app_include_js` 钩子中：

```python
app_include_js = [
    "/assets/[你的应用名]/js/map_defaults.js"
]
```

#### 1.3 配置地图默认参数
在 `map_defaults.js` 中，覆盖全局地图设置：

```javascript
const map_settings = frappe.provide("frappe.utils.map_defaults");

// 设置地图中心坐标（例如：德国中部）
map_settings.center = [51.57, 9.866];

// 设置默认缩放级别
map_settings.zoom = 6;

// 更换地图瓦片（例如：卫星地图）
map_settings.tiles = "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}";
map_settings.attribution = "Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community";
```

#### 1.4 重启Bench并刷新页面
更改生效后，所有地图将使用新的默认设置。

## 2. 自定义特定地图的渲染方式

通过重写Geolocation字段的控制器方法，可以针对特定DocType中的地图进行个性化渲染。

### 示例：将多边形显示为红色
在Client Script中或自定义应用的Hook中，添加以下代码：

```javascript
frappe.ui.form.on("你的DocType名", {
    setup(frm) {
        frm.fields_dict.你的地图字段名.on_each_feature = function(feature, layer) {
            if (feature.geometry.type === "Polygon") {
                layer.setStyle({ color: "red" });
            }
        };
    }
});
```

### 2.1 其他可自定义的方法

- **point_to_layer**：控制如何渲染点要素
- **set_style**：设置要素的默认样式
- **on_each_feature**：为每个要素添加事件监听器
- **filter**：过滤显示的要素

**完整示例**：

```javascript
frappe.ui.form.on("Property", {
    setup(frm) {
        const map_field = frm.fields_dict.location;
        
        // 自定义点要素渲染
        map_field.point_to_layer = function(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            });
        };
        
        // 自定义要素样式
        map_field.set_style = function(feature) {
            switch(feature.properties.type) {
                case 'residential':
                    return { color: 'green' };
                case 'commercial':
                    return { color: 'blue' };
                default:
                    return { color: 'gray' };
            }
        };
        
        // 为每个要素添加点击事件
        map_field.on_each_feature = function(feature, layer) {
            layer.bindPopup(`
                <strong>${feature.properties.name}</strong><br>
                Type: ${feature.properties.type}
            `);
            
            layer.on('click', function(e) {
                console.log('Feature clicked:', feature.properties);
            });
        };
        
        // 过滤要素显示
        map_field.filter = function(feature) {
            return feature.properties.visible === true;
        };
    }
});
```

## 3. 高级自定义功能

### 3.1 添加自定义控件
可以为地图添加自定义控件，如测量工具、图层切换等：

```javascript
frappe.ui.form.on("Property", {
    setup(frm) {
        const map_field = frm.fields_dict.location;
        
        map_field.on_map_loaded = function(map) {
            // 添加测量工具
            const measureControl = new L.Control.Measure({
                position: 'topright',
                primaryLengthUnit: 'meters',
                secondaryLengthUnit: 'kilometers',
                primaryAreaUnit: 'sqmeters',
                secondaryAreaUnit: 'hectares'
            });
            measureControl.addTo(map);
            
            // 添加图层切换
            const baseLayers = {
                "街道地图": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "卫星地图": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
            };
            
            L.control.layers(baseLayers).addTo(map);
        };
    }
});
```

### 3.2 集成外部地图服务
可以集成第三方地图服务，如Google Maps、Mapbox等：

```javascript
// 集成Mapbox
map_settings.tiles = 'https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=YOUR_MAPBOX_TOKEN';
map_settings.attribution = '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a>';

// 或集成Google Maps（需要额外配置）
map_settings.google_maps_api_key = 'YOUR_GOOGLE_MAPS_API_KEY';
```

### 3.3 自定义地理编码
可以重写默认的地理编码行为：

```javascript
frappe.ui.form.on("Address", {
    setup(frm) {
        const map_field = frm.fields_dict.geolocation;
        
        // 自定义地理编码函数
        map_field.geocode = function(address, callback) {
            // 使用自定义地理编码服务
            fetch(`https://api.custom-geocoder.com/search?q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        callback({
                            lat: result.latitude,
                            lng: result.longitude,
                            address: result.formatted_address
                        });
                    } else {
                        callback(null);
                    }
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    callback(null);
                });
        };
    }
});
```

## 4. 配置选项参考

### 4.1 地图设置选项

| 选项 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| `center` | Array | [19.0760, 72.8777] | 地图中心坐标 [纬度, 经度] |
| `zoom` | Number | 13 | 默认缩放级别 |
| `tiles` | String | OSM瓦片URL | 地图瓦片服务URL |
| `attribution` | String | OSM版权信息 | 地图版权信息 |
| `maxZoom` | Number | 18 | 最大缩放级别 |
| `minZoom` | Number | 1 | 最小缩放级别 |

### 4.2 样式设置选项

| 选项 | 类型 | 描述 |
|------|------|------|
| `color` | String | 要素边框颜色 |
| `weight` | Number | 边框宽度 |
| `opacity` | Number | 边框透明度 |
| `fillColor` | String | 填充颜色 |
| `fillOpacity` | Number | 填充透明度 |

## 5. 注意事项

- 以上自定义需在**开发者模式**下进行，或通过自定义应用实现。
- 更改全局默认设置会影响所有使用Geolocation字段的界面。
- 针对特定地图的自定义需确保DocType和字段名正确。
- 使用外部地图服务时，需要遵守相应的服务条款和API使用限制。

## 6. 故障排除

### 6.1 地图不显示
- 检查JavaScript文件是否正确引入
- 验证地图服务URL是否可访问
- 确认必要的API密钥已配置

### 6.2 自定义不生效
- 检查自定义代码语法是否正确
- 确认字段名和DocType名拼写正确
- 验证自定义代码是否在正确的事件中执行

### 6.3 性能问题
- 避免在地图中加载过多要素
- 使用适当的缩放级别和瓦片服务
- 考虑使用要素聚合显示大量数据

---

原始链接: https://docs.frappe.io/framework/user/en/customize-geolocation-map