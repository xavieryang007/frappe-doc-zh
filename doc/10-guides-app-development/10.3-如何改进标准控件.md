# 10.3 如何改进标准控件

## 核心思路

当需要为多个记录、多个DocType添加相似功能时，最有效的方法是**直接改进控件（Widget）本身**，而不是在每个地方重复编写代码。

## 具体步骤

### 1. **识别需要改进的控件**

- 控件是DocField的实例。
- 利用DocField的`options`字段来标记哪些字段需要应用新功能。

### 2. **标记目标字段**

- 在目标DocField的`options`属性中设置一个特定的标识词（例如："Translatable"）。
- 这样就能通过代码判断是否对该字段应用改进。

### 3. **扩展标准控件**

- 通过JavaScript扩展Frappe原有的控件类（例如`frappe.ui.form.ControlData`）。
- 重写其`make_input`方法，根据`options`判断是否应用新功能。

### 4. **添加新功能**

- 在控件中添加新的UI元素（如按钮）。
- 为新元素绑定事件处理逻辑（如打开翻译选择对话框）。

## 实践示例：为字段添加翻译功能

### 目标

为多个DocType中的多个字段快速添加"翻译"功能。

### 实现代码

```javascript
frappe.ui.form.ControlData = frappe.ui.form.ControlData.$extend({
    make_input: function() {
        var options = this.df.options;
        // 检查字段是否需要翻译功能
        if (!options || options !== "Translatable") {
            this._super(); // 调用原始方法
            return;
        }
        
        var me = this;
        // 创建包含输入框和按钮的新UI结构
        $('<div class="input-group">\
            <input type="text" class="form-control">\
            <span class="input-group-addon dialog-btn" style="display: none;">\
                <i class="fa fa-language"></i>\
            </span>\
        </div>').prependTo(this.input_area);
        
        // 获取UI元素引用
        this.$input_area = $(this.input_area);
        this.$input = this.$input_area.find('input');
        this.$btn = this.$input_area.find('.dialog-btn');
        
        // 设置输入框属性
        this.set_input_attributes();
        
        // 绑定事件：输入框聚焦时显示按钮
        this.$input.on("focus", function() {
            me.$btn.toggle(true);
        });
        
        // 输入框失焦时隐藏按钮
        this.$input.on("blur", function() {
            setTimeout(function() { me.$btn.toggle(false) }, 500);
        });
        
        this.input = this.$input.get(0);
        this.has_input = true;
        
        // 设置按钮功能
        this.setup_button();
    },
    
    setup_button: function() {
        var me = this;
        if (this.only_input) {
            this.$btn.remove();
            return;
        }
        
        // 按钮点击事件：打开翻译对话框
        this.$btn.on("click", function() {
            var value = me.get_value();
            var options = me.df.options;
            if (value && options && options === "Translatable") {
                me.open_dialog();
            }
        });
    },
    
    open_dialog: function() {
        if (this.frm && !this.frm.is_dirty()) {
            // 创建翻译选择器对话框
            new frappe.ui.form.TranslationSelector({
                doc: this.doc,
                df: this.df,
                text: this.value
            });
        }
    }
});
```

### 代码说明

1. **控件扩展**：通过`$extend`方法继承原有的`ControlData`控件
2. **条件判断**：检查字段的`options`是否为"Translatable"
3. **UI构建**：创建包含输入框和翻译按钮的界面
4. **事件处理**：
   - 输入框聚焦时显示翻译按钮
   - 点击按钮打开翻译对话框
5. **功能封装**：将翻译逻辑封装在独立的方法中

### 使用方式

1. 在需要翻译功能的DocField中设置`options = "Translatable"`
2. 该字段在表单中会自动显示翻译按钮
3. 用户点击按钮即可进行翻译操作

## 总结

这种改进方法的优势：

- **一次性开发**：只需修改控件一次，所有标记的字段自动获得新功能
- **维护简单**：功能逻辑集中，便于维护和更新
- **扩展性强**：可以轻松为其他类型的控件添加类似功能

这种方法特别适合需要为系统添加通用功能的场景，避免了重复劳动，提高了开发效率。

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/how-to-improve-a-standard-control