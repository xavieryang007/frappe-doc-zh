# 10.4 运行后台任务

本文档详细介绍了在Frappe框架中实现后台任务的技术方法，包括基本概念、配置方法和最佳实践。

## 1. 后台任务的基本概念

在Frappe框架中，后台任务用于处理耗时较长的操作，避免阻塞Web请求。Frappe使用**RQ（Redis Queue）**作为任务队列系统，依赖Redis作为中间件。

**关键组件**：
- **Redis**：必须安装并运行，用于存储任务队列。
- **RQ Worker**：执行队列中的任务。
- **Scheduler**：负责定时任务的调度。

## 2. 实现后台任务的方法

### 2.1 使用 `frappe.enqueue` 方法
这是最常用的方式，将函数调用加入任务队列。

```python
import frappe

def long_running_task(doc_name):
    # 执行耗时操作
    doc = frappe.get_doc("MyDoc", doc_name)
    doc.process()
    doc.save()

# 将任务加入队列
frappe.enqueue(long_running_task, doc_name="DOC-001")
```

**参数说明**：
- `method`：要执行的函数或方法。
- `queue`：指定队列名称（默认是 `default`）。
- `timeout`：任务超时时间（默认300秒）。
- `enqueue_after_commit`：是否在数据库提交后再加入队列（默认为False）。

### 2.2 使用 `@frappe.whitelist` 允许通过AJAX调用
如果任务需要通过前端触发，可以将函数设为白名单方法：

```python
@frappe.whitelist()
def start_background_job(doc_name):
    frappe.enqueue(long_running_task, doc_name=doc_name)
    return "任务已加入队列"
```

前端可通过 `frappe.call` 调用该方法。

## 3. 配置后台任务系统

### 3.1 启动RQ Worker
使用Bench命令启动工作进程：

```bash
bench --site [site-name] worker --queue default
```

**常用队列**：
- `default`：普通任务。
- `long`：耗时更长的任务。
- `short`：短时任务。

可通过 `bench setup redis` 确保Redis服务正常运行。

### 3.2 配置任务重试机制
在任务函数中，可以通过 `retry` 参数实现自动重试：

```python
from frappe.utils.background_jobs import enqueue

def task_with_retry():
    try:
        # 任务逻辑
        pass
    except Exception:
        # 重试逻辑
        frappe.enqueue(task_with_retry, retry=True, max_retries=3)
```

## 4. 定时任务（Scheduled Jobs）

使用**Scheduler**来定期执行后台任务。

### 4.1 在 `hooks.py` 中定义定时任务
```python
# hooks.py
scheduler_events = {
    "cron": {
        "* * * * *": [
            "my_app.tasks.daily_cleanup"
        ]
    },
    "daily": [
        "my_app.tasks.generate_daily_report"
    ]
}
```

**说明**：
- `cron`：使用Cron表达式定义执行频率。
- `daily`、`hourly`等：预设的时间间隔。

### 4.2 编写定时任务函数
```python
# my_app/tasks.py
def daily_cleanup():
    # 清理旧数据等操作
    frappe.db.sql("DELETE FROM `tabError Log` WHERE creation < DATE_SUB(NOW(), INTERVAL 7 DAY)")
```

## 5. 最佳实践

### 5.1 任务设计原则
- **任务要小而专一**：避免一个任务做太多事情，便于错误处理和重试。
- **设置合理的超时时间**：根据任务复杂度调整 `timeout`。
- **使用不同的队列**：将耗时任务分配到 `long` 队列，避免阻塞快速任务。

### 5.2 错误处理与日志
- 在任务中捕获异常并记录日志：
```python
def safe_task():
    try:
        # 任务逻辑
        pass
    except Exception as e:
        frappe.log_error(f"任务执行失败: {str(e)}")
```

### 5.3 监控任务状态
- 使用 `frappe.get_all("RQ Job")` 查看任务队列状态。
- 通过Bench命令 `bench --site [site-name] show-pending-jobs` 查看待处理任务。

## 6. 故障排查

### 6.1 常见问题
- **任务未执行**：检查Redis是否运行、Worker是否启动。
- **任务超时**：增加 `timeout` 参数或优化任务逻辑。
- **内存泄漏**：长时间运行的任务需注意资源释放。

### 6.2 日志查看
- 使用 `bench --site [site-name] logs --worker` 查看Worker日志。
- 任务错误日志可在 `Error Log` 中查看。

## 7. 相关文档链接
- [Frappe后台任务API文档](https://docs.frappe.io/framework/user/en/api/background_jobs)
- [RQ官方文档](https://python-rq.org/)

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/running-background-jobs