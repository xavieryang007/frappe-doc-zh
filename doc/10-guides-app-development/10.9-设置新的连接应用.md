# 10.9 设置新的连接应用

连接应用（Connected App）允许您的 Frappe 实例代表您访问其他支持 OAuth 2.0 的第三方服务（如 Google Mail）。以下为完整的配置流程：

## 1. 创建连接应用

- 在 Frappe 中新建一个 **Connected App**，为其命名（例如 "Google Mail Integration"）。
- 大多数 OAuth 2.0 服务提供商会公开一个发现端点（Discovery Endpoint），格式通常为：
  `https://[服务域名]/.well-known/openid-configuration`
  将该 URL 填入 "OpenID Configuration URL" 字段，并点击 **"Get OpenID Configuration"**。

> 如果不知道发现端点，可手动填写以下信息（需参考第三方服务的文档）：
> - **Authorization URI**：用户授权同意页面的地址。
> - **Token URI**：用于换取访问令牌（Access Token）的端点。

## 2. 保存并获取重定向 URI

- 保存 Connected App 后，系统会生成一个 **Redirect URI**（只读字段）。
  示例格式：`https://your-frappe-site.com/api/method/frappe.integrations.oauth2.authorize?client_id=your_client_id`
- **复制此 Redirect URI**，在第三方服务（如 Google Cloud Console）中注册 OAuth 2.0 客户端时，需将其设为 **授权重定向 URI**。

## 3. 配置第三方服务（以 Google 为例）

- 在 Google Cloud Console 中创建 OAuth 2.0 客户端，填写以下信息：
  - **授权 JavaScript 来源**：您的 Frappe 站点域名（如 `https://erp.example.com` 或本地开发环境 `http://localhost:8000`）。
  - **授权重定向 URI**：粘贴从 Frappe 复制的 Redirect URI。
- 完成后，从第三方服务获取 **Client ID** 和 **Client Secret**，并填入 Frappe 的 Connected App 对应字段。

## 4. 设置授权范围（Scopes）

- 根据集成需求，填写所需的 OAuth 范围（Scopes）。
  例如，访问 Gmail 需添加：`https://mail.google.com/`。
  具体范围请参考第三方服务的文档。

## 5. 配置额外参数（可选）

- 如需离线访问（如后台自动刷新令牌），可在 **Extra Parameters** 中添加参数。
  例如 Google 服务要求添加 `access_type=offline`，确保获取刷新令牌（Refresh Token）。

## 6. 连接测试

- 保存配置后，点击 Connected App 页面的 **"Connect to [服务名]"**。
- 系统将跳转至第三方服务的授权页面，用户同意后，重定向回 Frappe。
- Frappe 会自动通过 Token URI 换取访问令牌和刷新令牌，后续即可代表用户调用第三方 API。

---

## 关键注意事项

- **重定向 URI 必须完全匹配**，否则授权流程会失败。
- 确保第三方服务中配置的域名与 Frappe 站点地址一致（包含协议 http/https）。
- 如需长期后台访问，务必添加 `access_type=offline` 参数。

## 集成方法总结

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 创建 Connected App | 填写服务商提供的 OpenID 配置或手动输入端点 |
| 2 | 获取 Redirect URI | 在第三方服务中注册该 URI |
| 3 | 配置客户端凭证 | 将 Client ID 和 Secret 回填至 Frappe |
| 4 | 设置 Scopes 和参数 | 按需添加访问范围和额外参数 |
| 5 | 授权并连接 | 用户授权后，Frappe 自动管理令牌 |

---

原始链接: https://docs.frappe.io/framework/user/en/guides/app-development/connected-app